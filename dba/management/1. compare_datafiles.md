# Compare datafiles

> logical datafile과 physical datafile을 비교하여 출력

## snippet

### 0. sample

```sql
-- mkdir -p /oracle12/app/oracle/oradata/db1/another/
create tablespace test_for_another_path
         datafile '/oracle12/app/oracle/oradata/db1/another/test_for_another_path-01.dbf' size 1m,
                  '/oracle12/app/oracle/oradata/db1/another/test_for_another_path-02.dbf' size 1m,
                  '/oracle12/app/oracle/oradata/db1/another/test_for_another_path-03.dbf' size 1m;
                  
alter tablespace test_for_another_path drop datafile '/oracle12/app/oracle/oradata/db1/another/test_for_another_path-02.dbf';
rm /oracle12/app/oracle/oradata/db1/another/test_for_another_path-03.dbf
```

### 1. logical datafile, tempfile

```sql
select 'data' as type, file_name, file_id
  from dba_data_files
 union all
select 'temp' as type, file_name, file_id
  from dba_temp_files
 order by type, file_id;
```

### 2. physical datafile, tempfile

기반쿼리

```sql
select distinct substr(file_name, 1, instr(file_name, '/', -1) - 1) as datafile_directory
  from (select 'data' as type, file_name, file_id
          from dba_data_files
         union all
        select 'temp' as type, file_name, file_id
          from dba_temp_files
         order by type, file_id);
```

쿼리 실행 후 모든 실제물리파일 조회

```shell
#!/bin/sh

# TODO: sqlplus, logging query 함수로 생성
logfile="$(echo $0 | awk -F. '{print $1}').log"
tempfile="$(echo $0 | awk -F. '{print $1}').temp"
physical_list="$(echo $0 | awk -F. '{print $1}').physical_list"
logical_list="$(echo $0 | awk -F. '{print $1}').logical_list"

echo "logfile: $logfile"
echo "tempfile: $tempfile"
echo "physical_list: $physical_list"
echo "logical_list: $logical_list"

> $logfile
> $tempfile
> $physical_list
> $logical_list

query1="
select distinct substr(file_name, 1, instr(file_name, '/', -1) - 1) as datafile_directory
  from (select 'data' as type, file_name, file_id
          from dba_data_files
         union all
        select 'temp' as type, file_name, file_id
          from dba_temp_files
         order by type, file_id);
"
echo $query1 >> $logfile
result=$(sqlplus -S scott/oracle <<EOF
set head off
set feedback off
set pagesize 0
set linesize 1000
$query1
EOF
)

echo "$result" | tee $tempfile

while IFS= read -r distinct_directory;
do
	find $distinct_directory -maxdepth 1 -mindepth 1 -type f -name "*.dbf" >> $physical_list
done < $tempfile

echo "=== PHYSICAL_LIST"
cat $physical_list -n

query2="
select file_name
  from (select 'data' as type, file_name, file_id
          from dba_data_files
         union all
        select 'temp' as type, file_name, file_id
          from dba_temp_files
         order by type, file_id);
"
echo $query2 >> $logfile
result=$(sqlplus -S scott/oracle <<EOF
set head off
set feedback off
set pagesize 0
set linesize 1000
$query2
EOF
)

echo "$result" | tee $logical_list

echo "=== LOGICAL_LIST"
cat $logical_list -n

```



