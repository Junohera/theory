[toc]

# Trigger

## 1. íŠ¸ë¦¬ê±°ë¡œ ì œì•½

> ì•„ëž˜ì™€ ê°™ì´ ì£¼ë¬¸ ì •ë³´ë¥¼ ì €ìž¥í•˜ëŠ” í…Œì´ë¸”ì„ ìƒì„±í•œ í›„ ì£¼ë¬¸ ì •ë³´ê°€ ìž…ë ¥ë  ë•Œ
> í—ˆê°€ë˜ì§€ ì•Šì€ ì½”ë“œëŠ” ìž…ë ¥ë˜ì§€ ì•Šë„ë¡ íŠ¸ë¦¬ê±° ìž‘ì„±(ìž…ë ¥ ì œí•œ íŠ¸ë¦¬ê±°)
> ìž…ë ¥ ì½”ë“œëŠ” C100 ~ C110 ë²”ìœ„ì´ë©° C105ëŠ” ìž…ë ¥ ë¶ˆê°€

```sql
drop table o_order;
drop table o_order_log;
create table o_order
(no         number,
 ord_code   varchar2(10),
 ord_date   date,
 reason     varchar2(128));
create table o_order_log
as
select sysdate as processed,
       o.reason,
       o.no,
       o.ord_code,
       o.ord_date
  from o_order o
 where 1=2;
 
create or replace trigger trg_validate_o_order_order_code
before insert on o_order
for each row
declare
  code    o_order.ord_code%type;
  i       number;
begin
  code := :new.ord_code;
  i := cast(substr(code, 2) as number);
  
  if not ((i between 100 and 110) and i not in (105)) then
  	raise_application_error(-20400, 'bad request parameter');  
  end if;
  
  -- ðŸ’¥
  --insert into o_order_log
  --values(sysdate, :new.reason, :new.no, :new.ord_code, :new.ord_date);
  -- ðŸ’Š
  insert into o_order_log(processed, reason, no, ord_code, ord_date)
  values(sysdate, :new.reason, :new.no, :new.ord_code, :new.ord_date);
end;
/

insert into o_order values (1, 'C100', sysdate, 'SUCCESS CASE1');
insert into o_order values (1, 'C110', sysdate, 'SUCCESS CASE2');
insert into o_order values (1, 'C105', sysdate, 'FAILURE CASE1');
/*
TRY INSERT (C099,C105)	-> ON TRIGGER
												-> TRY INSERT TO LOG TABLE(BUFFER CACHE?)
												-> RAISE_APPLICATION_ERROR(WITH EXIT CODE)??
												-> ALL ROLLBACK??
*/
insert into o_order values (1, 'C099', sysdate, 'FAILURE CASE2');

/* Trigger transaction test
ë§Œì•½ ìœ„ íŠ¸ë¦¬ê±°ê°€ ìž…ë ¥í•˜ëŠ” ë¡œê·¸í…Œì´ë¸”ì— ì»¬ëŸ¼ì´ ì¶”ê°€ë  ê²½ìš°,
ë¡œê·¸ í…Œì´ë¸” insert ì—ëŸ¬ ë°œìƒ -> ì£¼ë¬¸ í…Œì´ë¸” insert ì—ëŸ¬

ðŸ’¥ ëŒ€ì‘í•˜ëŠ” ì»¬ëŸ¼ëª…ì„ ëª…ì‹œí•˜ì§€ ì•Šì„ ê²½ìš°, ì»¬ëŸ¼ ì¶”ê°€ì‹œ ë¶ˆì¶©ë¶„ ë°œìƒìœ¼ë¡œ ì—ëŸ¬ ë°œìƒ
    insert into o_order_log 
    values(sysdate, :new.reason, :new.no, :new.ord_code, :new.ord_date);
ðŸ’Š ëŒ€ì‘í•˜ëŠ” ì»¬ëŸ¼ëª…ì„ ëª…ì‹œí•  ê²½ìš°, nullable ì»¬ëŸ¼ ì¶”ê°€ì‹œ ì •ìƒ ìˆ˜í–‰
    insert into o_order_log(processed, reason, no, ord_code, ord_date)
    values(sysdate, :new.reason, :new.no, :new.ord_code, :new.ord_date);
*/
alter table o_order_log add imsi number;
insert into o_order values (1, 'C100', sysdate, 'FAILURE CASE3'); -- failure

select *
  from o_order;
select *
  from o_order_log;
rollback;
```

## 2. ìž…ë ¥ì‹œê°„ ì œí•œ

> ìœ„ í…Œì´ë¸”ì— ë°ì´í„°ë¥¼ ìž…ë ¥ í•  ë•Œ ìž…ë ¥ ì‹œê°„ì„ ì œí•œí•˜ê³ ìž í•œë‹¤
> ìž…ë ¥ ì‹œê°„ì´ 16ì‹œì—ì„œ 18ì‹œ ì‚¬ì´ì¸ ê²½ìš°ëŠ” ì—ëŸ¬ ë°œìƒ, ë‚˜ë¨¸ì§€ ì‹œê°„ì—ëŠ” ì •ìƒ ìž…ë ¥
> 16:00:00~17:59:59
>
> (í…ŒìŠ¤íŠ¸ í•  ë•ŒëŠ” ì‹œê°„ì„ ë°”ê¿”ê°€ë©´ì„œ í…ŒìŠ¤íŠ¸ ì§„í–‰..)

```sql
create or replace trigger trg_validate_o_order_time
before insert on o_order
for each row
declare
  hh char(2);
begin
  hh := to_char(:new.ord_date, 'HH24');
  
  if hh in ('16', '17') then
  --  raise_application_error(-20400, 'bad request parameter');
    raise_application_error(-20400, 'input time: '||hh);    
  end if;
end;
/
insert into o_order values (1, 'C100', to_timestamp(to_char(sysdate, 'YYYY-MM-DD')||' '||'15:00:00', 'YYYY-MM-DD HH24:MI:SS'));
insert into o_order values (1, 'C100', to_timestamp(to_char(sysdate, 'YYYY-MM-DD')||' '||'16:00:00', 'YYYY-MM-DD HH24:MI:SS'));
insert into o_order values (1, 'C100', to_timestamp(to_char(sysdate, 'YYYY-MM-DD')||' '||'17:00:00', 'YYYY-MM-DD HH24:MI:SS'));
insert into o_order values (1, 'C100', to_timestamp(to_char(sysdate, 'YYYY-MM-DD')||' '||'18:00:00', 'YYYY-MM-DD HH24:MI:SS'));
rollback;

select *
  from o_order;
```

## 3. í…Œì´ë¸”ê°„ ì—°ê³„ - ë„ì„œ ë°˜ë‚©ì‹œ ì—°ì²´ìš”ê¸ˆ ê³„ì‚°

```sql
ë„ì„œ ëŒ€ì—¬ í…Œì´ë¸”ì´ ìžˆë‹¤ê³  í•˜ìž. ë„ì„œë¥¼ ëŒ€ì¶œí• ë•Œ ê°’ì´ ìž…ë ¥ë˜ê³ 
ë°˜ë‚©ë ë•Œ ë°˜ë‚©ë‚ ì§œê°€ update ë˜ë©´ ìžë™ìœ¼ë¡œ ì—°ì²´ìš”ê¸ˆì´ ê³„ì‚°ë˜ë„ë¡ í•˜ëŠ” íŠ¸ë¦¬ê±°ë¥¼ ìž‘ì„±í•˜ë¼;

ëŒ€ì¶œ í…Œì´ë¸”
 - ëŒ€ì¶œë²ˆí˜¸
 - ê³ ê°ë²ˆí˜¸
 - ë„ì„œë²ˆí˜¸
 - ëŒ€ì¶œë‚ ì§œ
 - ë°˜ë‚©ë‚ ì§œ

ì—°ì²´ í…Œì´ë¸”
 - ëŒ€ì¶œë²ˆí˜¸
 - ì—°ì²´ìš”ê¸ˆ
```

ðŸ’¥ dml event trigger ìž‘ì„±ì‹œ trigger bodyì— event tableì— ëŒ€í•œ ì§ì ‘ì  ì–¸ê¸‰ ë¶ˆê°€(=ìž¬ê·€ ì°¸ì¡° ë°œìƒ ì—¬ì§€ ìžˆìœ¼ë¯€ë¡œ ë¶ˆê°€)
=> :old.column_name or :new.column_name í˜•íƒœë¡œ í•´ë‹¹ tableì— ëŒ€í•œ ë°ì´í„° ê°€ì ¸ì˜¬ ìˆ˜ ìžˆìŒ

#### 1. ì—°ì²´ ë¹„ìš©ì´ ë°œìƒí•˜ì§€ ì•Šì•„ë„ ì—°ì²´ ë°ì´í„° ì¡´ìž¬

```sql
drop table scott.rent purge;
drop table scott.delay purge;

create table scott.rent
(
    rent_no       varchar2(20) not null unique,
    book_no       varchar2(50) not null,
    member_no     varchar2(10) not null,
    rent_date     varchar2(15) default sysdate,
    return_date   varchar2(15)
);

create table scott.delay
(
    rent_no       varchar2(20) not null,
    total_days    number,                   -- ì´ ëŒ€ì—¬ì¼ìˆ˜
    delay_days    number,                   -- ì—°ì²´ì¼ìˆ˜
    delay_fare    number                    -- ì—°ì²´ë¹„ìš©
);

-- ëŒ€ì—¬ ë°œìƒì‹œ ì—°ì²´ í…Œì´ë¸”ì— ë°ì´í„° ìž…ë ¥ íŠ¸ë¦¬ê±° ìž‘ì„±
create or replace trigger trg_rent_after_rent
after insert on rent
for each row
  begin
    insert into delay (rent_no)
    values (:new.rent_no);
  end;
/
-- ë°˜ë‚© ë°œìƒì‹œ ì—°ì²´ í…Œì´ë¸”ì— ë°ì´í„° ìˆ˜ì • íŠ¸ë¦¬ê±° ìž‘ì„±
create or replace trigger trg_rent_after_return
after update of return_date on rent
for each row
  declare
    policy_day      number := 7;      -- ì •ì±…: í—ˆìš© ëŒ€ì—¬ ì¼ìˆ˜
    policy_fee      number := 100;    -- ì •ì±…: í•˜ë£¨ì—°ì²´ë¹„ìš©
    
    total_day       number;           -- ì´ ëŒ€ì—¬ ì¼ìˆ˜
    delay_day       number;           -- ì—°ì²´ ì¼ìˆ˜
  begin
    if :new.return_date is not null and :old.rent_date is not null then
      total_day := trunc(to_date(:new.return_date, 'YYYY/MM/DD') - to_date(:old.rent_date, 'YYYY/MM/DD'));
      
      delay_day := total_day - policy_day;
      update delay
         set total_days = total_day,
             delay_days = delay_day,
             delay_fare = delay_day * policy_fee
       where rent_no = :new.rent_no;
    end if;
  end;
/

insert into rent(rent_no, book_no, member_no, rent_date)
            values ('0001', 'B001', 'C001', '2023/08/01');
insert into rent(rent_no, book_no, member_no, rent_date)
            values ('0002', 'B009', 'C002', '2023/07/31');

update rent
   set return_date = '2023/08/08'
 where rent_no = '0001';
 
update rent
   set return_date = to_char(sysdate, 'YYYY/MM/DD')
 where rent_no = '0002';
 
select r.rent_no,
       r.book_no,
       r.member_no,
       r.rent_date,
       r.return_date,
       d.total_days,
       d.delay_days,
       d.delay_fare
  from rent r, delay d
 where r.rent_no = d.rent_no;
  
rollback;
```

```sql
RENT_NO|BOOK_NO|MEMBER_NO|RENT_DATE |RETURN_DATE|TOTAL_DAYS|DELAY_DAYS|DELAY_FARE|
-------+-------+---------+----------+-----------+----------+----------+----------+
0001   |B001   |C001     |2023/08/01|2023/08/08 |         7|         0|         0|
0002   |B009   |C002     |2023/07/31|2023/08/11 |        11|         4|       400|
```

#### 2. ì—°ì²´ ë¹„ìš©ì´ ë°œìƒí•  ê²½ìš°ì—ë§Œ ì—°ì²´ ë°ì´í„° ì¡´ìž¬

```sql
drop table scott.rent purge;
drop table scott.delay purge;

create table scott.rent
(
    rent_no       varchar2(20) not null unique,
    book_no       varchar2(50) not null,
    member_no     varchar2(10) not null,
    rent_date     varchar2(15) default sysdate,
    return_date   varchar2(15)
);

create table scott.delay
(
    rent_no       varchar2(20) not null,
    total_days    number,                   -- ì´ ëŒ€ì—¬ì¼ìˆ˜
    delay_days    number,                   -- ì—°ì²´ì¼ìˆ˜
    delay_fare    number                    -- ì—°ì²´ë¹„ìš©
);

-- ë°˜ë‚© ë°œìƒì‹œ ì—°ì²´ í…Œì´ë¸”ì— ë°ì´í„° ìž…ë ¥ íŠ¸ë¦¬ê±° ìž‘ì„±
create or replace trigger trg_rent_after_return
after update of return_date on rent
for each row
  declare
    policy_day      number := 7;      -- ì •ì±…: í—ˆìš© ëŒ€ì—¬ ì¼ìˆ˜
    policy_fee      number := 100;    -- ì •ì±…: í•˜ë£¨ì—°ì²´ë¹„ìš©
    
    total_day       number;           -- ì´ ëŒ€ì—¬ ì¼ìˆ˜
    delay_day       number;           -- ì—°ì²´ ì¼ìˆ˜
  begin
    if :new.return_date is not null and :old.rent_date is not null then
      total_day := trunc(to_date(:new.return_date, 'YYYY/MM/DD') - to_date(:old.rent_date, 'YYYY/MM/DD'));
      
      delay_day := total_day - policy_day;
      if delay_day > 0 then
        insert into delay(rent_no, total_days, delay_days, delay_fare)
        values (:new.rent_no, total_day, delay_day, delay_day * policy_fee);
      end if;
    end if;
  end;
/

insert into rent(rent_no, book_no, member_no, rent_date)
            values ('0001', 'B001', 'C001', '2023/08/01');
insert into rent(rent_no, book_no, member_no, rent_date)
            values ('0002', 'B009', 'C002', '2023/07/31');

update rent
   set return_date = '2023/08/08'
 where rent_no = '0001';
 
update rent
   set return_date = to_char(sysdate, 'YYYY/MM/DD')
 where rent_no = '0002';
 
select r.rent_no,
       r.book_no,
       r.member_no,
       r.rent_date,
       r.return_date,
       d.total_days,
       d.delay_days,
       d.delay_fare
  from rent r, delay d
 where r.rent_no = d.rent_no(+);
  
rollback;
```

```sql
RENT_NO|BOOK_NO|MEMBER_NO|RENT_DATE |RETURN_DATE|TOTAL_DAYS|DELAY_DAYS|DELAY_FARE|
-------+-------+---------+----------+-----------+----------+----------+----------+
0002   |B009   |C002     |2023/07/31|2023/08/11 |        11|         4|       400|
```

