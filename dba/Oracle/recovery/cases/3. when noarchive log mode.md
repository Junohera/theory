# When noarchive log mode

> offline full bakcupì´ ì„ í–‰ë˜ì–´ìˆì–´ì•¼ë§Œ ê°€ëŠ¥

## Setting

### 1. archive log mode to noarchive log mode

```sql
startup mount;
alter database noarchivelog;
alter database open;
archive log list;
```

```sql
SQL> startup mount
Database mounted.
SQL> alter database noarchivelog;
Database altered.
SQL> alter database open;
Database altered.
SQL> archive log list;
Database log mode              No Archive Mode
Automatic archival             Disabled
```

---

### 2. offline full backup

```sql
SQL> !mkdir /oracle12/backup
SQL> alter database backup controlfile to trace as '/oracle12/backup/control.sql';
vi /oracle12/backup/control.sql
SQL> shutdown immediate;

backupdir=/opt/backup4oracle12/backup_$(date +"%Y%m%d%H%M")
echo $backupdir

mkdir -p $backupdir
cp /oracle12/backup/control.sql $backupdir
cp /oracle12/app/oracle/oradata/db1/* $backupdir
cp /oracle12/app/oracle/product/12.2.0.1/db_1/dbs/*.ora $backupdir

cd $backupdir;ll;
total 2751240
-rw-r-----. 1 oracle oinstall  10600448 Jul 20 11:46 control01.ctl
-rw-r-----. 1 oracle oinstall  10600448 Jul 20 11:46 control02.ctl
-rw-r--r--. 1 oracle oinstall      1010 Jul 20 11:46 initdb1.ora
-rw-r--r--. 1 oracle oinstall      3079 Jul 20 11:46 init.ora
-rw-r-----. 1 oracle oinstall 209715712 Jul 20 11:46 redo01.log
-rw-r-----. 1 oracle oinstall 209715712 Jul 20 11:46 redo02.log
-rw-r-----. 1 oracle oinstall 209715712 Jul 20 11:46 redo03.log
-rw-r-----. 1 oracle oinstall      3584 Jul 20 11:46 spfiledb1.ora
-rw-r-----. 1 oracle oinstall 576724992 Jul 20 11:46 sysaux01.dbf
-rw-r-----. 1 oracle oinstall 734011392 Jul 20 11:46 system01.dbf
-rw-r-----. 1 oracle oinstall  20979712 Jul 20 11:46 temp01.dbf
-rw-r-----. 1 oracle oinstall 351281152 Jul 20 11:46 undotbs01.dbf
-rw-r-----. 1 oracle oinstall   5251072 Jul 20 11:46 users01.dbf

df


```

## Cases

|   no | noarchive log mode | Damage information | recently Redolog(SCN) | trouble shooting                                   |
| ---: | ------------------ | ------------------ | --------------------- | -------------------------------------------------- |
|    1 | Yes                | normal tablespace  | Yes                   | complete recovery                                  |
|    2 | Yes                | normal tablespace  | No                    | dropâœ…<br />incomplete recovery => hidden parameter |
|    3 | Yes                | system tablespace  | No                    | full restore recovery                              |

### 1. ì¼ë°˜ tablespaceì˜ datafile ì†ìƒ(when noarchivelogmode)

```sql
1. tablespace í™•ì¸
select *
  from dba_tablespaces;
  
2. ì¼ë°˜ tablespace ìƒì„±
select * from dba_data_files;
create tablespace test1
   			 datafile '/oracle12/app/oracle/oradata/db1/test1.dbf' size 10m;
Tablespace created.
3. offline backup
backupdir=/opt/backup4oracle12/backup_202307251405

4. ë°ì´í„° ìƒì„±
alter user scott quota unlimited on test1;
create table scott.noarch_test1(no number) tablespace test1;
insert into scott.noarch_test1 values(1);
insert into scott.noarch_test1 values(2);
insert into scott.noarch_test1 values(3);
commit;

5. ì¥ì•  ìƒí™© ë°œìƒ
!rm /oracle12/app/oracle/oradata/db1/test1.dbf

6. switch log
alter system switch logfile; -- min 3

7. DB hang
2023-07-25T14:16:15.314501+09:00
USER (ospid: 32269): terminating the instance due to error 1242
=> db ê°•ì œ ì¢…ë£Œ
	 ì—°ì†ì ì¸ log switchê°€ ë°œìƒí•˜ì—¬ current redo logë¡œ ë‹¤ì‹œ ë¡œê¹…ì„ ì‹œë„í•˜ëŠ” ìˆœê°„
	 í•´ë‹¹ SCNì •ë³´ë¥¼ ì•„ì§ ë™ê¸°í™”í•˜ì§€ ëª»í–ˆìœ¼ë¯€ë¡œ ë®ì–´ì“¸ ìˆ˜ ì—†ì–´ì„œ DB Hang -> shutdown abort
	 
-- recovery --
1. startup ì‹œë„
SQL> startup
ORACLE instance started.

Total System Global Area 1660944384 bytes
Fixed Size                  8621376 bytes
Variable Size            1056965312 bytes
Database Buffers          587202560 bytes
Redo Buffers                8155136 bytes
Database mounted.
ORA-01157: cannot identify/lock data file 6 - see DBWR trace file
ORA-01110: data file 6: '/oracle12/app/oracle/oradata/db1/test1.dbf'

2. shutdown
SQL> shutdown immediate

3. recovery
3-1) restore(test1.dbf)
	cp $backupdir/test1.dbf /oracle12/app/oracle/oradata/db1/test1.dbf
	
3-2) startup
SQL> startup
ORACLE instance started.
Database mounted.
ORA-01113: file 6 needs media recovery
ORA-01110: data file 6: '/oracle12/app/oracle/oradata/db1/test1.dbf'

3-3) recover
SQL> recover database until cancel;
ORA-00279: change 698904 generated at 07/25/2023 14:05:30 needed for thread 1
ORA-00289: suggestion : /home/oracle/arch/1_1_1143112888.dbf
ORA-00280: change 698904 for thread 1 is in sequence #11ï¸âƒ£ğŸ’¥


Specify log: {<RET>=suggested | filename | AUTO | CANCEL}
/oracle12/app/oracle/oradata/db1/redo01_2.log1ï¸âƒ£ğŸ’Š
ORA-00279: change 700451 generated at 07/25/2023 14:16:11 needed for thread 1
ORA-00289: suggestion : /home/oracle/arch/1_2_1143112888.dbf
ORA-00280: change 700451 for thread 1 is in sequence #22ï¸âƒ£ğŸ’¥
ORA-00278: log file '/oracle12/app/oracle/oradata/db1/redo01_2.log' no longer
needed for this recovery


Specify log: {<RET>=suggested | filename | AUTO | CANCEL}
/oracle12/app/oracle/oradata/db1/redo02.log2ï¸âƒ£ğŸ’Š
ORA-00279: change 700454 generated at 07/25/2023 14:16:12 needed for thread 1
ORA-00289: suggestion : /home/oracle/arch/1_3_1143112888.dbf
ORA-00280: change 700454 for thread 1 is in sequence #33ï¸âƒ£ğŸ’¥
ORA-00278: log file '/oracle12/app/oracle/oradata/db1/redo02.log' no longer
needed for this recovery


Specify log: {<RET>=suggested | filename | AUTO | CANCEL}
/oracle12/app/oracle/oradata/db1/redo03.log3ï¸âƒ£ğŸ’Š
Log applied.
Media recovery complete.âœ…

3-4) open
-- ë¶ˆì™„ì „ ë³µêµ¬ì‹œ, ê°€ê¸‰ì  resetlogsë¡œ open ì‹œë„ê¶Œì¥âœ…
SQL> alter database open resetlogs;

3-5) test
SQL> select * from scott.noarch_test1;

        NO
----------
         1
         2
         3

=> ì´ëŸ° ì¼€ì´ìŠ¤ëŠ” ì´ë¡ ì ìœ¼ë¡œ ê°€ëŠ¥í•  ì •ë„ì˜ í–‰ë³µì¼€ì´ìŠ¤ì„.
	 noarchivelogmodeë¥¼ í•´ë†“ì€ siteì¸ë°, í•­ìƒ ìµœì‹ ì˜ offline ë°±ì—…ë³¸ì´ ìˆì„ë¦¬ë„ ì—†ê±°ë‹ˆì™€
	 offline -> onlineí•˜ë©´ì„œ ìƒˆë¡œë“¤ì–´ì˜¤ëŠ” DMLì— ëŒ€í•´ ëŒ€ì‘ì´ ë¶ˆê°€ëŠ¥í•  ê²ƒ.
	 ì´ë¡ ì ìœ¼ë¡œëŠ” ì™„ì „ë³µêµ¬ì´ì§€ë§Œ ì„œë¹„ìŠ¤ê´€ì ì—ì„œëŠ” ë¬´ì¤‘ë‹¨ ì„œë¹„ìŠ¤ê°€ ê¹¨ì§ìœ¼ë¡œ ì†ì‹¤ë°œìƒ
```

<img src="./assets/image-20230725143621366.png" alt="image-20230725143621366" style="zoom:50%;" />

### 2. ì¼ë°˜ tablespaceì˜ datafile ì†ìƒ, ìµœì‹  SCNì´ redofileì— ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê²½ìš°(when noarchivelogmode)

> ë¹ ë¥´ê²Œ ì†ì ˆí•´ì„œ í•´ë‹¹ tablespaceë¥¼ ë²„ë¦¬ê³ , openì„ ì‹œí‚¤ê±°ë‚˜
> ë ì§€ ì•ˆë ì§€ ë¯¸ì§€ìˆ˜ì„ì—ë„ ì±™ê²¨ì•¼í•˜ëŠ” ë°ì´í„°ì¼ ê²½ìš°ì—ë§Œ recovery ì‹œë„(ì‹¤íŒ¨í•  ê²½ìš°, ê²°êµ­ ë²„ë¦¬ê³  ê°€ëŠ”ê²ƒê³¼ ë™ì¼)

```sql
1. users tablespaceì— ë°ì´í„° ìƒì„±
create table scott.noarch_recover2(no number) tablespace users;
insert into scott.noarch_recover2 values(1);
insert into scott.noarch_recover2 values(2);
insert into scott.noarch_recover2 values(3);
commit;

2. switch log
alter system switch logfile; -- 4

3. test1 tablespaceì— ë°ì´í„° ìƒì„±
create table scott.noarch_recover3(no number) tablespace test1;
insert into scott.noarch_recover3 values (1);
commit;
alter system switch logfile; -- 4
insert into scott.noarch_recover2 values(2);
commit;

4. ì¥ì•  ë°œìƒ
!rm /oracle12/app/oracle/oradata/db1/test1.dbf
shutdown abort

-- ë³µêµ¬ --
1. try startup
SQL> startup
Database mounted.
ORA-01157: cannot identify/lock data file 6 - see DBWR trace file
ORA-01110: data file 6: '/oracle12/app/oracle/oradata/db1/test1.dbf'

2. restore(test1.dbf)
	cp $backupdir/test1.dbf /oracle12/app/oracle/oradata/db1/test1.dbf
	
3) try startup
SQL> startup
Database mounted.
ORA-01190: control file or data file 6 is from before the last RESETLOGS
ORA-01110: data file 6: '/oracle12/app/oracle/oradata/db1/test1.dbf'

4) try recover
recover database until cancel;ğŸ’¥

5) ì¬íŒë‹¨
1. datafile drop offline(ë¹ ë¥¸ì†ì ˆ)
	- ë¬¸ì œ ë°œìƒ ì§í›„, recoveryë¥¼ ì‹œë„í•˜ì§€ ì•Šê³ , ì„ ë“œëí–ˆì–´ë„ ë¬´ë°©
2. time recovery

5-1) drop normal tablespace
=> but, ì´ë¯¸ recoverë¥¼ ì‹œë„í–ˆìœ¼ë¯€ë¡œ ì‹œì ì°¨ì´ ë°œìƒ
SQL> alter database datafile '/oracle12/app/oracle/oradata/db1/test1.dbf' offline drop;
Database altered.
SQL> alter database open noresetlogs;
alter database open resetlogs
*
ERROR at line 1:
ORA-01190: control file or data file 1 is from before the last RESETLOGS
ORA-01110: data file 1: '/oracle12/app/oracle/oradata/db1/system01.dbf'

---â˜ ï¸â˜ ï¸â˜ ï¸â˜ ï¸â˜ ï¸
ğŸ‘» hidden parameterë¥¼ í†µí•´ ì‹œì ì˜ ê°­ì„ jumpí•˜ê¸°
> pfileì— íŒŒë¼ë¯¸í„° ì¶”ê°€í•˜ì—¬ ê¸°ë™ì‹œë„

1. add parameter
vi initdb1.ora

...
_allow_resetlogs_corruption=true

:wq

2. remove spfile
rm spfiledb1.ora

3. try open
SQL> startup
ORACLE instance started.
Database mounted.
ORA-01589: must use RESETLOGS or NORESETLOGS option for database open

SQL> alter database open resetlogs;
alter database open resetlogs
*
ERROR at line 1:
ORA-00603: ORACLE server session terminated by fatal error
ORA-01092: ORACLE instance terminated. Disconnection forced
ORA-00704: bootstrap process failure
ORA-00704: bootstrap process failure
ORA-00600: internal error code, arguments: [kcbzib_kcrsds_1], [], [], [], [],
[], [], [], [], [], [], []
Process ID: 5732
Session ID: 1 Serial number: 36579

4. remove parameter
vi initdb1.ora
~~_allow_resetlogs_corruption=true~~

5. try open
SQL> startup
ORACLE instance started.
Database mounted.
Database opened.
SQL> @status

INSTANCE_NAME    STATUS
---------------- ------------
db1              OPEN
```

### 3. system tablespaceì˜ ì†ìƒ

```sql
create table scott.noarch_recover4(no number) tablespace system;
insert into scott.noarch_recover4 values(1);
insert into scott.noarch_recover4 values(2);
commit;
alter system switch logfile; -- 4ë²ˆ
insert into scott.noarch_recover4 values(3);
commit;
alter system switch logfile; -- 4ë²ˆ

!rm /oracle12/app/oracle/oradata/db1/system01.dbf
shutdown abort

1. try start
ORA-01157: cannot identify/lock data file 1 - see DBWR trace file
ORA-01110: data file 1: '/oracle12/app/oracle/oradata/db1/system01.dbf'
2. unavailable offline drop...
3. full backup
SQL> shutdown immediate;
offline full restoreâœ…
```

