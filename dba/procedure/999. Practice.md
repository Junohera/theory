[toc]

# Procedure Practice

## 1. scott.emp í…Œì´ë¸”ì—ì„œ ì‚¬ì›ë²ˆí˜¸ê°€ 7369ì¸ ì‚¬ì› ì´ë¦„, ë¶€ì„œë²ˆí˜¸, ì§ì—… ì¶œë ¥

ì¶œë ¥í˜•íƒœ : SMITH-20-CLERK

```sql
select ename||'-'||deptno||'-'||job
  from scott.emp
 where empno = 7369;
```

when orange

```sql
-- ref: desc scott.emp;
declare
    vename  varchar2(10);
    vdeptno number(2);
    vjob    varchar2(9);
begin
  select ename, deptno, job 
    into vename, vdeptno, vjob
    from scott.emp
   where empno = 7369;
   
 DBMS_OUTPUT.PUT_LINE(vename||'-'||vdeptno||'-'||vjob);
end;
/
```

<img src="C:\Users\ITWILL\AppData\Roaming\Typora\typora-user-images\image-20230804154826196.png" alt="image-20230804154826196" style="zoom: 50%;" />

when prompt

```sql
SQL> set serveroutput on
declare
    vename  varchar2(10);
    vdeptno number(2);
    vjob    varchar2(9);
begin
  select ename, deptno, job 
    into vename, vdeptno, vjob
    from scott.emp
   where empno = 7369;

 DBMS_OUTPUT.PUT_LINE(vename||'-'||vdeptno||'-'||vjob);
end;
 11   12  /
SMITH-20-CLERK

PL/SQL procedure successfully completed.
```

<img src="C:\Users\ITWILL\AppData\Roaming\Typora\typora-user-images\image-20230804154952820.png" alt="image-20230804154952820" style="zoom: 67%;" />

## 2. scott.emp í…Œì´ë¸”ì—ì„œ ì‚¬ì›ë²ˆí˜¸ê°€ 7369ì¸ ì‚¬ì›ì˜ ê¸‰ì—¬ë¥¼ allen ê¸‰ì—¬ì˜ 10% ì¦ê°€ê°’ìœ¼ë¡œ ì—…ë°ì´íŠ¸í•˜ë¼

```sql
declare
  vsal number;
begin
  select sal 
    into vsal
    from scott.emp
   where ename = 'ALLEN';
   
  update emp
     set sal = vsal * 1.1
   where empno = 7369;
end;
/

select sal from emp where empno = 7369;
rollback
select sal from emp where empno = 7369;
```

## 3. ì‚¬ìš©ìì—ê²Œ í•™ë²ˆì„ ì…ë ¥ë°›ì•„ ì‚¬ìš©ì ì´ë¦„ê³¼ ì‹œí—˜ì„±ì ì„ ì•„ë˜ì™€ ê°™ì€ í˜•ì‹ìœ¼ë¡œ ì¶œë ¥(ì°¸ì¡°ë³€ìˆ˜ í™œìš©)

> ì´ë¦„: ì„œì¬ìˆ˜, ì ìˆ˜: 95

```shell
SQL> conn scott/oracle
SQL> edit
```

```sql
SQL> edit s2.sql

set serveroutput on
set verify off
set feedback off
accept vstudno prompt 'í•™ë²ˆì„ ì…ë ¥í•˜ì„¸ìš”'

declare
	vname  student.name%type;
	vjumsu exam_01.total%type;
begin
  select s.name, e.total 
    into vname, vjumsu
    from student s, exam_01 e
   where s.studno = e.studno
     and s.studno = &vstudno;
   
  dbms_output.put_line('ì´ë¦„: '||vname||', ì ìˆ˜: '||vjumsu);
end;
/
```

## 4. ì‚¬ìš©ìë¡œë¶€í„° ë²ˆí˜¸(no), ì´ë¦„(name), ì£¼ì†Œ(addr)ê°’ì„ ì…ë ¥ ë°›ì€ í›„, pl_test1í…Œì´ë¸”ì— ê°’ì„ ì…ë ¥í•˜ëŠ” plsql êµ¬ë¬¸ ì‘ì„±

```sql
create table pl_test1
(no 		number,
 name		varchar2(10),
 addr  	varchar2(20));
```

### declare - X

```sql
begin
  insert into pl_test1 values(&vno, '&vname', '&vaddr');
  commit;
end;
/
```

### declare - O

```sql
declare
  vno 	number := &ino;
  vname varchar2(10) := '&iname';
  vaddr varchar2(20) := '&iaddr';
begin
  insert into pl_test1 values(vno, vname, vaddr);
  commit;
end;
/
```

## 5. ì‚¬ìš©ìë¡œë¶€í„° ë‘ ìˆ˜ë¥¼ ì „ë‹¬ë°›ì•„ ë‘ ìˆ˜ì˜ í•©ì„ ì•„ë˜ì™€ ê°™ì€ í˜•ì‹ìœ¼ë¡œ ì¶œë ¥

> ì²«ë²ˆì§¸ ìˆ˜: 10, ë‘ë²ˆì§¸ ìˆ˜: 20, í•©: 30

```sql
SQL> edit

### predefine
declare
  n1	 	number := &ia;
  n2 		number := &ib;
  vsum 	number;
begin
  vsum := n1 + n2;
	dbms_output.put_line('ì²«ë²ˆì§¸ ìˆ˜: '||n1||', ë‘ë²ˆì§¸ ìˆ˜: '||n2||', í•©: '||vsum);
end;
/
### immediate calc
declare
  n1	 	number := &ia;
  n2 		number := &ib;
begin
	dbms_output.put_line('ì²«ë²ˆì§¸ ìˆ˜: '||n1||', ë‘ë²ˆì§¸ ìˆ˜: '||n2||', í•©: '||to_char(n1+n2));
end;
/

SQL> /
iaì˜ ê°’ì„ ì…ë ¥í•˜ì‹­ì‹œì˜¤: 1
ibì˜ ê°’ì„ ì…ë ¥í•˜ì‹­ì‹œì˜¤: 2
ì²«ë²ˆì§¸ ìˆ˜: 1, ë‘ë²ˆì§¸ ìˆ˜: 2, í•©: 3

PL/SQL ì²˜ë¦¬ê°€ ì •ìƒì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.

```

## 6. ì‚¬ë²ˆì„ ì…ë ¥ë°›ê³  í•´ë‹¹ ì§ì›ì˜ ë¶€ì„œì´ë¦„ì„ ì¶œë ¥(if í™œìš©)

> ë‹¨, 10ë²ˆì´ë©´ ì¸ì‚¬ë¶€
>
> 20ë²ˆì´ë©´ ì´ë¬´ë¶€
>
> 30ë²ˆì´ë©´ ì¬ë¬´ë¶€

```sql
declare
  vempno 		number := &iempno;
  vdeptno		scott.emp.deptno%type;
  vdname		scott.department.dname%type;
begin
	select deptno 
	  into vdeptno
	  from scott.emp
	 where empno = vempno;
 	dbms_output.put_line('vdeptno: '||vdeptno);
 	
 	if (vdeptno = 10) then
 	  vdname := 'ì¸ì‚¬ë¶€';
 	end if;
 	
 	if (vdeptno = 10) then vdname := 'ì¸ì‚¬ë¶€'; end if;
 	if (vdeptno = 20) then vdname := 'ì´ë¬´ë¶€'; end if;
 	if (vdeptno = 30) then vdname := 'ì¬ë¬´ë¶€'; end if;
 	
 	dbms_output.put_line('10ë²ˆì´ë©´ ì¸ì‚¬ë¶€'||CHR(10)||'20ë²ˆì´ë©´ ì´ë¬´ë¶€'||CHR(10)||'30ë²ˆì´ë©´ ì¬ë¬´ë¶€');
 	dbms_output.put_line('ì†Œì†ë¶€ì„œ: '||vdname||'('||vdeptno||')');
end;
/
```

## 7. ì‚¬ë²ˆì„ ì…ë ¥ë°›ê³  í•´ë‹¹ ì§ì›ì˜ ê¸‰ì—¬ë¥¼ ì•„ë˜ì™€ ê°™ì´ ì¶œë ¥

`ì‚¬ë²ˆ: 7369, ê¸‰ì—¬ë“±ê¸‰: B`

> ë‹¨, ê¸‰ì—¬ë“±ê¸‰ì€ 
> [~, 2000)            C
> [2000, 3000)   B
> [3000, ~)            A

```sql
set serveroutput on
set verify off
set feedback off
accept iempno prompt 'ì‚¬ë²ˆì„ ì…ë ¥í•˜ì„¸ìš”: '

declare
  vempno    scott.emp.empno%type := &iempno;
  vsal 			scott.emp.sal%type;
  salgrade	char(1) := 'C';
begin
  select sal
    into vsal
    from scott.emp
   where 1=1
     and empno = vempno;
  
  if (3000 <= vsal) then
    salgrade := 'A';
  elsif (2000 <= vsal) then
    salgrade := 'B';  
  end if;
  
  dbms_output.put_line('ì‚¬ë²ˆ: '||vempno||', ê¸‰ì—¬ë“±ê¸‰: '||salgrade);
end;
/
```

```sql
iempnoì˜ ê°’ì„ ì…ë ¥í•˜ì‹­ì‹œì˜¤: 7369
7369
800
ì‚¬ë²ˆ: 7369, ê¸‰ì—¬ë“±ê¸‰: C

PL/SQL ì²˜ë¦¬ê°€ ì •ìƒì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.
```

## 8. í•™ë²ˆì„ ì…ë ¥ë°›ê³ , í•´ë‹¹ í•™ìƒì˜ ë¹„ë§Œì—¬ë¶€ ì¶œë ¥

í•™ë²ˆ: 9411, ë¹„ë§Œì—¬ë¶€: í‘œì¤€

> ë‹¨, ë¹„ë§Œì—¬ë¶€ëŠ” ì•„ë˜ì™€ ê°™ì´ ê³„ì‚°
>
> í‘œì¤€ì²´ì¤‘ = (í‚¤ - 100) * 0.9
>
> ì²´ì¤‘ > í‘œì¤€ì²´ì¤‘ = ê³¼ì²´ì¤‘
> ì²´ì¤‘ < í‘œì¤€ì²´ì¤‘ = ì €ì²´ì¤‘
>
> ì²´ì¤‘ = í‘œì¤€ì²´ì¤‘ = í‘œì¤€

```sql
set serveroutput on
set verify off
set feedback off

accept istudno prompt 'í•™ë²ˆì„ ì…ë ¥í•˜ì„¸ìš”: '

declare
  vstudno scott.student.studno%type := &istudno;
  weight_grade varchar2(3);

  vheight           scott.student.height%type;
  vweight           scott.student.weight%type;
  std_weight        scott.student.weight%type;
  std_weight_grade  varchar2(6);
begin
  select height, weight
    into vheight, vweight
    from scott.student
   where studno = vstudno;

  std_weight := (vheight - 100) * 0.9;
  std_weight_grade := case when std_weight < vweight then 'ê³¼ì²´ì¤‘'
                  	  		 when std_weight > vweight then 'ì €ì²´ì¤‘'
                                           				   else 'í‘œì¤€' end;

  dbms_output.put_line('í•™ë²ˆ: '||vstudno||', ë¹„ë§Œì—¬ë¶€: '||std_weight_grade);
end;
/
```

```sql
SQL> edit s8
SQL> @s8
í•™ë²ˆì„ ì…ë ¥í•˜ì„¸ìš”: 9411
í•™ë²ˆ: 9411, ë¹„ë§Œì—¬ë¶€: í‘œì¤€
```

## 9. 1~5 ì¶œë ¥

```sql
declare
  no number := 1;
begin
 loop
 	dbms_output.put_line(no);
 	no := no + 1;
 	exit when no >= 6;
 end loop;
end;
/
```

## 10. êµ¬êµ¬ë‹¨ basic loop

```sql
set serveroutput on
set verify off
set feedback off
accept idan prompt 'ë‹¨ì„ ì…ë ¥í•˜ì„¸ìš”: '

declare
  no    number := 1;
  dan   number := &idan;
begin
  loop
    dbms_output.put_line(to_char(dan)||' x '||to_char(no)||' = '||to_char(no * dan, 99999999));
    no := no + 1;
    exit when no >= 10;
  end loop;
end;
/
```

```shell
SQL> edit 10
SQL> @10
```

## 11. êµ¬êµ¬ë‹¨ for

```sql
set serveroutput on
set verify off
set feedback off
accept idan prompt 'ë‹¨ì„ ì…ë ¥í•˜ì„¸ìš”: '

declare
  dan   number := &idan;
begin
  for i in 1..9 loop
    dbms_output.put_line(to_char(dan)||' x '||to_char(i)||' = '||to_char(i * dan, 99999999));
  end loop;
end;
/
```

## 12. êµ¬êµ¬ë‹¨ while

```sql
set serveroutput on
set verify off
set feedback off
accept idan prompt 'ë‹¨ì„ ì…ë ¥í•˜ì„¸ìš”: '

declare
  no    number := 1;
  dan   number := &idan;
begin
  while no < 10 loop
    dbms_output.put_line(to_char(dan)||' x '||to_char(no)||' = '||to_char(no * dan, 99999999));
    no := no + 1;
  end loop;
end;
/
```

## 13. ì…ë ¥ë°›ì€ í•™ë²ˆì˜ ì‹œí—˜ì„±ì ì„ ì°¸ì¡°í•˜ì—¬ ë‹¤ìŒì²˜ëŸ¼ ì¶œë ¥

> ì´ë¦„:     ë“±ê¸‰:
> ë‹¨, 
> [90, ~)     A
> [70, 90)  B
> [~, 70)     C
>
>
> 70 > score ? C
> 90 > score ? B
> A

```sql
set serveroutput on
set verify off
set feedback off
accept istudno prompt 'í•™ë²ˆì„ ì…ë ¥í•˜ì„¸ìš”: '

declare
  vstudno       scott.student.studno%type := &istudno;

  vname         scott.student.name%type;
  vscore        scott.exam_01.total%type;
  score_grade   char(1);
begin
  select s.name, (select total
                  from exam_01
                 where studno = s.studno) 
    into vname, vscore
    from scott.student s
   where 1=1
     and s.studno = vstudno;

  if (70 > vscore) then score_grade := 'C';
  elsif (90 > vscore) then score_grade := 'B';
  else score_grade := 'A';
  end if;

  dbms_output.put_line('ì´ë¦„: '||vname||', ë“±ê¸‰: '||score_grade);
end;
/
```

## 14. ì…ë ¥ë°›ì€ ì‚¬ë²ˆì„ ê°–ëŠ” payì˜ ìƒˆë¡œìš´ payë¡œ ì—…ë°ì´íŠ¸í•˜ëŠ” plsqlêµ¬ë¬¸ ì‘ì„±

> ì „ë¶€ì¥ì˜ PAYê°€ ?ì—ì„œ ?ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.
>
> emp2
> (ë³¸ì¸ pay + ìƒìœ„ ê´€ë¦¬ì pay)/2 * ì¸ìƒë¥ 
> ì¸ìƒë¥  = emp_type = 'ì •ê·œì§' ? 1.08 emp_type = 'ê³„ì•½ì§'

| ê³ ìš©í˜•íƒœ | ì¸ìƒë¥  |
| -------- | ------ |
| ì •ê·œì§   | 1.08   |
| ê³„ì•½ì§   | 1.05   |
| ìˆ˜ìŠµì§   | 1.03   |
| ì¸í„´ì§   | 1.01   |

```sql
set serveroutput on
set verify off
set feedback off
accept iempno prompt 'ì‚¬ë²ˆì„ ì…ë ¥í•˜ì„¸ìš”: '

declare
--  vempno        scott.emp2.empno%type := 19900101;
  vempno        scott.emp2.empno%type := &iempno;
  vname         scott.emp2.name%type;
  vpay          scott.emp2.pay%type;
  vemp_type     scott.emp2.emp_type%type;

  vpempno       scott.emp2.empno%type;
  vpemp_pay     scott.emp2.pay%type;
  ratio         number(3,2);
  maybe_pay			scott.emp2.pay%type;
  new_pay       scott.emp2.pay%type;
begin
  select e.name,
         e.pay,
         e.emp_type,
         nvl(pe.pay, e.pay)
    into vname, vpay, vemp_type, vpemp_pay
    from emp2 e
    left outer join emp2 pe
      on e.pempno = pe.empno
   where e.empno = vempno;

  ratio := case when vemp_type = 'ì •ê·œì§' then 1.08
                when vemp_type = 'ê³„ì•½ì§' then 1.05
                when vemp_type = 'ìˆ˜ìŠµì§' then 1.03
                else 1.01 end;

  new_pay := (vpay + vpemp_pay)/2 * ratio;
  
  update emp2
     set pay = new_pay
   where empno = vempno;
   
  select pay into maybe_pay
    from emp2 
   where empno = vempno;
   
  -- commit;
  dbms_output.put_line(vname||'ì˜ PAYê°€ '||vpay||'ì—ì„œ '||maybe_pay||'ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
end;
/
```

## 15. ì…ë ¥ë°›ì€ ì‹œê°„ëŒ€ì— ê°€ì¥ ì¸ê¸°ìˆëŠ” ìŒì‹ì—…ì¢… ì¶œë ¥

### before learn cursor

```sql
set serveroutput on
set verify off
set feedback off
accept itime prompt 'ì‹œê°„ëŒ€ë¥¼ ì…ë ¥í•˜ì„¸ìš”(0 ~ 23): '

declare
  vtime scott.delivery.ì‹œê°„ëŒ€%type := &itime;
  vcate scott.delivery.ì—…ì¢…%type;
begin
	select ì—…ì¢… 
	  into vcate
    from (select ì—…ì¢…, rank() over(order by sum(í†µí™”ê±´ìˆ˜) desc, ì—…ì¢… asc) as r
            from scott.delivery
           where ì‹œê°„ëŒ€ = lpad(to_char(vtime), 2, '0')
           group by ì—…ì¢…) t
   where t.r = 1;
   dbms_output.put_line(vcate);
end;
/
```

### after learn cursor

#### basic loop

```sql
declare
  vtime 	scott.delivery.ì‹œê°„ëŒ€%type := 0;
  vcate 	scott.delivery.ì—…ì¢…%type;
  
  vì—…ì¢… 	  scott.delivery.ì—…ì¢…%type;
  vr 			number;
  
  cursor res is 
	  select ì—…ì¢…, rank() over(order by sum(í†µí™”ê±´ìˆ˜) desc, ì—…ì¢… asc) as r
  		from scott.delivery
     where ì‹œê°„ëŒ€ = lpad(to_char(vtime), 2, '0')
     group by ì—…ì¢…;
     
begin
	open res;
  loop
    fetch res into vì—…ì¢…, vr;  
    
    if (vr = 1) then
      dbms_output.put_line(vì—…ì¢…);
    end if;
    
    exit when vr = 1;
	end loop;
end;
/
```

#### for loop

```sql
declare
  vtime scott.delivery.ì‹œê°„ëŒ€%type := 0;
  vcate scott.delivery.ì—…ì¢…%type;
begin
  for v in (select ì—…ì¢…, rank() over(order by sum(í†µí™”ê±´ìˆ˜) desc, ì—…ì¢… asc) as r
              from scott.delivery
             where ì‹œê°„ëŒ€ = lpad(to_char(vtime), 2, '0')
             group by ì—…ì¢…)
  loop
  
  if (v.r = 1) then
    dbms_output.put_line(v.ì—…ì¢…);
  end if;
  
  end loop;
end;
/
```

## 16. ëª¨ë“  í•™ìƒì˜ ì§€ë„êµìˆ˜ë¥¼ ì•„ë˜ì™€ ê°™ì´ ì¶œë ¥ (cursor í™œìš©)

> student, professor í…Œì´ë¸”ì„ ì‚¬ìš©í•˜ì—¬
> ê° í•™ìƒì˜ ì´ë¦„, ì§€ë„êµìˆ˜ ì´ë¦„ì„ ì•„ë˜ì™€ ê°™ì´ ì¶œë ¥
> ë‹¨, ì§€ë„êµìˆ˜ê°€ ì—†ëŠ” ê²½ìš°ëŠ” ì§€ë„êµìˆ˜ì—†ìŒ ì¶œë ¥
>
> í•™ìƒëª…: ..., ì§€ë„êµìˆ˜ëª…: ...

### **basic loop**

```sql
declare
  i  			number;
  vname		scott.student.name%type;
  vpname	scott.professor.name%type;
  
  cursor sp is
    select s.name, nvl(p.name, 'ì§€ë„êµìˆ˜ì—†ìŒ') as pname
      from student s, professor p
     where s.profno = p.profno(+);
begin
	i := 0;
	open sp;
  loop
    fetch sp into vname, vpname;  
    exit when sp%notfound;
    i := i + 1;
    dbms_output.put_line(i||CHR(10)||'í•™ìƒëª…: '||vname||', ì§€ë„êµìˆ˜ëª…: '||vpname);
  end loop; 
end;
/
```

### **for loop**

```sql
declare
  i  number := 0;
  cursor sp is
    select s.name, nvl(p.name, 'ì§€ë„êµìˆ˜ì—†ìŒ') as pname
      from student s, professor p
     where s.profno = p.profno(+);
begin
  for v in sp loop
    i := i + 1;
    dbms_output.put_line(i||CHR(10)||'í•™ìƒëª…: '||v.name||', ì§€ë„êµìˆ˜ëª…: '||v.pname);
  end loop;
end;
/
```

## 17. ì»¤ì„œ ì˜ˆì™¸ì²˜ë¦¬

> NO_DATA_FOUND vs SQL%NOTFOUND
>
> NO_DATA_FOUND: SELECTì—ì„œì˜ ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°ì— ëŒ€í•œ ì˜ˆì™¸ì²˜ë¦¬
> SQL$NOTFOUND: ë¬µì‹œì  ì»¤ì„œì˜ ì†ì„±ìœ¼ë¡œ ì»¤ì„œê°€ ì—´ë ¤ì ¸ ìˆì„ ë•Œ ì‚¬ìš©

### case 1) NO_DATA_FOUND

```sql
declare
	ino		number;
	vname varchar2(10);
begin
	select ename
	  into vname
	  from emp
	 where empno = ino;
	dbms_output.put_line(vname);
exception
	when NO_DATA_FOUND then
	dbms_output.put_line('ì‚¬ì›ì´ ì—†ìŠµë‹ˆë‹¤.');
end;
/
```

> âœ… ì˜ˆì™¸ì²˜ë¦¬ ì„±ê³µ
> exceptionì ˆì˜ NO_DATA_FOUNDì— ì˜í•´ ì˜ˆì™¸ì²˜ë¦¬ë˜ì–´ í”„ë¡œì‹œì € ì •ìƒ ìˆ˜í–‰

### case 2) SQL%NOTFOUND(SELECT)

```sql
declare
	ino		number := 9999;
	vname varchar2(10);
begin
	select ename
	  into vname
	  from emp
	 where empno = ino;
	 
	-- ì—´ë ¤ì ¸ìˆëŠ” ì»¤ì„œê°€ ì¡´ì¬í•˜ì§€ ì•Šì•„ ifë¬¸ì´ ì˜ë¯¸ì—†ìŒ
	if SQL%NOTFOUND then
		dbms_output.put_line('ì‚¬ì›ì´ ì—†ìŠµë‹ˆë‹¤.');
	end if;
end;
/
```

> ğŸ’¥ì˜ˆì™¸ì²˜ë¦¬ ì‹¤íŒ¨
> ì—´ë ¤ì ¸ìˆëŠ” ì»¤ì„œê°€ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ, ì»¤ì„œì— ëŒ€í•œ ì†ì„±ì„ ì ‘ê·¼í•´ë„ ì˜ë¯¸ê°€ ì—†ìŒ

### case 3) SQL%NOTFOUND(DELETE)

```sql
declare
	ino		number := 9999;
	vname varchar2(10);
begin
	delete from emp
	 where empno = ino;
   
  -- ë¬µì‹œì  ì»¤ì„œê°€ ë‚´ì¥ëœ deleteë¬¸ì— ì˜í•´ ë‹¤ìŒì˜ ifë¬¸ì— ì˜í•´ ë¶„ê¸°ì„±ê³µ
	if SQL%NOTFOUND then
		dbms_output.put_line('ì‚¬ì›ì´ ì—†ìŠµë‹ˆë‹¤.');
	end if;
end;
/
```

> âœ… ì˜ˆì™¸ì²˜ë¦¬ ì„±ê³µ
> deleteë¬¸ì˜ ê²½ìš°, ë¬µì‹œì  ì»¤ì„œì´ë¯€ë¡œ ì»¤ì„œê°€ ë‹«íˆì§€ ì•Šì•„ 
> ì—´ë ¤ì ¸ìˆëŠ” ì»¤ì„œê°€ ì¡´ì¬í•˜ë¯€ë¡œ, ì»¤ì„œì— ëŒ€í•œ ì†ì„±ì— ì ‘ê·¼ ê°€ëŠ¥.

## 18. create procedure

```sql
-- empì—ì„œ ì‚¬ë²ˆì„ ì…ë ¥í•˜ë©´ í•´ë‹¹ ì‚¬ì›ì˜ SALì„ 5000ìœ¼ë¡œ ì—…ë°ì´íŠ¸
create or replace procedure update_emp_sal
(vempno scott.emp.empno%type)
is
begin
  update emp
     set sal = 5000
   where empno = vempno;
   
  if SQL%NOTFOUND then
    raise_application_error(-20500, 'í•´ë‹¹ ë²ˆí˜¸('||vempno||')ì˜ ì‚¬ì›ì´ ì—†ìŠµë‹ˆë‹¤.');
  end if;
end;
/

exec update_emp_sal(9999);
exec update_emp_sal(7369);
rollback;
```

## 19. create procedure for update

> ì…ë ¥ë°›ì€ í•™ìƒë²ˆí˜¸ì— í•´ë‹¹í•˜ëŠ” í•™ìƒì˜ ì‹œí—˜ì„±ì ì„ í™•ì¸

```sql
alter table scott.student add hakjum varchar2(10);
update student s
   set hakjum = (select h.grade
                   from hakjum h, exam_01 e
                  where e.studno = s.studno
                    and e.total between h.min_point and h.max_point);
```

```sql
ì•„ë˜ ê¸°ì¤€ìœ¼ë¡œ ìƒˆë¡œìš´ í•™ì ìœ¼ë¡œ update ì§„í–‰
98ì  ì´ìƒ A+
92ì  ì´ìƒ A0
85ì  ì´ìƒ B+
80ì  ì´ìƒ B0
ë‚˜ë¨¸ì§€ 	 C
```

```sql
create or replace procedure update_hakjum
(vstudno scott.student.studno%type)
is
  vname         scott.student.name%type;
  old_hakjum    scott.student.hakjum%type;
  new_hakjum    scott.student.hakjum%type;
begin
  select s.name,
         s.hakjum,
         case when e.total >= 98 then 'A+'
              when e.total >= 92 then 'A0'
              when e.total >= 85 then 'B+'
              when e.total >= 80 then 'B0'
                                 else 'C' end
    into vname, old_hakjum, new_hakjum
    from scott.student s, scott.exam_01 e
   where 1=1
     and s.studno = e.studno(+)
     and s.studno = vstudno;    
   
  if SQL%NOTFOUND then
    raise_application_error(-20500, 'í•´ë‹¹ ë²ˆí˜¸('||vstudno||')ì˜ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.');
  end if;
  
  if old_hakjum <> new_hakjum then
    dbms_output.put_line(vname||'('||vstudno||'ë²ˆ) í•™ìƒì˜ í•™ì ì´ '||old_hakjum||'ì—ì„œ '||new_hakjum||'ë¡œ ë³€ê²½ë©ë‹ˆë‹¤.');
    update student
       set hakjum = new_hakjum
     where studno = vstudno;
    dbms_output.put_line(vname||'('||vstudno||'ë²ˆ) í•™ìƒì˜ í•™ì ì´ '||old_hakjum||'ì—ì„œ '||new_hakjum||'ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
  else
    dbms_output.put_line(vname||'('||vstudno||'ë²ˆ) í•™ìƒì˜ í•™ì ì€ ë³€ë™ì—†ì´ '||old_hakjum||'í•™ì ì…ë‹ˆë‹¤.');
  end if;
exception
  when NO_DATA_FOUND then
	dbms_output.put_line('í•´ë‹¹ ë²ˆí˜¸('||vstudno||')ì˜ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.');
  when others then
  dbms_output.put_line('ACCUR ERROR');
end;
/
;
exec update_hakjum(9411);
exec update_hakjum(9999);
rollback;
```

## 20. create procedure for update

> ì‚¬ì›ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ë©´
> í˜„ì¬ ë‚˜ì´ì— ë§ëŠ” ì§ê¸‰ì„ P_GRADEì—ì„œ ì°¾ì•„ EMP2í…Œì´ë¸”ì˜ POSITIONì— ì—…ë°ì´íŠ¸
> ì‚¬ì›ì´ ì—†ìœ¼ë©´ ì‚¬ì›ì´ ì—†ë‹¤ëŠ” ì—ëŸ¬ ì²˜ë¦¬(ë¹„ì •ìƒ ì¢…ë£Œ)
> ë§¤ì¹­ë˜ëŠ” ì§ê¸‰ì´ ì—†ìœ¼ë©´ ì§ê¸‰ì„ ì •ì˜í•  ìˆ˜ ì—†ë‹¤ëŠ” ì—ëŸ¬ ì²˜ë¦¬(ì •ìƒ ì¢…ë£Œ)

```sql
create or replace procedure update_emp2_position
(iempno   scott.emp2.empno%type)
is
  vname         scott.emp2.name%type;
  old_position  scott.emp2.position%type;
  new_position  scott.emp2.position%type;
  vage          number(4);
  
  no_position   exception;
  same_position exception;
begin
  select e.name, e.position, p.position, age
    into vname, old_position, new_position, vage
    from (select e.empno,
                 e.name,
                 e.birthday,
                 e.position,
                 trunc(months_between(sysdate, birthday) / 12) as age
            from emp2 e
           where 1=1
             and e.empno = iempno
         ) e,
         p_grade p
   where 1=1
     and e.age between p.s_age(+) and p.e_age(+);
     
   if new_position is null then
     raise no_position;
   end if;
   
   if old_position = new_position then
     raise same_position;
   end if;
   
   -- <transaction>
   update emp2
      set position = new_position
    where empno = iempno;
   -- </transaction>
   
   dbms_output.put_line('í•´ë‹¹ ì§ì› '||vname||'('||iempno||')ëŠ” ê¸°ì¡´ ì§ê¸‰ '''||old_position||'''ì—ì„œ '''||new_position||'''ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
   
exception
  when NO_DATA_FOUND then
  dbms_output.put_line('ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì‚¬ì›ë²ˆí˜¸ì…ë‹ˆë‹¤.('||iempno||')');
  when no_position then
  dbms_output.put_line('í•´ë‹¹ ì§ì›ì˜ ë‚˜ì´ëŠ” '||vage||'ì´ë¯€ë¡œ ë§¤ì¹­ë˜ëŠ” ì§ê¸‰ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.('||iempno||')');
  when same_position then
  dbms_output.put_line('í•´ë‹¹ ì§ì›ì˜ ë‚˜ì´ëŠ” '||vage||'ì´ë¯€ë¡œ ë§¤ì¹­ë˜ëŠ” ì§ê¸‰ì´ '||old_position||'ì…ë‹ˆë‹¤. í—ˆë‚˜, ê¸°ì¡´ ì§ê¸‰ê³¼ ë™ì¼í•˜ë¯€ë¡œ í˜„ìƒ ìœ ì§€í•©ë‹ˆë‹¤.('||iempno||')');
  when others then
  dbms_output.put_line('UNCLASSIFICATION ACCUR ERROR');
end;
/
exec update_emp2_position(1);           -- failure cause no data
exec update_emp2_position(19900101);    -- failure cause new_position X
exec update_emp2_position(20000101);    -- failure cause same position
exec update_emp2_position(19960303);    -- success
rollback;
```

## 21. create procedure for delete one

> professor2ì™€ professorë¥¼ ë™ì¼í•˜ê²Œ ìƒì„±í•œ í›„ ì§„í–‰
> êµìˆ˜ë³„ë¡œ ì§ê¸‰ë³„ í‰ê· ë³´ë‹¤ ì ê²Œ ë°›ëŠ” êµìˆ˜ ì •ë³´ë¥¼ ì‚­ì œí•˜ê³ ì í•œë‹¤
> êµìˆ˜ë²ˆí˜¸ë¥¼ ì…ë ¥ë°›ê³  ì‚­ì œ ëŒ€ìƒì¼ê²½ìš°, ì‚­ì œ
> ì ì ˆí•œ ì—ëŸ¬ì²˜ë¦¬

```sql
create or replace procedure update_professor2_delete_one
(iprofno scott.professor2.profno%type)
is
  vname             scott.professor2.name%type;
  vposition         scott.professor2.position%type;
  vpay              scott.professor2.pay%type;
  avg_pay           scott.professor2.pay%type;
  enough_pay        exception;
begin
  select name,
         position,
         pay,
         avg_pay_by_position
    into vname, vposition, vpay, avg_pay
    from (select profno,
                 name,
                 position,
                 pay,
                 round(avg(pay) over(partition by position), 2) as avg_pay_by_position
            from professor2) t
   where 1=1
     and profno = iprofno;
   
  if vpay >= avg_pay then
    raise enough_pay;
  end if;
  
  -- <transaction>
  delete from professor2
   where profno = iprofno;
  -- </transaction>
  commit;
  dbms_output.put_line(iprofno||'ë²ˆ êµìˆ˜ì˜ ì§ê¸‰:'||vposition||' í‰ê· ê¸‰ì—¬('||avg_pay||'), í˜„ì¬ê¸‰ì—¬('||vpay||') ì´ë¯€ë¡œ, ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
   
exception
  when NO_DATA_FOUND then
  dbms_output.put_line(iprofno||'ë²ˆì€ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” êµìˆ˜ë²ˆí˜¸ì…ë‹ˆë‹¤.');
  when enough_pay then
  dbms_output.put_line(iprofno||'ë²ˆ êµìˆ˜ì˜ ì§ê¸‰:'||vposition||' í‰ê· ê¸‰ì—¬('||avg_pay||'), í˜„ì¬ê¸‰ì—¬('||vpay||') ì´ë¯€ë¡œ, ì‚­ì œëŒ€ìƒì´ ì•„ë‹™ë‹ˆë‹¤.');
  when others then
  dbms_output.put_line('ACCUR UNHANDLING EXCEPTION');
end;
/

exec update_professor2_delete_one(1);       -- failure cause no professor
exec update_professor2_delete_one(2002);    -- failure cause enough pay
exec update_professor2_delete_one(4006);    -- success
```



## 22. create procedure for delete many

>  ìœ„ì™€ ë™ì¼í•˜ì§€ë§Œ, ì…ë ¥ë°›ì§€ ì•Šê³ , ëª¨ë“  ì‚­ì œëŒ€ìƒ ì‚­ì œ

```sql
TODO:
for 
loop

end loop;
```



