[toc]

# Function

input valueÏôÄ output valueÏùò Í¥ÄÍ≥ÑÎ•º Ï†ïÏùòÌïòÎäî Í∞ùÏ≤¥
input valueÎäî ÏÉùÎûµÎê† Ïàò ÏûàÍ≥†, Îã§Ïàò Ï†ÑÎã¨ Í∞ÄÎä•(default Í∞í ÏÑ†Ïñ∏ Í∞ÄÎä•)

üí•Ï£ºÏùòÏÇ¨Ìï≠
function/triggerÎ•º ÌÜµÌï¥ ÏàòÏ†ïÏãú old valueÏôÄ new valueÎ•º Íµ¨Î∂ÑÌïòÏßÄ ÏïäÏúºÎ©¥
dml ÏàòÌñâ Î∂àÍ∞Ä(Í∞ôÏùÄ Îç∞Ïù¥ÌÑ∞Î•º Ïó¥Ïñ¥ÎëêÍ≥† ÏàòÏ†ïÌïòÎäî ÌñâÏúÑÏóê ÎåÄÌï¥ ÏóêÎü¨ Ï≤òÎ¶¨)

## syntax

```sql
-- define
create [or replace] function FUNCTION_NAME
	(input_value1		data_type	[:=value	|	default value]],
   input_value2		data_type	[:=value	|	default value]],
   ...
  )
  return data_type
is
	pl/sql block
	return Î≥ÄÏàòÎ™Ö
/

-- call
select function_name(input)
  from dual;  
```

## Tutorial

### case 1) create function

```sql
create or replace function get_today
return char
is
  result char(19);
  begin
    select to_char(sysdate, 'YYYY-MM-DD HH24:MI:SS')
      into result
      from dual;
      
    return result;
  end;
/

select object_name,
       object_type
  from user_procedures
 where object_type = 'FUNCTION';
desc get_today;

select get_today()
  from dual;
```

### case 2) ÏûÖÎ†•Î∞õÏùÄ Î∂ÄÏÑúÎ≤àÌò∏Ïóê Ìï¥ÎãπÌïòÎäî ÏµúÎåÄÍ∏âÏó¨Î•º Î∞òÌôò

```sql
create or replace function get_max_sal_by_department
(ideptno scott.emp.deptno%type)
return number
is
  max_sal scott.emp.sal%type;
  begin
    select max(sal) into max_sal
      from emp
     where deptno = ideptno;
    return max_sal;
  end;
/

select get_max_sal_by_department(10)
  from dual;
select ename, sal, deptno, get_max_sal_by_department(deptno)
  from emp
 where sal = get_max_sal_by_department(deptno);
```

### case 3) ÏûÖÎ†•Î∞õÏùÄ ÌïôÎ≤àÏóê Ìï¥ÎãπÌïòÎäî ÌïôÏ†ê Î∞òÌôò

```sql
create or replace function get_hakjum_by_studno
(istudno scott.student.studno%type)
return scott.hakjum.grade%type
is
	vhakjum	scott.hakjum.grade%type;
	begin
		select (select grade 
              from hakjum 
             where (select total 
                      from exam_01 
                     where studno = s.studno) between min_point
            																		  and max_point) 
		  into vhakjum
		  from student s
		 where s.studno = istudno;
		return vhakjum;
	end;
/

select object_name,
       object_type
  from user_procedures
 where 1=1
   and object_type = 'FUNCTION'
   and object_name like '%HAKJUM%';
desc get_hakjum_by_studno;
select get_hakjum_by_studno(9411)
  from dual;
```

### case 4) Í≥†Í∞ùÏù¥ Í∞ÄÏ†∏Í∞à Ïàò ÏûàÎäî ÏµúÎåÄ ÏÉÅÌíàÏùÑ Ï∂úÎ†•Ìï† Ïàò ÏûàÎäî Ìï®ÏàòÏûëÏÑ± ÌõÑ, Í≥†Í∞ù Ï°∞Ìöå(gogak, gift)

```sql
create or replace function get_max_gift
(igno scott.gogak.gno%type)
return varchar2
is
  gname scott.gift.gname%type;
  begin
    select gf.gname
      into gname
      from gogak gg, gift gf
     where gg.point between gf.g_start and gf.g_end
       and gg.gno = igno;
    return gname;
  end;
/
select g.*, get_max_gift(gno)
  from gogak g;
```

### case 5) Ï±ÑÎ≤à ÌîÑÎ°úÏÑ∏Ïä§

#### Ï±ÑÎ≤àÏùÑ ÏÇ¨Ïö©Ìï¥ÏïºÌïòÎäî ÌÖåÏä§Ìä∏ ÌÖåÏù¥Î∏î ÏÉùÏÑ±

```sql
create table scott.index_test1(
no number,
name varchar2(10),
addr varchar2(10),
time date default sysdate);
```

#### Ïù∏Îç±Ïä§ Ïú†Î¨¥Ïùò Ï∞®Ïù¥Î•º ÌôïÏù∏ÌïòÍ∏∞ ÏúÑÌïú DML

```sql
begin
	for i in 1..5000000
	loop
		insert into scott.index_test1 (no, name, addr)
		values (
    	round(DBMS_RANDOM.VALUE(1, 1000000000)),
      DBMS_RANDOM.STRING('P', 10),
      DBMS_RANDOM.STRING('U', 1)
    );
    commit;
	end loop;
end;
/
```

#### Ïù∏Îç±Ïä§ ÏÉùÏÑ± Ï†Ñ 

```sql
alter session set statistics_level=all;
select max(no) from index_test1;
select *
  from table(dbms_xplan.display_cursor(null, null, 'allstats last'));
--------------------------------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
| Id  | Operation          | Name        | Starts | E-Rows | A-Rows |   A-Time   | Buffers |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
--------------------------------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
|   0 | SELECT STATEMENT   |             |      1 |        |      1 |00:00:00.14 |   22863 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
|   1 |  SORT AGGREGATE    |             |      1 |      1 |      1 |00:00:00.14 |   22863 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
|   2 |   TABLE ACCESS FULL| INDEX_TEST1 |      1 |   1530K|   5000K|00:00:00.09 |   22863 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
--------------------------------------------------------------------------------------------  
```

#### Ïù∏Îç±Ïä§ ÏÉùÏÑ±

```sql
create index idx_index_test1_no on index_test1(no) parallel 8;
alter index idx_index_test1_no noparallel;
```

#### Ïù∏Îç±Ïä§ ÏÉùÏÑ± ÌõÑ

```sql
alter session set statistics_level=all;
select max(no) from index_test1;
select *
  from table(dbms_xplan.display_cursor(null, null, 'allstats last'));
--------------------------------------------------------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
| Id  | Operation                  | Name               | Starts | E-Rows | A-Rows |   A-Time   | Buffers | Reads  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
--------------------------------------------------------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
|   0 | SELECT STATEMENT           |                    |      1 |        |      1 |00:00:00.01 |       3 |      2 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
|   1 |  SORT AGGREGATE            |                    |      1 |      1 |      1 |00:00:00.01 |       3 |      2 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
|   2 |   INDEX FULL SCAN (MIN/MAX)| IDX_INDEX_TEST1_NO |      1 |      1 |      1 |00:00:00.01 |       3 |      2 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
--------------------------------------------------------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
```

#### Ìï®Ïàò ÏÉùÏÑ±

```sql
create or replace function f_next_key
(	tname					varchar2,
 	cname					varchar2)
return number
is
	next_val 			number;
	query         varchar2(100);
	begin
		query :=
    'select max('||cname||') + 1
       from '||tname;
		execute immediate query into next_val;		
		return next_val;
	end;
/
```

#### Ìï®Ïàò ÌôúÏö©

```sql
select f_next_key('index_test1', 'no') from dual; -- 999999646
insert into scott.index_test1 (no, name, addr)
		values (
    	f_next_key('index_test1', 'no'),
      DBMS_RANDOM.STRING('P', 10),
      DBMS_RANDOM.STRING('U', 1)
    );
commit;
select f_next_key('index_test1', 'no') from dual; -- 999999647
```

##### üí• pl/sql Ïã§ÌñâÏãú 00942 Ïò§Î•ò

ORA-00942: ÌÖåÏù¥Î∏î ÎòêÎäî Î∑∞Í∞Ä Ï°¥Ïû¨ÌïòÏßÄ ÏïäÏäµÎãàÎã§.
Ïã§ÌñâÌïòÎäî Í≥ÑÏ†ïÏù¥ pl/sql block ÎÇ¥Ïóê ÏûàÎäî Í∞ùÏ≤¥Ïóê ÎåÄÌïú ÏßÅÏ†ëÏ†Å Í∂åÌïúÏù¥ ÏóÜÏñ¥ÏÑú Î∞úÏÉù
Ïã§ÌñâÌïòÎäî Í≥ÑÏ†ïÏù¥ dba Í≥ÑÏ†ïÏùºÏßÄÎùºÎèÑ Îî∞Î°ú Í∂åÌïú Î∂ÄÏó¨ ÌïÑÏöî

```sql
‚úÖ 1. Ïù¥ÎØ∏ ÏÜåÏú†Ìïú ÌÖåÏù¥Î∏îÏùºÏßÄÎùºÎèÑ execute immediateÎ°ú Ï†ëÍ∑ºÏãú create any table Í∂åÌïú ÌïÑÏöî
ÎèôÏ†ÅÏøºÎ¶¨ ÏÇ¨Ïö©Ïãú, ÎÇ¥Î∂ÄÏ†ÅÏúºÎ°ú ÏûÑÏãú ÌÖåÏù¥Î∏îÏùÑ ÎßåÎì§Í∏∞ ÎïåÎ¨∏Ïóê ÌÖåÏù¥Î∏î ÏÉùÏÑ± Í∂åÌïúÏù¥ ÌïÑÏöîÌï† Í≤ÉÏúºÎ°ú Î≥¥Ïó¨Ïßê.
;
grant create any table to scott;

‚úÖ 2. Ïù¥ÎØ∏ dbaÍ∂åÌïúÏù¥ ÏûàÎçîÎùºÎèÑ, execute immediateÎ°ú Ï†ëÍ∑ºÏãú dbaÌÖåÏù¥Î∏î Ï°∞Ìöå Í∂åÌïú ÌïÑÏöî
;
grant select on dba_tab_columns to scott;
```

### case 6) converting long type

#### ‚ùì long

```sql
** long data type
ÎåÄÏö©Îüâ Î¨∏ÏûêÎ•º Ï†ÄÏû•ÌïòÍ∏∞ ÏúÑÌïú Îç∞Ïù¥ÌÑ∞ ÌÉÄÏûÖ
ÏùºÎ∞òÏ†ÅÏúºÎ°ú varchar ÏµúÎåÄ 4000 bytesÍπåÏßÄ Í∞ÄÎä•ÌïòÎØÄÎ°ú
Í∑∏ Ïù¥ÏÉÅÏùò Î¨∏ÏûêÏó¥ÏùÑ Îã¥Í∏∞ ÏúÑÌïú Îç∞Ïù¥ÌÑ∞ ÌÉÄÏûÖ
```

#### Î¨∏Ï†ú Î∞úÏÉù

```sql
select table_name,
       column_name,
       'test'||data_default
  from dba_tab_columns;    
    
create or replace function get_column_default_as_varchar
( p_table_name  varchar2, 
  p_column_name varchar2) 
return varchar2 
is 
  return_str    varchar2(32767); 
  sql_str       varchar2(32767); 
begin 
  sql_str:=
    'select data_default 
       from dba_tab_columns 
      where table_name=''' || p_table_name || ''' 
        and column_name=''' || p_column_name || ''''; 
  execute immediate sql_str into return_str; 
  return return_str; 
end;
/

select table_name,
       column_name,
       get_column_default_as_varchar('dba_tab_columns', 'data_default')
  from dba_tab_columns;
```

TODO: Ï°∞ÌöåÎêòÏßÄÏïäÏùå.

![image-20230811103351477](C:\Users\ITWILL\AppData\Roaming\Typora\typora-user-images\image-20230811103351477.png)
