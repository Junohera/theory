[toc]

# Function

input value와 output value의 관계를 정의하는 객체
input value는 생략될 수 있고, 다수 전달 가능(default 값 선언 가능)

💥주의사항
function/trigger를 통해 수정시 old value와 new value를 구분하지 않으면
dml 수행 불가(같은 데이터를 열어두고 수정하는 행위에 대해 에러 처리)

## syntax

```sql
-- define
create [or replace] function FUNCTION_NAME
	(input_value1		data_type	[:=value	|	default value]],
   input_value2		data_type	[:=value	|	default value]],
   ...
  )
  return data_type
is
	pl/sql block
	return 변수명
/

-- call
select function_name(input)
  from dual;  
```

## Tutorial

### case 1) create function

```sql
create or replace function get_today
return char
is
  result char(19);
  begin
    select to_char(sysdate, 'YYYY-MM-DD HH24:MI:SS')
      into result
      from dual;
      
    return result;
  end;
/

select object_name,
       object_type
  from user_procedures
 where object_type = 'FUNCTION';
desc get_today;

select get_today()
  from dual;
```

### case 2) 입력받은 부서번호에 해당하는 최대급여를 반환

```sql
create or replace function get_max_sal_by_department
(ideptno scott.emp.deptno%type)
return number
is
  max_sal scott.emp.sal%type;
  begin
    select max(sal) into max_sal
      from emp
     where deptno = ideptno;
    return max_sal;
  end;
/

select get_max_sal_by_department(10)
  from dual;
select ename, sal, deptno, get_max_sal_by_department(deptno)
  from emp
 where sal = get_max_sal_by_department(deptno);
```

### case 3) 입력받은 학번에 해당하는 학점 반환

```sql
create or replace function get_hakjum_by_studno
(istudno scott.student.studno%type)
return scott.hakjum.grade%type
is
	vhakjum	scott.hakjum.grade%type;
	begin
		select (select grade 
              from hakjum 
             where (select total 
                      from exam_01 
                     where studno = s.studno) between min_point
            																		  and max_point) 
		  into vhakjum
		  from student s
		 where s.studno = istudno;
		return vhakjum;
	end;
/

select object_name,
       object_type
  from user_procedures
 where 1=1
   and object_type = 'FUNCTION'
   and object_name like '%HAKJUM%';
desc get_hakjum_by_studno;
select get_hakjum_by_studno(9411)
  from dual;
```

### case 4) 고객이 가져갈 수 있는 최대 상품을 출력할 수 있는 함수작성 후, 고객 조회(gogak, gift)

```sql
create or replace function get_max_gift
(igno scott.gogak.gno%type)
return varchar2
is
  gname scott.gift.gname%type;
  begin
    select gf.gname
      into gname
      from gogak gg, gift gf
     where gg.point between gf.g_start and gf.g_end
       and gg.gno = igno;
    return gname;
  end;
/
select g.*, get_max_gift(gno)
  from gogak g;
```

### case 5) 채번 프로세스

#### 채번을 사용해야하는 테스트 테이블 생성

```sql
create table scott.index_test1(
no number,
name varchar2(10),
addr varchar2(10),
time date default sysdate);
```

#### 인덱스 유무의 차이를 확인하기 위한 DML

```sql
begin
	for i in 1..5000000
	loop
		insert into scott.index_test1 (no, name, addr)
		values (
    	round(DBMS_RANDOM.VALUE(1, 1000000000)),
      DBMS_RANDOM.STRING('P', 10),
      DBMS_RANDOM.STRING('U', 1)
    );
    commit;
	end loop;
end;
/
```

#### 인덱스 생성 전 

```sql
alter session set statistics_level=all;
select max(no) from index_test1;
select *
  from table(dbms_xplan.display_cursor(null, null, 'allstats last'));
--------------------------------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
| Id  | Operation          | Name        | Starts | E-Rows | A-Rows |   A-Time   | Buffers |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
--------------------------------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
|   0 | SELECT STATEMENT   |             |      1 |        |      1 |00:00:00.14 |   22863 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
|   1 |  SORT AGGREGATE    |             |      1 |      1 |      1 |00:00:00.14 |   22863 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
|   2 |   TABLE ACCESS FULL| INDEX_TEST1 |      1 |   1530K|   5000K|00:00:00.09 |   22863 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
--------------------------------------------------------------------------------------------  
```

#### 인덱스 생성

```sql
create index idx_index_test1_no on index_test1(no) parallel 8;
alter index idx_index_test1_no noparallel;
```

#### 인덱스 생성 후

```sql
alter session set statistics_level=all;
select max(no) from index_test1;
select *
  from table(dbms_xplan.display_cursor(null, null, 'allstats last'));
--------------------------------------------------------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
| Id  | Operation                  | Name               | Starts | E-Rows | A-Rows |   A-Time   | Buffers | Reads  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
--------------------------------------------------------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
|   0 | SELECT STATEMENT           |                    |      1 |        |      1 |00:00:00.01 |       3 |      2 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
|   1 |  SORT AGGREGATE            |                    |      1 |      1 |      1 |00:00:00.01 |       3 |      2 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
|   2 |   INDEX FULL SCAN (MIN/MAX)| IDX_INDEX_TEST1_NO |      1 |      1 |      1 |00:00:00.01 |       3 |      2 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
--------------------------------------------------------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
```

#### 함수 생성

```sql
create or replace function f_next_key
(	tname					varchar2,
 	cname					varchar2)
return number
is
	next_val 			number;
	query         varchar2(100);
	begin
		query :=
    'select max('||cname||') + 1
       from '||tname;
		execute immediate query into next_val;		
		return next_val;
	end;
/
```

#### 함수 활용

```sql
select f_next_key('index_test1', 'no') from dual; -- 999999646
insert into scott.index_test1 (no, name, addr)
		values (
    	f_next_key('index_test1', 'no'),
      DBMS_RANDOM.STRING('P', 10),
      DBMS_RANDOM.STRING('U', 1)
    );
commit;
select f_next_key('index_test1', 'no') from dual; -- 999999647
```

##### 💥 pl/sql 실행시 00942 오류

ORA-00942: 테이블 또는 뷰가 존재하지 않습니다.
실행하는 계정이 pl/sql block 내에 있는 객체에 대한 직접적 권한이 없어서 발생
실행하는 계정이 dba 계정일지라도 따로 권한 부여 필요

```sql
✅ 1. 이미 소유한 테이블일지라도 execute immediate로 접근시 create any table 권한 필요
동적쿼리 사용시, 내부적으로 임시 테이블을 만들기 때문에 테이블 생성 권한이 필요할 것으로 보여짐.
;
grant create any table to scott;

✅ 2. 이미 dba권한이 있더라도, execute immediate로 접근시 dba테이블 조회 권한 필요
;
grant select on dba_tab_columns to scott;
```

### case 6) converting long type

#### ❓ long

```sql
** long data type
대용량 문자를 저장하기 위한 데이터 타입
일반적으로 varchar 최대 4000 bytes까지 가능하므로
그 이상의 문자열을 담기 위한 데이터 타입
```

#### 문제 발생

```sql
select table_name,
       column_name,
       'test'||data_default
  from dba_tab_columns;    
    
create or replace function get_column_default_as_varchar
( p_table_name  varchar2, 
  p_column_name varchar2) 
return varchar2 
is 
  return_str    varchar2(32767); 
  sql_str       varchar2(32767); 
begin 
  sql_str:=
    'select data_default 
       from dba_tab_columns 
      where table_name=''' || p_table_name || ''' 
        and column_name=''' || p_column_name || ''''; 
  execute immediate sql_str into return_str; 
  return return_str; 
end;
/

select table_name,
       column_name,
       get_column_default_as_varchar('dba_tab_columns', 'data_default')
  from dba_tab_columns;
```

TODO: 조회되지않음.

![image-20230811103351477](C:\Users\ITWILL\AppData\Roaming\Typora\typora-user-images\image-20230811103351477.png)
