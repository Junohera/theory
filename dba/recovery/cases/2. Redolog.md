[toc]

# Redolog

## ë°©í–¥

| case | ë‹¨ìœ„        | REDOìƒíƒœ | ARCHIVE              | DBìƒíƒœ | ë°©ë²•                                                         |
| ---: | ----------- | -------- | -------------------- | ------ | ------------------------------------------------------------ |
|    1 | MEMBER      | !CURRENT |                      | OPEN   | DROP                                                         |
|    2 | MEMBER      | CURRENT  |                      | OPEN   | LOGSWITCH -> DROP                                            |
|    3 | GROUP       | !CURRENT |                      | OPEN   | CLEAR                                                        |
|    4 | GROUP       | CURRENT  |                      | OPEN   | RECOVERY                                                     |
|    5 | GROUP       | !CURRENT | NO(cause abort)      | CLOSE  | DROP -> RECOVERY                                             |
|    6 | GROUP       | CURRENT  | YES(cause immediate) | CLOSE  | DROP âŒ<br />CLEAR                                            |
|    7 | GROUP       | CURRENT  | NO                   | ABORT  | DROP âŒ<br />CLEAR âŒ<br />COMPLETE RECOVER âŒ<br />INCOMPLETE RECOVER âœ…<br />(until cancel) |
|    8 | EVERY GROUP | ALL      | YES                  | OPEN   | DROP âŒ<br />CLEAR âœ…                                          |

## ì£¼ìš” ì¿¼ë¦¬

```sql
SQL> col member format a30;
SQL> select * from v$logfile;

SQL> col group# format 9999999
SQL> col member format a50
SQL> select group#, member from v$logfile;

-- v$logfile: ë¡œê·¸ íŒŒì¼ ì •ë³´, v$log: ë¡œê·¸ ìƒì„¸ ì •ë³´
select a.group#
     , a.member
     , b.bytes/1024/1024 mb
     , b.sequence# "seq#"
     , b.status
     , b.archived arc
  from v$logfile a
     , v$log b
 where a.group# = b.group#
 order by 1, 2;
 
-- clear
alter database clear unarchived logfile group 1;
```

## case

### 1. normal member ì‚­ì œ

ê° ê·¸ë£¹ì— ë‘ê°œ ì´ìƒì˜ memberê°€ ìˆëŠ” ìƒíƒœì—ì„œ memberí•˜ë‚˜ì— ì†ìƒ ë°œìƒ

í•´ê²°. ë©¤ë²„ë¥¼ ì‚­ì œ í›„ ì¬ìƒì„±(online)

```sql
[ ì‹¤ìŠµí™˜ê²½ êµ¬ì„± ]
1. í˜„ì¬ ë¦¬ë‘ë¡œê·¸ êµ¬ì„± í™•ì¸
select a.group#
     , a.member
     , b.bytes/1024/1024 mb
     , b.sequence# "seq#"
     , b.status
     , b.archived arc
  from v$logfile a
     , v$log b
 where a.group# = b.group#
 order by 1, 2;
 
2. ë©¤ë²„ ì¶”ê°€
alter database add logfile member
			'/oracle12/app/oracle/oradata/db1/redo01_2.log' to group 1,
			'/oracle12/app/oracle/oradata/db1/redo02_2.log' to group 2,
			'/oracle12/app/oracle/oradata/db1/redo03_2.log' to group 3;
			
3. ì¥ì•  ë°œìƒ
inactiveì´ë©´ì„œ, arc YESì¸ ê·¸ë£¹ ì¤‘ 2ë²ˆ ë©¤ë²„ë¥¼ ë¬¼ë¦¬ì ìœ¼ë¡œ í•˜ë‚˜ ì‚­ì œ
(ì–´ì°¨í”¼ default ë©¤ë²„ëŠ” ì‚­ì œ ë¶ˆê°€)
rm /oracle12/app/oracle/oradata/db1/redo01_2.log

4. log switch
ì‚­ì œí•œ ë©¤ë²„ì˜ ê·¸ë£¹ì´ currentê°€ ë  ë•Œê¹Œì§€ ì§„í–‰
alter system switch logfile;
=> âœ¨logswitchê°€ ë°œìƒí•˜ë©´ì„œ alert logì— í•´ë‹¹ íŒŒì¼ì´ ì—†ìŒ ê¸°ë¡ë˜ì§€ë§Œ DBìš´ì˜ì— ë¬¸ì œê°€ ì—†ê³ , ì¥ì• ë‚œ groupì´ currentê°€ ë˜ëŠ”ê²ƒë„ ë¬¸ì œì—†ìŒ

-- alert
Errors in file /oracle12/app/oracle/diag/rdbms/db1/db1/trace/db1_lgwr_7484.trc:
ORA-00313: open failed for members of log group 1 of thread 1
ORA-00312: online log 1 thread 1: '/oracle12/app/oracle/oradata/db1/redo01_2.log'
ORA-27037: unable to obtain file status
Linux-x86_64 Error: 2: No such file or directory
Additional information: 7

5. ë¬¼ë¦¬ì ìœ¼ë¡œ ì‚­ì œëœ ë©¤ë²„ë¥¼ ë…¼ë¦¬ì ìœ¼ë¡œ ì‚­ì œí•˜ì—¬ ë³µêµ¬
alter database drop logfile member '/oracle12/app/oracle/oradata/db1/redo01_2.log';

-- alert
ORA-01609: log 1 is the current log for thread 1 - cannot drop members
ORA-00312: online log 1 thread 1: '/oracle12/app/oracle/oradata/db1/redo01.log'
ORA-00312: online log 1 thread 1: '/oracle12/app/oracle/oradata/db1/redo01_2.log'

=> current ìƒíƒœì¸ ê·¸ë£¹ì˜ ë©¤ë²„ë¥¼ ì‚­ì œí•˜ëŠ” ê²ƒì€ ë¶ˆê°€ëŠ¥
		=> logswitch í›„, ì‚­ì œ ì¬ì‹œë„
		
6. ë¬¼ë¦¬ì , ë…¼ë¦¬ì ìœ¼ë¡œ ì‚­ì œëœ ë©¤ë²„ë¥¼ ë‹¤ì‹œ ë³µêµ¬
alter database add logfile member '/oracle12/app/oracle/oradata/db1/redo01_2.log' to group 1;
```

### 2. default member ì‚­ì œ

> ë²„ì „ì— ë”°ë¼ default member ì‚­ì œê°€ ë¶ˆê°€ëŠ¥í•  ìˆ˜ë„ ìˆì§€ë§Œ,
> í˜„ì¬ ì‹¤ìŠµí•˜ëŠ” í™˜ê²½ì—ì„œëŠ” ì •ìƒì ìœ¼ë¡œ ìˆ˜í–‰ë˜ì–´ default ë©¤ë²„ì™€ not default ë©¤ë²„ê°€ ë¬¼ë¦¬ì ìœ¼ë¡œ ì‚­ì œëœ ì¼€ì´ìŠ¤ëŠ” ë™ì¼í•˜ê²Œ í•´ê²°í•˜ë©´ ë¨.

```sql
[ ì‹¤ìŠµí™˜ê²½ êµ¬ì„± ]
1. í˜„ì¬ ë¦¬ë‘ë¡œê·¸ êµ¬ì„± í™•ì¸
select a.group#
     , a.member
     , b.bytes/1024/1024 mb
     , b.sequence# "seq#"
     , b.status
     , b.archived arc
  from v$logfile a
     , v$log b
 where a.group# = b.group#
 order by 1, 2;
 
2. ë©¤ë²„ ì¶”ê°€
alter database add logfile member
			'/oracle12/app/oracle/oradata/db1/redo01_2.log' to group 1,
			'/oracle12/app/oracle/oradata/db1/redo02_2.log' to group 2,
			'/oracle12/app/oracle/oradata/db1/redo03_2.log' to group 3;
			
3. ì¥ì•  ë°œìƒ
inactiveì´ë©´ì„œ, arc YESì¸ ê·¸ë£¹ ì¤‘ 1ë²ˆ ë©¤ë²„ë¥¼ ë¬¼ë¦¬ì ìœ¼ë¡œ í•˜ë‚˜ ì‚­ì œ
(ì–´ì°¨í”¼ default ë©¤ë²„ëŠ” ì‚­ì œ ë¶ˆê°€)
rm /oracle12/app/oracle/oradata/db1/redo01.log

4. log switch
ì‚­ì œí•œ ë©¤ë²„ì˜ ê·¸ë£¹ì´ currentê°€ ë  ë•Œê¹Œì§€ ì§„í–‰
alter system switch logfile;
=> âœ¨logswitchê°€ ë°œìƒí•˜ë©´ì„œ alert logì— í•´ë‹¹ íŒŒì¼ì´ ì—†ìŒ ê¸°ë¡ë˜ì§€ë§Œ DBìš´ì˜ì— ë¬¸ì œê°€ ì—†ê³ , ì¥ì• ë‚œ groupì´ currentê°€ ë˜ëŠ”ê²ƒë„ ë¬¸ì œì—†ìŒ

5. ë¬¼ë¦¬ì ìœ¼ë¡œ ì‚­ì œëœ ë©¤ë²„ë¥¼ ë…¼ë¦¬ì ìœ¼ë¡œ ì‚­ì œ ì‹œë„
alter database drop logfile member '/oracle12/app/oracle/oradata/db1/redo01.log';

log 1 is the current log for thread 1 - cannot drop members
ORA-00312: online log 1 thread 1: '/oracle12/app/oracle/oradata/db1/redo01.log'
ORA-00312: online log 1 thread 1: '/oracle12/app/oracle/oradata/db1/redo01_2.log'

=> current ìƒíƒœì¸ ê·¸ë£¹ì˜ ë©¤ë²„ë¥¼ ì‚­ì œí•˜ëŠ” ê²ƒì€ ë¶ˆê°€ëŠ¥í•˜ê³ , default member ì‚­ì œë„ ë¶ˆê°€ëŠ¥ ?
		=> logswitch í›„, ì‚­ì œ ì¬ì‹œë„
```

### 3. currentê°€ ì•„ë‹Œ ê·¸ë£¹ì´ ì‚­ì œëœ í›„, DB ì¢…ë£Œëœ ê²½ìš°(DBê°€ ì •ìƒ open ë˜ì§€ ì•ŠëŠ” í˜„ìƒ)



```sql
[ ì‹¤ìŠµí™˜ê²½ êµ¬ì„± ]
1. í˜„ì¬ ë¦¬ë‘ë¡œê·¸ êµ¬ì„± í™•ì¸
select a.group#
     , a.member
     , b.bytes/1024/1024 mb
     , b.sequence# "seq#"
     , b.status
     , b.archived arc
  from v$logfile a
     , v$log b
 where a.group# = b.group#
 order by 1, 2;
 
 alter system checkpoint; -- activeìƒíƒœë¥¼ inactive ìƒíƒœë¡œ ë§Œë“¤ê¸° ìœ„í•´ ê°•ì œ ì²´í¬í¬ì¸íŠ¸ ë°œìƒ
 
2. ê·¸ë£¹ì„ êµ¬ì„±í•˜ëŠ” ë¡œê·¸íŒŒì¼ ë¬¼ë¦¬ì  ì‚­ì œ
(currentê°€ ì•„ë‹ˆë©´ì„œ archive ì™„ë£Œëœ ê·¸ë£¹)
rm /oracle12/app/oracle/oradata/db1/redo01*

3. DB shutdown immediate
SQL> shutdown immediate;

=>
		ì´ë¯¸ checkpointê°€ ì™„ë£Œëœ ê·¸ë£¹ì˜ ë¬¼ë¦¬ì  ì†ìƒì€ global checkpointì— ë°©í•´ê°€ ë˜ì§€ ì•Šìœ¼ë¯€ë¡œ immediate ì¢…ë£Œ ê°€ëŠ¥
		(ì´ë¯¸ archiveë¡œ ë‚´ë ¤ì¡Œìœ¼ë¯€ë¡œ)
		
4. startup
mountê¹Œì§€ëŠ” ë˜ê³ , redo infoì˜ ì—ëŸ¬ë¡œ ì¸í•´ ê°•ì œ close
(closed => nomount => mount => closed)
í•˜ê¸° ì´ë¯¸ì§€ ì°¸ê³ 

Database mounted.
ORA-03113: end-of-file on communication channel => ê°•ì œ ì¢…ë£Œ(closed ìƒíƒœ)
Process ID: 12993
Session ID: 1 Serial number: 14952

```

<img src="./assets/image-20230721114447979.png" alt="image-20230721114447979" style="zoom:50%;" />

```sql
ìœ„ì—ì„œì˜ startupì„ í†µí•´ 
mount ê³¼ì • ì´í›„ì—ì„œ ê°•ì œ ì¢…ë£Œëœ ì‚¬ì‹¤ì„ ì•Œê²Œë˜ì—ˆìœ¼ë¯€ë¡œ

startup mount í›„, 
datafile infoì™€ redo infoë“±ì„ ì¡°íšŒí•˜ì—¬ ë¹„êµí•´ë³¸ë‹¤.

--- âœ´ ì°¸ê³  
** ë¬¸ì œì  íŒŒì•… ë°©ë²•
1. alert log
	2023-07-21T11:49:48.433413+09:00
  Errors in file /oracle12/app/oracle/diag/rdbms/db1/db1/trace/db1_lgwr_13394.trc:
  ORA-00313: open failed for members of log group 1 of thread 1
  ORA-00312: online log 1 thread 1: '/oracle12/app/oracle/oradata/db1/redo01_2.log'
  ORA-27037: unable to obtain file status
  Linux-x86_64 Error: 2: No such file or directory
  Additional information: 7
  2023-07-21T11:49:48.433525+09:00
  Errors in file /oracle12/app/oracle/diag/rdbms/db1/db1/trace/db1_lgwr_13394.trc:
  ORA-00313: open failed for members of log group 1 of thread 1
  ORA-00312: online log 1 thread 1: '/oracle12/app/oracle/oradata/db1/redo01_2.log'
  ORA-27037: unable to obtain file status
  Linux-x86_64 Error: 2: No such file or directory
2. ì§„í–‰ìƒí™©ë³„ ëŒ€ìƒ í™•ì¸
	- mount
		- datafile
			TODO:
		- redo
			SQL> col member format a30;
			SQL> select * from v$logfile;
---

5. ë¬¸ì œ í™•ì¸
SQL> startup mount;
SQL> col group# format 9999999
SQL> col member format a50
SQL> select group#, member from v$logfile;

  GROUP# MEMBER
-------- --------------------------------------------------
       1 /oracle12/app/oracle/oradata/db1/redo01.log
       3 /oracle12/app/oracle/oradata/db1/redo03.log
       2 /oracle12/app/oracle/oradata/db1/redo02.log
       1 /oracle12/app/oracle/oradata/db1/redo01_2.log
       2 /oracle12/app/oracle/oradata/db1/redo02_2.log
       3 /oracle12/app/oracle/oradata/db1/redo03_2.log
       

!ls /oracle12/app/oracle/oradata/db1/redo01.log
!ls /oracle12/app/oracle/oradata/db1/redo03.log
!ls /oracle12/app/oracle/oradata/db1/redo02.log
!ls /oracle12/app/oracle/oradata/db1/redo01_2.log
!ls /oracle12/app/oracle/oradata/db1/redo02_2.log
!ls /oracle12/app/oracle/oradata/db1/redo03_2.log

=> No such file or directoryì¸ íŒŒì¼ í™•ì¸
ls: cannot access /oracle12/app/oracle/oradata/db1/redo01.log: No such file or directory
ls: cannot access /oracle12/app/oracle/oradata/db1/redo01_2.log: No such file or directory


6. ì‚­ì œëœ íŒŒì¼ë“¤ì˜ ìƒíƒœ í™•ì¸
SQL> select a.group#, a.member, b.status, b.archived arc from v$logfile a, v$log b where a.group# = b.group# and a.member in ('/oracle12/app/oracle/oradata/db1/redo01.log', '/oracle12/app/oracle/oradata/db1/redo01_2.log') order by 1, 2;

  GROUP# MEMBER                                             STATUS           ARC
-------- -------------------------------------------------- ---------------- ---
       1 /oracle12/app/oracle/oradata/db1/redo01.log        INACTIVE         YES
       1 /oracle12/app/oracle/oradata/db1/redo01_2.log      INACTIVE         YES

=> ë§Œì•½ INACTIVEì´ë©´ì„œ ARCì—¬ë¶€ê°€ YES í™•ì¸ë˜ì—ˆë‹¤ë©´ ë‹¨ìˆœíˆ ê·¸ë£¹ì„ ì¬ìƒì„±í•˜ê±°ë‚˜ ë©¤ë²„ë¥¼ ì‚­ì œí•˜ë„ë¡ ì¡°ì¹˜

7. ê·¸ë£¹ ì‚­ì œ ë° ì¶”ê°€
ğŸ’¥ ë§Œì•½ INACTIVEì´ë©´ì„œ ARCê°€ YESê°€ ì•„ë‹Œ ìƒíƒœì—ì„œ ì‚­ì œí•˜ë©´ ì•ˆë¨!!!
SQL> alter database drop logfile group 1;
SQL> alter database add logfile group 1 ('/oracle12/app/oracle/oradata/db1/redo01.log', '/oracle12/app/oracle/oradata/db1/redo01_2.log') size 200M;
SQL> select group#, member from v$logfile;

  GROUP# MEMBER
-------- --------------------------------------------------
       1 /oracle12/app/oracle/oradata/db1/redo01.log
       3 /oracle12/app/oracle/oradata/db1/redo03.log
       2 /oracle12/app/oracle/oradata/db1/redo02.log
       1 /oracle12/app/oracle/oradata/db1/redo01_2.log
       2 /oracle12/app/oracle/oradata/db1/redo02_2.log
       3 /oracle12/app/oracle/oradata/db1/redo03_2.log

8. open
SQL> alter database open
SQL> select instance_name, status from v$instance;

INSTANCE_NAME    STATUS
---------------- ------------
db1              OPEN
```

### 4. currentê°€ ì•„ë‹Œ ê·¸ë£¹ì´ ì‚­ì œëœ í›„, DBê°€ ì˜¤í”ˆì¸ ìƒíƒœ

> currentê°€ ì•„ë‹Œ ê·¸ë£¹ì´ ì‚­ì œëœ í›„ DBê°€ openì¸ìƒíƒœ
>
> ê³„ì† ìš´ì˜ì¤‘ => ê³„ì†ëœ logswitch ë°œìƒ => DB hang
>
> 1. log switchë¥¼ íŠ¸ë¦¬ê±°í•˜ê³ ìˆëŠ” DMLì„ kill
> 2. archive log dest ì ì‹œ ì¤‘ë‹¨

```sql
alter system switch logfile;
alter system checkpoint;

-- 1. í˜„ì¬ ìƒíƒœ í™•ì¸
select a.group#
     , a.member
     , b.bytes/1024/1024 mb
     , b.sequence# "seq#"
     , b.status
     , b.archived arc
  from v$logfile a
     , v$log b
 where a.group# = b.group#
 order by 1, 2;
 
-- 2. ë¬¼ë¦¬ì ìœ¼ë¡œ ë¦¬ë‘ë¡œê·¸ ê·¸ë£¹ ì‚­ì œ
		INACTIVE, YESì¸ ê·¸ë£¹ ì‚­ì œ
rm /oracle12/app/oracle/oradata/db1/redo01*

-- 3. logswitch ì‹œë„ until DBhang with tail -f alert
SQL> alter system switch logfile;

-- 4. ê²°ê³¼ í™•ì¸
3ë²ˆ ì‹œì ë¶€í„° ëª¨ë“  redoì˜ archiveê°€ ë–¨ì–´ì§€ì§€ ì•Šê³ ,
log switchê°€ ë”ì´ìƒ ì§„í–‰ë˜ì§€ ì•Šì•„, ì¶”ê°€ë˜ëŠ” DMLì€ ì•„ì˜ˆ ë°›ì•„ì“°ê¸°ê°€ ë¶ˆê°€ëŠ¥í•œ ìƒíƒœ
=>
DB ì¥ì• 

---
âœ… ìƒì„¸ ì›ì¸ ê·œëª…
1ë²ˆ ê·¸ë£¹ ì†ìƒ í›„, ë¡œê·¸ìŠ¤ìœ„ì¹˜ê°€ ë°œìƒí•˜ë©´ 1ë²ˆ ê·¸ë£¹ ë¡œê·¸íŒŒì¼ë¡œë¶€í„° ì•„ì¹´ì´ë¸Œ ìƒì„± ì‹œë„
-> ì—ëŸ¬ ë°œìƒ(ì•„ì¹´ì´ë¹™ ë¶ˆê°€)ğŸ’¥
ì´í›„ ë°˜ë³µë˜ëŠ” ë¡œê·¸ìŠ¤ìœ„ì¹˜ë¡œ ì¸í•´ 2ë²ˆ ê·¸ë£¹ê³¼ 3ë²ˆ ê·¸ë£¹ê¹Œì§€ ì—°ì‡„ì ìœ¼ë¡œ ì•„ì¹´ì´ë¹™ ë¶ˆê°€ğŸ’¥
ì¥ì• ë‚œ ê·¸ë£¹ìœ¼ë¡œ ë‹¤ì‹œ current ëŒì…í•  ë–„, ì•„ì¹´ì´ë¹™ì´ ì™„ë£Œë˜ì§€ ì•Šì•˜ìœ¼ë¯€ë¡œ ë¡œê·¸ìŠ¤ìœ„ì¹˜ ë¶ˆê°€ğŸ’¥
(ì´ë•Œë¶€í„° ì–´ë– í•œ ëª¨ë“  dml ìˆ˜í–‰ ë¶ˆê°€ğŸ’¥)


-- ìƒíƒœí™•ì¸ ì¿¼ë¦¬(ARCê°€ ì „ì› NO)
|GROUP#|MEMBER                                       |MB |seq#|STATUS  |ARC  |
|------|---------------------------------------------|---|----|--------|-----|
|1     |/oracle12/app/oracle/oradata/db1/redo01.log  |200|42  |INACTIVE|NOğŸ’¥ |
|1     |/oracle12/app/oracle/oradata/db1/redo01_2.log|200|42  |INACTIVE|NOğŸ’¥ |
|2     |/oracle12/app/oracle/oradata/db1/redo02.log  |200|44  |CURRENT |NOğŸ’¥ |
|2     |/oracle12/app/oracle/oradata/db1/redo02_2.log|200|44  |CURRENT |NOğŸ’¥ |
|3     |/oracle12/app/oracle/oradata/db1/redo03.log  |200|43  |INACTIVE|NOğŸ’¥ |
|3     |/oracle12/app/oracle/oradata/db1/redo03_2.log|200|43  |INACTIVE|NOğŸ’¥ |

-- alert ë¡œê·¸ í™•ì¸
2023-07-21T12:28:25.537689+09:00
ORACLE Instance db1 - Cannot allocate log, archival required ğŸ’¥
2023-07-21T12:28:25.537873+09:00
Thread 1 cannot allocate new log, sequence 45 ğŸ’¥
All online logs need archiving
Examine archive trace files for archiving errors
Current log# 2 seq# 44 mem# 0: /oracle12/app/oracle/oradata/db1/redo02.log
Current log# 2 seq# 44 mem# 1: /oracle12/app/oracle/oradata/db1/redo02_2.log

ğŸ’Š ë³µêµ¬
-- 1. ì¥ì• ë‚œ ê·¸ë£¹ ì‚­ì œ(controlfile ì •ë³´ ì‚­ì œ)
=> ì•„ì¹´ì´ë¸Œ ì™„ë£Œë˜ì§€ ì•Šì€ ê·¸ë£¹ ì‚­ì œ ë¶ˆê°€
SQL> alter database drop logfile group 1;
ORA-00350: log 1 of instance db1 (thread 1) needs to be archivedğŸ’¥

-- 2. redo clear
âœ… redoë¥¼ ì •ìƒì ìœ¼ë¡œ ì‚­ì œí•  ìˆ˜ ì—†ì„ ê²½ìš° í•´ë‹¹ ì •ë³´ë¥¼ clear ì‹œì¼œì„œ ë”ì´ìƒ archiveë¥¼ ì‹œë„í•˜ì§€ ì•Šë„ë¡ ì¡°ì¹˜
=> ë°ì´í„° ì†ì‹¤ì„ ë– ì•ˆê³  í•˜ëŠ” í–‰ìœ„ì´ë¯€ë¡œ ğŸ‘‰ğŸ»ë°˜ë“œì‹œ ì‚¬í›„ì— fullbackup ì§„í–‰
alter database clear unarchived logfile group 1;

ì´í›„, 
1. arcê°€ ì •ìƒì ìœ¼ë¡œ YESë¡œ ë˜ê³ , UNUSED
		|GROUP#|MEMBER                                       |MB |seq#|STATUS  |ARC|
    |------|---------------------------------------------|---|----|--------|---|
    |1     |/oracle12/app/oracle/oradata/db1/redo01.log  |200|0   |UNUSED  |YES|
    |1     |/oracle12/app/oracle/oradata/db1/redo01_2.log|200|0   |UNUSED  |YES|
    |2     |/oracle12/app/oracle/oradata/db1/redo02.log  |200|44  |CURRENT |NO |
    |2     |/oracle12/app/oracle/oradata/db1/redo02_2.log|200|44  |CURRENT |NO |
    |3     |/oracle12/app/oracle/oradata/db1/redo03.log  |200|43  |INACTIVE|YES|
    |3     |/oracle12/app/oracle/oradata/db1/redo03_2.log|200|43  |INACTIVE|YES|
2. ì†ìƒëœ redoê·¸ë£¹ì˜ ë¬¼ë¦¬ì  íŒŒì¼ ìƒì„±
		(ì•„ë§ˆ `> /oracle12/app/oracle/oradata/db1/redo01.log`ì˜ ì´ˆê¸°í™”í•˜ëŠ” êµ¬ë¬¸ì´ ë‚´ë¶€ì ìœ¼ë¡œ ì¡´ì¬í•˜ëŠ”ë“¯)
		SQL> !ls /oracle12/app/oracle/oradata/db1/redo01.log
		/oracle12/app/oracle/oradata/db1/redo01.log
```

![image-20230721140557900](./assets/image-20230721140557900.png)

### 5. currentê°€ ì•„ë‹Œ ê·¸ë£¹ì´ ì‚­ì œëœ í›„, í•´ë‹¹ ê·¸ë£¹ì´ archiveë˜ì§€ ì•Šì€ ìƒíƒœ

```sql
ì‚¬ì „ ì¤€ë¹„
3ë²ˆ ê·¸ë£¹ current, ë‚˜ë¨¸ì§€ inactive, arc YES ìƒíƒœë¡œ
alter system switch logfile;
alter system checkpoint;
 
 |GROUP#|MEMBER                                       |MB |seq#|STATUS  |ARC|
|------|---------------------------------------------|---|----|--------|---|
|1     |/oracle12/app/oracle/oradata/db1/redo01.log  |200|45  |INACTIVE|YES|
|1     |/oracle12/app/oracle/oradata/db1/redo01_2.log|200|45  |INACTIVE|YES|
|2     |/oracle12/app/oracle/oradata/db1/redo02.log  |200|44  |INACTIVE|YES|
|2     |/oracle12/app/oracle/oradata/db1/redo02_2.log|200|44  |INACTIVE|YES|
|3     |/oracle12/app/oracle/oradata/db1/redo03.log  |200|46  |CURRENT |NO |
|3     |/oracle12/app/oracle/oradata/db1/redo03_2.log|200|46  |CURRENT |NO |
```



```sql
1. í˜„í™© ì¡°íšŒ
select a.group#
     , a.member
     , b.bytes/1024/1024 mb
     , b.sequence# "seq#"
     , b.status
     , b.archived arc
  from v$logfile a
     , v$log b
 where a.group# = b.group#
 order by 1, 2;
 
2. archiveê°€ ì™„ë£Œëœ inactive ê·¸ë£¹ ì‚­ì œ
rm /oracle12/app/oracle/oradata/db1/redo01*

3. logswitch
alter system switch logfile;
=> hang ë°œìƒ(ìƒˆë¡œìš´ ì¼ë°˜ ì„¸ì…˜ ì ‘ì† ë¶ˆê°€í•  ìˆ˜ ìˆìŒ.  sys ê³„ì •ë§Œ ì ‘ì† ê°€ëŠ¥)

4. shutdown abort


---
ë³µêµ¬

1. startup mount

SQL> @log_check.sql

  G MEMBER                                                MB seq# STATUS   ARC
--- -------------------------------------------------- ----- ---- -------- ---
  1 /oracle12/app/oracle/oradata/db1/redo01.log          200   54 INACTIVE NO
  1 /oracle12/app/oracle/oradata/db1/redo01_2.log        200   54 INACTIVE NO
  2 /oracle12/app/oracle/oradata/db1/redo02.log          200   56 CURRENT  NO
  2 /oracle12/app/oracle/oradata/db1/redo02_2.log        200   56 CURRENT  NO
  3 /oracle12/app/oracle/oradata/db1/redo03.log          200   55 INACTIVE NO
  3 /oracle12/app/oracle/oradata/db1/redo03_2.log        200   55 INACTIVE NO

2. startup mount

3. drop ì‹œë„
alter database drop logfile group 1
ORA-00350: log 1 of instance db1 (thread 1) needs to be archived

4. clear ì‹œë„
SQL> alter database clear unarchived logfile group 1;

SQL> !ls /oracle12/app/oracle/oradata/db1/redo01*

5. open
```

### 6. currentì¸ ê·¸ë£¹ì´ ì‚­ì œëœ í›„, ë³µêµ¬

```sql
ì‚¬ì „ ì¤€ë¹„
1. 1ë²ˆ ê·¸ë£¹ current, ë‚˜ë¨¸ì§€ inactive, arc YES ìƒíƒœë¡œ
alter system switch logfile;
alter system checkpoint;
 
|GROUP#|MEMBER                                       |MB |seq#|STATUS  |ARC|
|------|---------------------------------------------|---|----|--------|---|
|1     |/oracle12/app/oracle/oradata/db1/redo01.log  |200|57  |CURRENT |NO |
|1     |/oracle12/app/oracle/oradata/db1/redo01_2.log|200|57  |CURRENT |NO |
|2     |/oracle12/app/oracle/oradata/db1/redo02.log  |200|56  |INACTIVE|YES|
|2     |/oracle12/app/oracle/oradata/db1/redo02_2.log|200|56  |INACTIVE|YES|
|3     |/oracle12/app/oracle/oradata/db1/redo03.log  |200|55  |INACTIVE|YES|
|3     |/oracle12/app/oracle/oradata/db1/redo03_2.log|200|55  |INACTIVE|YES|

2. í…ŒìŠ¤íŠ¸ í…Œì´ë¸” ë° ë°ì´í„° ì¶”ê°€
create table scott.redo_test1(no number) tablespace users;
insert into scott.redo_test1 values(1);
commit;

3. physical current redo group ì‚­ì œ 
rm /oracle12/app/oracle/oradata/db1/redo01*

4. logswitch until DB hang
alter system switch logfile;

4. clear
alter database clear unarchived logfile group 1;

5. ë°ì´í„° ìœ ì‹¤ í™•ì¸ -> âŒ
select * from scott.redo_test1;

=>
	ë°ì´í„° ì •ìƒ(DB openì¤‘ì´ë©´ current redo fileì´ ì†ìƒë˜ë”ë¼ë„ bufferì— ê¸°ë¡ì¤‘ì´ë¯€ë¡œ, í¬ê²Œ ë¬¸ì œê°€ ë˜ì§€ ì•ŠìŒ)
```

> â“
>
> shutdown immediateì‹œ global checkpointê°€ ìœ ë°œëœ ìƒíƒœ -> ë°ì´í„° ìœ ì‹¤ ê±±ì • X
>
> ë‹¤ë§Œ, current groupì´ë¯€ë¡œ ë‹¨ìˆœ dropìœ¼ë¡œ current groupì„ ì‚­ì œí•  ìˆ˜ì—†ìŒ.
>
> -> âœ… archive ë–¨êµ¬ê³ ë‚˜ì„œ ìƒì„ê²Œ ì—†ìœ¼ë¯€ë¡œ ë§ˆìŒë†“ê³  clear
>
> ---
>
> ë§Œì•½, shutdown immediateë¡œ ì •ìƒ ì¢…ë£Œí•˜ì§€ ì•Šì€ ìƒíƒœë¼ë©´ ë°ì´í„° ìœ ì‹¤ ìš°ë ¤ê°€ ì¡´ì¬í•¨.
> ì ˆëŒ€ clearí•˜ë©´ ì•ˆë  ê²ƒ ê°™ê³ (clearí•˜ëŠ” ìˆœê°„ ë°ì´í„° ìœ ì‹¤)
>
> ë¨¼ì € ê³¼ê±°ë¡œ ì‹œì  ë³µêµ¬í›„ì— archiveíŒŒì¼ì„  ì¶”ê°€í•˜ë©´ì„œ ë³µêµ¬ì§„í–‰
> ê·¼ë° ì—¬ê¸°ì„œ ìœ ì¼í•œ ë°ì´í„°ë¥¼ ê°„ì§í•˜ê³  ìˆì„ archiveê°€ ì—†ë‹¤ë©´ ì´ê±´ ë…¸ë‹µì¼ë“¯ -> just lost datağŸ’¥

### 7. CURRENT ê·¸ë£¹ì´ ì‚­ì œëœ í›„, DB ì¥ì• ë°œìƒí•˜ì—¬ ë°”ë¼ë³´ë˜ redofileì— ì¨ë‚´ë ¤ë‚´ì§€ ì•Šì€ ìƒí™©

> controlfileì€ ìµœì‹ ìœ¼ë¡œ ë“¤ê³ ìˆê³ ,
> redoëŠ” resetlogsë¥¼ í†µí•´ ì´ˆê¸°í™”í•˜ë˜
>
> datafileì€ ê³¼ê±°ë¡œ ë°±ì—…ë°›ì•„ì˜¤ê³ , ë‚˜ë¨¸ì§€ ë¶€ì¡±í•œ ì •ë³´ëŠ” archiveë¥¼ í†µí•´ ë³µì›
>
> => ë¶ˆì™„ì „ë³µêµ¬

```sql
--- ìƒí™© ë§Œë“¤ê¸° ---
select a.group#
     , a.member
     , b.bytes/1024/1024 mb
     , b.sequence# "seq#"
     , b.status
     , b.archived arc
  from v$logfile a
     , v$log b
 where a.group# = b.group#
 order by 1, 2;
alter system switch logfile;
alter system checkpoint;

create table scott.dml_test2(no number);
-- 1ë²ˆ groupì´ currentì¸ ìƒí™©ì—ì„œ 1ë²ˆ ê°’ insert
insert into scott.dml_test2 values (1);
commit;
-- 2ë²ˆ groupì´ currentì¸ ìƒí™©ì—ì„œ 2ë²ˆ ê°’ insert
insert into scott.dml_test2 values (2);
commit;

-- 3ë²ˆ groupì„ currentë¡œ ë§ì¶”ì–´ë†“ê³  ë‹¤ìŒì˜ ìŠ¤í…ì„ ë¹ ë¥´ê²Œ ì§„í–‰(DBWRê°€ ì‹¤í–‰ë˜ê¸°ì „ì—)

-- 1. insert & commit
insert into scott.dml_test2 values (3);
commit;

-- 2. rm redo03*
SQL> !rm /oracle12/app/oracle/oradata/db1/redo03*

-- 3. shutdown abort
SQL> shutdown abort

--- ë³µêµ¬ ì§„í–‰ ---
1. startup ì‹œë„
SQL> startup
ORACLE instance started.

Total System Global Area 1660944384 bytes
Fixed Size                  8621376 bytes
Variable Size            1056965312 bytes
Database Buffers          587202560 bytes
Redo Buffers                8155136 bytes
Database mounted.
ORA-00313: open failed for members of log group 3 of thread 1ğŸ’¥
ORA-00312: online log 3 thread 1:
'/oracle12/app/oracle/oradata/db1/redo03_2.log'
ORA-27037: unable to obtain file status
Linux-x86_64 Error: 2: No such file or directory
Additional information: 7
ORA-00312: online log 3 thread 1: '/oracle12/app/oracle/oradata/db1/redo03.log'
ORA-27037: unable to obtain file status
Linux-x86_64 Error: 2: No such file or directory
Additional information: 7


2. mountëŠ” ë˜ì—ˆìœ¼ë¯€ë¡œ, log_check
SQL> @log_check.sql

  G MEMBER                                                MB seq# STATUS   ARC
--- -------------------------------------------------- ----- ---- -------- ---
  1 /oracle12/app/oracle/oradata/db1/redo01.log          200   72 ACTIVE   YES
  1 /oracle12/app/oracle/oradata/db1/redo01_2.log        200   72 ACTIVE   YES
  2 /oracle12/app/oracle/oradata/db1/redo02.log          200   71 ACTIVE   YES
  2 /oracle12/app/oracle/oradata/db1/redo02_2.log        200   71 ACTIVE   YES
  3 /oracle12/app/oracle/oradata/db1/redo03.log          200   73 CURRENT  NO
  3 /oracle12/app/oracle/oradata/db1/redo03_2.log        200   73 CURRENT  NO

3. drop ì‹œë„
SQL> alter database drop logfile group 3;
alter database drop logfile group 3
*
ERROR at line 1:
ORA-01623: log 3 is current log for instance db1 (thread 1) - cannot dropğŸ’¥
ORA-00312: online log 3 thread 1: '/oracle12/app/oracle/oradata/db1/redo03.log'
ORA-00312: online log 3 thread 1: '/oracle12/app/oracle/oradata/db1/redo03_2.log'

4. clear ì‹œë„(DBWRê°€ ë™ì‘í•˜ê¸°ì „ì— ìƒí™©ë¶€ì—¬ë¥¼ ë¹ ë¥´ê²Œ ì˜ ìˆ˜í–‰í–ˆë‹¤ë©´, ë‹¤ìŒê³¼ ê°™ì´ instance recoveryê°€ crashë°œìƒí•˜ëŠ”ê²Œ ì •ìƒ)
SQL> alter database clear unarchived logfile group 3;
alter database clear unarchived logfile group 3
*
ERROR at line 1:
ORA-01624: log 3 needed for crash recovery of instance db1 (thread 1)ğŸ’¥
ORA-00312: online log 3 thread 1: '/oracle12/app/oracle/oradata/db1/redo03.log'
ORA-00312: online log 3 thread 1: '/oracle12/app/oracle/oradata/db1/redo03_2.log'

5. recover
5-1) TRY COMPLETE RECOVERY(from í˜„ì¬ to ê³¼ê±°)
SQL> recover database;
ORA-00283: recovery session canceled due to errors
ORA-00313: open failed for members of log group 3 of thread 1ğŸ’¥

5-2) TRY INCOMPLETE RECOVERY(from ê³¼ê±° to í˜„ì¬)
=>
	ë¶ˆì™„ì „ë³µêµ¬ë¥¼ ì‹œë„í•´ì•¼í•˜ëŠ” ì´ìœ 
	CONTROLFILEì€ 3ë²ˆ ì»¤ë°‹ë‚´ìš©ê¹Œì§€ë¥¼ ê¸°ëŒ€í•˜ì§€ë§Œ,
	DATAFILEì—ëŠ” 3ë²ˆ ì»¤ë°‹ë‚´ìš©ì´ ì—†ìŒ.
	STARTUPì‹œ INSTANCE RECOVERYë¥¼ í†µí•´ 3ë²ˆ ì»¤ë°‹ë‚´ìš©ì„ REDOì—ì„œ ë’¤ì§€ì§€ë§Œ 3ë²ˆì´ ì¡´ì¬í•˜ì§€ ì•ŠìŒ.
	ê·¸ëŸ¬ë¯€ë¡œ 3ë²ˆ ì»¤ë°‹ë‚´ìš©ì„ ê¸°ëŒ€í•˜ì§€ ì•ŠëŠ” CONTROLFILEë¡œ ëŒì•„ê°€ì•¼í•¨

5-2-1) shutdown
SQL> shutdown immediate;
5-2-2) restore(ê³¼ê±°ë¡œë¶€í„° ì‹œì‘í•˜ê¸° ìœ„í•¨)
cd /opt/backup4oracle12/backup_202307240950
cp *.dbf /oracle12/app/oracle/oradata/db1/
cp *.ora /oracle12/app/oracle/product/12.2.0.1/db_1/dbs

5-2-2) recover ì‹œë„
SQL> startup mount
SQL> recover database until cancel;
Media recovery complete.
SQL> alter database open;
alter database open
*
ERROR at line 1:
ORA-01589: must use RESETLOGS or NORESETLOGS option for database openğŸ’¥

5-2-3) ë¶ˆí•„ìš”í•˜ë¯€ë¡œ RESETLOGSë¡œ open
SQL> alter database open resetlogs;
Database altered.

5-2-4) select * from scott.dml_redo2;
SQL> select * from scott.dml_redo2;
select * from scott.dml_redo2ğŸ’¥
                    *
ERROR at line 1:
ORA-00942: table or view does not existğŸ’¥

=> tableìƒì„±ë‹¹ì‹œ redolog fileì´ ì•„ì¹´ì´ë¹™ë˜ì§€ ì•Šì•„ tableì´ ì¡´ì¬í•˜ì§€ ì•ŠìŒ.

---
ë§Œì•½ ì•„ì¹´ì´ë¹™ì´ ë˜ì—ˆì„ ê²½ìš°, selectì‹œ 3ë²ˆ ê·¸ë£¹ì— í•´ë‹¹í•˜ëŠ” ë‚´ìš© 3ë²ˆë§Œ ì¡°íšŒë˜ì§€ì•Šê³ , 1ë²ˆê³¼ 2ë²ˆì€ ì¡°íšŒë¨
```

### 8. ëª¨ë“  REDO GROUP ì‚­ì œ, DB OPEN(HANGê±¸ë¦¬ì§€ëŠ” ì•ŠìŒ)

```SQL
-- ì¥ì• ìƒí™© ë°œìƒ
rm /oracle12/app/oracle/oradata/db1/redo*

-- DML
create table scott.dml_redo3(no number);
insert into scott.dml_redo3 values(1);
insert into scott.dml_redo3 values(2);
insert into scott.dml_redo3 values(3);
commit;

-- ë‹¤ë¥¸ DMLë¡œ ì¸í•´ logìŠ¤ìœ„ì¹­ì¼ì–´ë‚œë‹¤ê³  ê°€ì •(ê°•ì œ ë¡œê·¸ìŠ¤ìœ„ì¹­)
alter system switch logfile;

-- in tail -f alert.log
2023-07-24T11:22:11.610551+09:00
Errors in file /oracle12/app/oracle/diag/rdbms/db1/db1/trace/db1_arc3_9373.trc:
ORA-00313: open failed for members of log group 1 of thread 1ğŸ’¥
ORA-00312: online log 1 thread 1: '/oracle12/app/oracle/oradata/db1/redo01_2.log'
ORA-27041: unable to open file
Linux-x86_64 Error: 2: No such file or directory
Additional information: 3
ORA-00312: online log 1 thread 1: '/oracle12/app/oracle/oradata/db1/redo01.log'
ORA-27041: unable to open file
Linux-x86_64 Error: 2: No such file or directory

-- ë¡œê·¸ë¥¼ í†µí•´ ìœ„í—˜ ê°ì§€
(onlineì¤‘ì´ê³ , redo log bufferê°€ ìˆìœ¼ë¯€ë¡œ, clearë¥¼ ì‹œì¼œë„ DML ì •ìƒ ê¸°ë¡)
(ë‹¨, currentì•„ë‹Œ ê·¸ë£¹ë§Œ clearí•˜ê³  currentê·¸ë£¹ì€ ìŠ¤ìœ„ì¹­ì„ í†µí•´ currentë¥¼ ë‹¤ë¥¸ ì •ìƒ ë¡œê·¸ê·¸ë£¹ìœ¼ë¡œ ëŒë¦¬ê³ , clear)

-- clear & checkpoint
alter database clear unarchived logfile group 3;
alter database clear unarchived logfile group 2;
alter system switch logfile;
alter database clear unarchived logfile group 1;
alter system checkpoint; -- bufferì— ìŒ“ì´ê³  ìˆì„ ë‚´ìš©ì„ checkpointë°œìƒì‹œì¼œ ë™ê¸°í™”âœ…

--  ì´í›„, full backupâœ…
```

