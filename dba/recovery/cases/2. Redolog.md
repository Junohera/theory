[toc]

# Redolog

## Î∞©Ìñ•

| case | Îã®ÏúÑ   | REDOÏÉÅÌÉú | ARCHIVE              | DBÏÉÅÌÉú | Î∞©Î≤ï              |
| ---: | ------ | -------- | -------------------- | ------ | ----------------- |
|    1 | MEMBER | !CURRENT |                      | OPEN   | DROP              |
|    2 | MEMBER | CURRENT  |                      | OPEN   | LOGSWITCH -> DROP |
|    3 | GROUP  | !CURRENT |                      | OPEN   | CLEAR             |
|    4 | GROUP  | CURRENT  |                      | OPEN   | RECOVERY          |
|    5 | GROUP  | !CURRENT | NO(cause abort)      | CLOSE  | DROP -> RECOVERY  |
|    6 | GROUP  | CURRENT  | YES(cause immediate) | CLOSE  | CLEAR             |

## Ï£ºÏöî ÏøºÎ¶¨

```sql
SQL> col member format a30;
SQL> select * from v$logfile;

SQL> col group# format 9999999
SQL> col member format a50
SQL> select group#, member from v$logfile;

-- v$logfile: Î°úÍ∑∏ ÌååÏùº Ï†ïÎ≥¥, v$log: Î°úÍ∑∏ ÏÉÅÏÑ∏ Ï†ïÎ≥¥
select a.group#
     , a.member
     , b.bytes/1024/1024 mb
     , b.sequence# "seq#"
     , b.status
     , b.archived arc
  from v$logfile a
     , v$log b
 where a.group# = b.group#
 order by 1, 2;
```

## case

### 1. normal member ÏÇ≠Ï†ú

Í∞Å Í∑∏Î£πÏóê ÎëêÍ∞ú Ïù¥ÏÉÅÏùò memberÍ∞Ä ÏûàÎäî ÏÉÅÌÉúÏóêÏÑú memberÌïòÎÇòÏóê ÏÜêÏÉÅ Î∞úÏÉù

Ìï¥Í≤∞. Î©§Î≤ÑÎ•º ÏÇ≠Ï†ú ÌõÑ Ïû¨ÏÉùÏÑ±(online)

```sql
[ Ïã§ÏäµÌôòÍ≤Ω Íµ¨ÏÑ± ]
1. ÌòÑÏû¨ Î¶¨ÎëêÎ°úÍ∑∏ Íµ¨ÏÑ± ÌôïÏù∏
select a.group#
     , a.member
     , b.bytes/1024/1024 mb
     , b.sequence# "seq#"
     , b.status
     , b.archived arc
  from v$logfile a
     , v$log b
 where a.group# = b.group#
 order by 1, 2;
 
2. Î©§Î≤Ñ Ï∂îÍ∞Ä
alter database add logfile member
			'/oracle12/app/oracle/oradata/db1/redo01_2.log' to group 1,
			'/oracle12/app/oracle/oradata/db1/redo02_2.log' to group 2,
			'/oracle12/app/oracle/oradata/db1/redo03_2.log' to group 3;
			
3. Ïû•Ïï† Î∞úÏÉù
inactiveÏù¥Î©¥ÏÑú, arc YESÏù∏ Í∑∏Î£π Ï§ë 2Î≤à Î©§Î≤ÑÎ•º Î¨ºÎ¶¨Ï†ÅÏúºÎ°ú ÌïòÎÇò ÏÇ≠Ï†ú
(Ïñ¥Ï∞®Ìîº default Î©§Î≤ÑÎäî ÏÇ≠Ï†ú Î∂àÍ∞Ä)
rm /oracle12/app/oracle/oradata/db1/redo01_2.log

4. log switch
ÏÇ≠Ï†úÌïú Î©§Î≤ÑÏùò Í∑∏Î£πÏù¥ currentÍ∞Ä Îê† ÎïåÍπåÏßÄ ÏßÑÌñâ
alter system switch logfile;
=> ‚ú®logswitchÍ∞Ä Î∞úÏÉùÌïòÎ©¥ÏÑú alert logÏóê Ìï¥Îãπ ÌååÏùºÏù¥ ÏóÜÏùå Í∏∞Î°ùÎêòÏßÄÎßå DBÏö¥ÏòÅÏóê Î¨∏Ï†úÍ∞Ä ÏóÜÍ≥†, Ïû•Ïï†ÎÇú groupÏù¥ currentÍ∞Ä ÎêòÎäîÍ≤ÉÎèÑ Î¨∏Ï†úÏóÜÏùå

-- alert
Errors in file /oracle12/app/oracle/diag/rdbms/db1/db1/trace/db1_lgwr_7484.trc:
ORA-00313: open failed for members of log group 1 of thread 1
ORA-00312: online log 1 thread 1: '/oracle12/app/oracle/oradata/db1/redo01_2.log'
ORA-27037: unable to obtain file status
Linux-x86_64 Error: 2: No such file or directory
Additional information: 7

5. Î¨ºÎ¶¨Ï†ÅÏúºÎ°ú ÏÇ≠Ï†úÎêú Î©§Î≤ÑÎ•º ÎÖºÎ¶¨Ï†ÅÏúºÎ°ú ÏÇ≠Ï†úÌïòÏó¨ Î≥µÍµ¨
alter database drop logfile member '/oracle12/app/oracle/oradata/db1/redo01_2.log';

-- alert
ORA-01609: log 1 is the current log for thread 1 - cannot drop members
ORA-00312: online log 1 thread 1: '/oracle12/app/oracle/oradata/db1/redo01.log'
ORA-00312: online log 1 thread 1: '/oracle12/app/oracle/oradata/db1/redo01_2.log'

=> current ÏÉÅÌÉúÏù∏ Í∑∏Î£πÏùò Î©§Î≤ÑÎ•º ÏÇ≠Ï†úÌïòÎäî Í≤ÉÏùÄ Î∂àÍ∞ÄÎä•
		=> logswitch ÌõÑ, ÏÇ≠Ï†ú Ïû¨ÏãúÎèÑ
		
6. Î¨ºÎ¶¨Ï†Å, ÎÖºÎ¶¨Ï†ÅÏúºÎ°ú ÏÇ≠Ï†úÎêú Î©§Î≤ÑÎ•º Îã§Ïãú Î≥µÍµ¨
alter database add logfile member '/oracle12/app/oracle/oradata/db1/redo01_2.log' to group 1;
```

### 2. default member ÏÇ≠Ï†ú

> Î≤ÑÏ†ÑÏóê Îî∞Îùº default member ÏÇ≠Ï†úÍ∞Ä Î∂àÍ∞ÄÎä•Ìï† ÏàòÎèÑ ÏûàÏßÄÎßå,
> ÌòÑÏû¨ Ïã§ÏäµÌïòÎäî ÌôòÍ≤ΩÏóêÏÑúÎäî Ï†ïÏÉÅÏ†ÅÏúºÎ°ú ÏàòÌñâÎêòÏñ¥ default Î©§Î≤ÑÏôÄ not default Î©§Î≤ÑÍ∞Ä Î¨ºÎ¶¨Ï†ÅÏúºÎ°ú ÏÇ≠Ï†úÎêú ÏºÄÏù¥Ïä§Îäî ÎèôÏùºÌïòÍ≤å Ìï¥Í≤∞ÌïòÎ©¥ Îê®.

```sql
[ Ïã§ÏäµÌôòÍ≤Ω Íµ¨ÏÑ± ]
1. ÌòÑÏû¨ Î¶¨ÎëêÎ°úÍ∑∏ Íµ¨ÏÑ± ÌôïÏù∏
select a.group#
     , a.member
     , b.bytes/1024/1024 mb
     , b.sequence# "seq#"
     , b.status
     , b.archived arc
  from v$logfile a
     , v$log b
 where a.group# = b.group#
 order by 1, 2;
 
2. Î©§Î≤Ñ Ï∂îÍ∞Ä
alter database add logfile member
			'/oracle12/app/oracle/oradata/db1/redo01_2.log' to group 1,
			'/oracle12/app/oracle/oradata/db1/redo02_2.log' to group 2,
			'/oracle12/app/oracle/oradata/db1/redo03_2.log' to group 3;
			
3. Ïû•Ïï† Î∞úÏÉù
inactiveÏù¥Î©¥ÏÑú, arc YESÏù∏ Í∑∏Î£π Ï§ë 1Î≤à Î©§Î≤ÑÎ•º Î¨ºÎ¶¨Ï†ÅÏúºÎ°ú ÌïòÎÇò ÏÇ≠Ï†ú
(Ïñ¥Ï∞®Ìîº default Î©§Î≤ÑÎäî ÏÇ≠Ï†ú Î∂àÍ∞Ä)
rm /oracle12/app/oracle/oradata/db1/redo01.log

4. log switch
ÏÇ≠Ï†úÌïú Î©§Î≤ÑÏùò Í∑∏Î£πÏù¥ currentÍ∞Ä Îê† ÎïåÍπåÏßÄ ÏßÑÌñâ
alter system switch logfile;
=> ‚ú®logswitchÍ∞Ä Î∞úÏÉùÌïòÎ©¥ÏÑú alert logÏóê Ìï¥Îãπ ÌååÏùºÏù¥ ÏóÜÏùå Í∏∞Î°ùÎêòÏßÄÎßå DBÏö¥ÏòÅÏóê Î¨∏Ï†úÍ∞Ä ÏóÜÍ≥†, Ïû•Ïï†ÎÇú groupÏù¥ currentÍ∞Ä ÎêòÎäîÍ≤ÉÎèÑ Î¨∏Ï†úÏóÜÏùå

5. Î¨ºÎ¶¨Ï†ÅÏúºÎ°ú ÏÇ≠Ï†úÎêú Î©§Î≤ÑÎ•º ÎÖºÎ¶¨Ï†ÅÏúºÎ°ú ÏÇ≠Ï†ú ÏãúÎèÑ
alter database drop logfile member '/oracle12/app/oracle/oradata/db1/redo01.log';

log 1 is the current log for thread 1 - cannot drop members
ORA-00312: online log 1 thread 1: '/oracle12/app/oracle/oradata/db1/redo01.log'
ORA-00312: online log 1 thread 1: '/oracle12/app/oracle/oradata/db1/redo01_2.log'

=> current ÏÉÅÌÉúÏù∏ Í∑∏Î£πÏùò Î©§Î≤ÑÎ•º ÏÇ≠Ï†úÌïòÎäî Í≤ÉÏùÄ Î∂àÍ∞ÄÎä•ÌïòÍ≥†, default member ÏÇ≠Ï†úÎèÑ Î∂àÍ∞ÄÎä• ?
		=> logswitch ÌõÑ, ÏÇ≠Ï†ú Ïû¨ÏãúÎèÑ
```

### 3. currentÍ∞Ä ÏïÑÎãå Í∑∏Î£πÏù¥ ÏÇ≠Ï†úÎêú ÌõÑ, DB Ï¢ÖÎ£åÎêú Í≤ΩÏö∞(DBÍ∞Ä Ï†ïÏÉÅ open ÎêòÏßÄ ÏïäÎäî ÌòÑÏÉÅ)



```sql
[ Ïã§ÏäµÌôòÍ≤Ω Íµ¨ÏÑ± ]
1. ÌòÑÏû¨ Î¶¨ÎëêÎ°úÍ∑∏ Íµ¨ÏÑ± ÌôïÏù∏
select a.group#
     , a.member
     , b.bytes/1024/1024 mb
     , b.sequence# "seq#"
     , b.status
     , b.archived arc
  from v$logfile a
     , v$log b
 where a.group# = b.group#
 order by 1, 2;
 
 alter system checkpoint; -- activeÏÉÅÌÉúÎ•º inactive ÏÉÅÌÉúÎ°ú ÎßåÎì§Í∏∞ ÏúÑÌï¥ Í∞ïÏ†ú Ï≤¥ÌÅ¨Ìè¨Ïù∏Ìä∏ Î∞úÏÉù
 
2. Í∑∏Î£πÏùÑ Íµ¨ÏÑ±ÌïòÎäî Î°úÍ∑∏ÌååÏùº Î¨ºÎ¶¨Ï†Å ÏÇ≠Ï†ú
(currentÍ∞Ä ÏïÑÎãàÎ©¥ÏÑú archive ÏôÑÎ£åÎêú Í∑∏Î£π)
rm /oracle12/app/oracle/oradata/db1/redo01*

3. DB shutdown immediate
SQL> shutdown immediate;

=>
		Ïù¥ÎØ∏ checkpointÍ∞Ä ÏôÑÎ£åÎêú Í∑∏Î£πÏùò Î¨ºÎ¶¨Ï†Å ÏÜêÏÉÅÏùÄ global checkpointÏóê Î∞©Ìï¥Í∞Ä ÎêòÏßÄ ÏïäÏúºÎØÄÎ°ú immediate Ï¢ÖÎ£å Í∞ÄÎä•
		(Ïù¥ÎØ∏ archiveÎ°ú ÎÇ¥Î†§Ï°åÏúºÎØÄÎ°ú)
		
4. startup
mountÍπåÏßÄÎäî ÎêòÍ≥†, redo infoÏùò ÏóêÎü¨Î°ú Ïù∏Ìï¥ Í∞ïÏ†ú close
(closed => nomount => mount => closed)
ÌïòÍ∏∞ Ïù¥ÎØ∏ÏßÄ Ï∞∏Í≥†

Database mounted.
ORA-03113: end-of-file on communication channel => Í∞ïÏ†ú Ï¢ÖÎ£å(closed ÏÉÅÌÉú)
Process ID: 12993
Session ID: 1 Serial number: 14952

```

<img src="./assets/image-20230721114447979.png" alt="image-20230721114447979" style="zoom:50%;" />

```sql
ÏúÑÏóêÏÑúÏùò startupÏùÑ ÌÜµÌï¥ 
mount Í≥ºÏ†ï Ïù¥ÌõÑÏóêÏÑú Í∞ïÏ†ú Ï¢ÖÎ£åÎêú ÏÇ¨Ïã§ÏùÑ ÏïåÍ≤åÎêòÏóàÏúºÎØÄÎ°ú

startup mount ÌõÑ, 
datafile infoÏôÄ redo infoÎì±ÏùÑ Ï°∞ÌöåÌïòÏó¨ ÎπÑÍµêÌï¥Î≥∏Îã§.

--- ‚ú¥ Ï∞∏Í≥† 
** Î¨∏Ï†úÏ†ê ÌååÏïÖ Î∞©Î≤ï
1. alert log
	2023-07-21T11:49:48.433413+09:00
  Errors in file /oracle12/app/oracle/diag/rdbms/db1/db1/trace/db1_lgwr_13394.trc:
  ORA-00313: open failed for members of log group 1 of thread 1
  ORA-00312: online log 1 thread 1: '/oracle12/app/oracle/oradata/db1/redo01_2.log'
  ORA-27037: unable to obtain file status
  Linux-x86_64 Error: 2: No such file or directory
  Additional information: 7
  2023-07-21T11:49:48.433525+09:00
  Errors in file /oracle12/app/oracle/diag/rdbms/db1/db1/trace/db1_lgwr_13394.trc:
  ORA-00313: open failed for members of log group 1 of thread 1
  ORA-00312: online log 1 thread 1: '/oracle12/app/oracle/oradata/db1/redo01_2.log'
  ORA-27037: unable to obtain file status
  Linux-x86_64 Error: 2: No such file or directory
2. ÏßÑÌñâÏÉÅÌô©Î≥Ñ ÎåÄÏÉÅ ÌôïÏù∏
	- mount
		- datafile
			TODO:
		- redo
			SQL> col member format a30;
			SQL> select * from v$logfile;
---

5. Î¨∏Ï†ú ÌôïÏù∏
SQL> startup mount;
SQL> col group# format 9999999
SQL> col member format a50
SQL> select group#, member from v$logfile;

  GROUP# MEMBER
-------- --------------------------------------------------
       1 /oracle12/app/oracle/oradata/db1/redo01.log
       3 /oracle12/app/oracle/oradata/db1/redo03.log
       2 /oracle12/app/oracle/oradata/db1/redo02.log
       1 /oracle12/app/oracle/oradata/db1/redo01_2.log
       2 /oracle12/app/oracle/oradata/db1/redo02_2.log
       3 /oracle12/app/oracle/oradata/db1/redo03_2.log
       

!ls /oracle12/app/oracle/oradata/db1/redo01.log
!ls /oracle12/app/oracle/oradata/db1/redo03.log
!ls /oracle12/app/oracle/oradata/db1/redo02.log
!ls /oracle12/app/oracle/oradata/db1/redo01_2.log
!ls /oracle12/app/oracle/oradata/db1/redo02_2.log
!ls /oracle12/app/oracle/oradata/db1/redo03_2.log

=> No such file or directoryÏù∏ ÌååÏùº ÌôïÏù∏
ls: cannot access /oracle12/app/oracle/oradata/db1/redo01.log: No such file or directory
ls: cannot access /oracle12/app/oracle/oradata/db1/redo01_2.log: No such file or directory


6. ÏÇ≠Ï†úÎêú ÌååÏùºÎì§Ïùò ÏÉÅÌÉú ÌôïÏù∏
SQL> select a.group#, a.member, b.status, b.archived arc from v$logfile a, v$log b where a.group# = b.group# and a.member in ('/oracle12/app/oracle/oradata/db1/redo01.log', '/oracle12/app/oracle/oradata/db1/redo01_2.log') order by 1, 2;

  GROUP# MEMBER                                             STATUS           ARC
-------- -------------------------------------------------- ---------------- ---
       1 /oracle12/app/oracle/oradata/db1/redo01.log        INACTIVE         YES
       1 /oracle12/app/oracle/oradata/db1/redo01_2.log      INACTIVE         YES

=> ÎßåÏïΩ INACTIVEÏù¥Î©¥ÏÑú ARCÏó¨Î∂ÄÍ∞Ä YES ÌôïÏù∏ÎêòÏóàÎã§Î©¥ Îã®ÏàúÌûà Í∑∏Î£πÏùÑ Ïû¨ÏÉùÏÑ±ÌïòÍ±∞ÎÇò Î©§Î≤ÑÎ•º ÏÇ≠Ï†úÌïòÎèÑÎ°ù Ï°∞Ïπò

7. Í∑∏Î£π ÏÇ≠Ï†ú Î∞è Ï∂îÍ∞Ä
üí• ÎßåÏïΩ INACTIVEÏù¥Î©¥ÏÑú ARCÍ∞Ä YESÍ∞Ä ÏïÑÎãå ÏÉÅÌÉúÏóêÏÑú ÏÇ≠Ï†úÌïòÎ©¥ ÏïàÎê®!!!
SQL> alter database drop logfile group 1;
SQL> alter database add logfile group 1 ('/oracle12/app/oracle/oradata/db1/redo01.log', '/oracle12/app/oracle/oradata/db1/redo01_2.log') size 200M;
SQL> select group#, member from v$logfile;

  GROUP# MEMBER
-------- --------------------------------------------------
       1 /oracle12/app/oracle/oradata/db1/redo01.log
       3 /oracle12/app/oracle/oradata/db1/redo03.log
       2 /oracle12/app/oracle/oradata/db1/redo02.log
       1 /oracle12/app/oracle/oradata/db1/redo01_2.log
       2 /oracle12/app/oracle/oradata/db1/redo02_2.log
       3 /oracle12/app/oracle/oradata/db1/redo03_2.log

8. open
SQL> alter database open
SQL> select instance_name, status from v$instance;

INSTANCE_NAME    STATUS
---------------- ------------
db1              OPEN
```

### 4. currentÍ∞Ä ÏïÑÎãå Í∑∏Î£πÏù¥ ÏÇ≠Ï†úÎêú ÌõÑ, DBÍ∞Ä Ïò§ÌîàÏù∏ ÏÉÅÌÉú

> currentÍ∞Ä ÏïÑÎãå Í∑∏Î£πÏù¥ ÏÇ≠Ï†úÎêú ÌõÑ DBÍ∞Ä openÏù∏ÏÉÅÌÉú
>
> Í≥ÑÏÜç Ïö¥ÏòÅÏ§ë => Í≥ÑÏÜçÎêú logswitch Î∞úÏÉù => DB hang
>
> 1. log switchÎ•º Ìä∏Î¶¨Í±∞ÌïòÍ≥†ÏûàÎäî DMLÏùÑ kill
> 2. archive log dest Ïû†Ïãú Ï§ëÎã®

```sql
alter system switch logfile;
alter system checkpoint;

-- 1. ÌòÑÏû¨ ÏÉÅÌÉú ÌôïÏù∏
select a.group#
     , a.member
     , b.bytes/1024/1024 mb
     , b.sequence# "seq#"
     , b.status
     , b.archived arc
  from v$logfile a
     , v$log b
 where a.group# = b.group#
 order by 1, 2;
 
-- 2. Î¨ºÎ¶¨Ï†ÅÏúºÎ°ú Î¶¨ÎëêÎ°úÍ∑∏ Í∑∏Î£π ÏÇ≠Ï†ú
		INACTIVE, YESÏù∏ Í∑∏Î£π ÏÇ≠Ï†ú
rm /oracle12/app/oracle/oradata/db1/redo01*

-- 3. logswitch ÏãúÎèÑ until DBhang with tail -f alert
SQL> alter system switch logfile;

-- 4. Í≤∞Í≥º ÌôïÏù∏
3Î≤à ÏãúÏ†êÎ∂ÄÌÑ∞ Î™®Îì† redoÏùò archiveÍ∞Ä Îñ®Ïñ¥ÏßÄÏßÄ ÏïäÍ≥†,
log switchÍ∞Ä ÎçîÏù¥ÏÉÅ ÏßÑÌñâÎêòÏßÄ ÏïäÏïÑ, Ï∂îÍ∞ÄÎêòÎäî DMLÏùÄ ÏïÑÏòà Î∞õÏïÑÏì∞Í∏∞Í∞Ä Î∂àÍ∞ÄÎä•Ìïú ÏÉÅÌÉú
=>
DB Ïû•Ïï†

---
‚úÖ ÏÉÅÏÑ∏ ÏõêÏù∏ Í∑úÎ™Ö
1Î≤à Í∑∏Î£π ÏÜêÏÉÅ ÌõÑ, Î°úÍ∑∏Ïä§ÏúÑÏπòÍ∞Ä Î∞úÏÉùÌïòÎ©¥ 1Î≤à Í∑∏Î£π Î°úÍ∑∏ÌååÏùºÎ°úÎ∂ÄÌÑ∞ ÏïÑÏπ¥Ïù¥Î∏å ÏÉùÏÑ± ÏãúÎèÑ
-> ÏóêÎü¨ Î∞úÏÉù(ÏïÑÏπ¥Ïù¥Îπô Î∂àÍ∞Ä)üí•
Ïù¥ÌõÑ Î∞òÎ≥µÎêòÎäî Î°úÍ∑∏Ïä§ÏúÑÏπòÎ°ú Ïù∏Ìï¥ 2Î≤à Í∑∏Î£πÍ≥º 3Î≤à Í∑∏Î£πÍπåÏßÄ Ïó∞ÏáÑÏ†ÅÏúºÎ°ú ÏïÑÏπ¥Ïù¥Îπô Î∂àÍ∞Äüí•
Ïû•Ïï†ÎÇú Í∑∏Î£πÏúºÎ°ú Îã§Ïãú current ÎèåÏûÖÌï† ÎñÑ, ÏïÑÏπ¥Ïù¥ÎπôÏù¥ ÏôÑÎ£åÎêòÏßÄ ÏïäÏïòÏúºÎØÄÎ°ú Î°úÍ∑∏Ïä§ÏúÑÏπò Î∂àÍ∞Äüí•
(Ïù¥ÎïåÎ∂ÄÌÑ∞ Ïñ¥Îñ†Ìïú Î™®Îì† dml ÏàòÌñâ Î∂àÍ∞Äüí•)


-- ÏÉÅÌÉúÌôïÏù∏ ÏøºÎ¶¨(ARCÍ∞Ä Ï†ÑÏõê NO)
|GROUP#|MEMBER                                       |MB |seq#|STATUS  |ARC  |
|------|---------------------------------------------|---|----|--------|-----|
|1     |/oracle12/app/oracle/oradata/db1/redo01.log  |200|42  |INACTIVE|NOüí• |
|1     |/oracle12/app/oracle/oradata/db1/redo01_2.log|200|42  |INACTIVE|NOüí• |
|2     |/oracle12/app/oracle/oradata/db1/redo02.log  |200|44  |CURRENT |NOüí• |
|2     |/oracle12/app/oracle/oradata/db1/redo02_2.log|200|44  |CURRENT |NOüí• |
|3     |/oracle12/app/oracle/oradata/db1/redo03.log  |200|43  |INACTIVE|NOüí• |
|3     |/oracle12/app/oracle/oradata/db1/redo03_2.log|200|43  |INACTIVE|NOüí• |

-- alert Î°úÍ∑∏ ÌôïÏù∏
2023-07-21T12:28:25.537689+09:00
ORACLE Instance db1 - Cannot allocate log, archival required üí•
2023-07-21T12:28:25.537873+09:00
Thread 1 cannot allocate new log, sequence 45 üí•
All online logs need archiving
Examine archive trace files for archiving errors
Current log# 2 seq# 44 mem# 0: /oracle12/app/oracle/oradata/db1/redo02.log
Current log# 2 seq# 44 mem# 1: /oracle12/app/oracle/oradata/db1/redo02_2.log

üíä Î≥µÍµ¨
-- 1. Ïû•Ïï†ÎÇú Í∑∏Î£π ÏÇ≠Ï†ú(controlfile Ï†ïÎ≥¥ ÏÇ≠Ï†ú)
=> ÏïÑÏπ¥Ïù¥Î∏å ÏôÑÎ£åÎêòÏßÄ ÏïäÏùÄ Í∑∏Î£π ÏÇ≠Ï†ú Î∂àÍ∞Ä
SQL> alter database drop logfile group 1;
ORA-00350: log 1 of instance db1 (thread 1) needs to be archivedüí•

-- 2. redo clear
‚úÖ redoÎ•º Ï†ïÏÉÅÏ†ÅÏúºÎ°ú ÏÇ≠Ï†úÌï† Ïàò ÏóÜÏùÑ Í≤ΩÏö∞ Ìï¥Îãπ Ï†ïÎ≥¥Î•º clear ÏãúÏºúÏÑú ÎçîÏù¥ÏÉÅ archiveÎ•º ÏãúÎèÑÌïòÏßÄ ÏïäÎèÑÎ°ù Ï°∞Ïπò
=> Îç∞Ïù¥ÌÑ∞ ÏÜêÏã§ÏùÑ Îñ†ÏïàÍ≥† ÌïòÎäî ÌñâÏúÑÏù¥ÎØÄÎ°ú üëâüèªÎ∞òÎìúÏãú ÏÇ¨ÌõÑÏóê fullbackup ÏßÑÌñâ
alter database clear unarchived logfile group 1;

Ïù¥ÌõÑ, 
1. arcÍ∞Ä Ï†ïÏÉÅÏ†ÅÏúºÎ°ú YESÎ°ú ÎêòÍ≥†, UNUSED
		|GROUP#|MEMBER                                       |MB |seq#|STATUS  |ARC|
    |------|---------------------------------------------|---|----|--------|---|
    |1     |/oracle12/app/oracle/oradata/db1/redo01.log  |200|0   |UNUSED  |YES|
    |1     |/oracle12/app/oracle/oradata/db1/redo01_2.log|200|0   |UNUSED  |YES|
    |2     |/oracle12/app/oracle/oradata/db1/redo02.log  |200|44  |CURRENT |NO |
    |2     |/oracle12/app/oracle/oradata/db1/redo02_2.log|200|44  |CURRENT |NO |
    |3     |/oracle12/app/oracle/oradata/db1/redo03.log  |200|43  |INACTIVE|YES|
    |3     |/oracle12/app/oracle/oradata/db1/redo03_2.log|200|43  |INACTIVE|YES|
2. ÏÜêÏÉÅÎêú redoÍ∑∏Î£πÏùò Î¨ºÎ¶¨Ï†Å ÌååÏùº ÏÉùÏÑ±
		(ÏïÑÎßà `> /oracle12/app/oracle/oradata/db1/redo01.log`Ïùò Ï¥àÍ∏∞ÌôîÌïòÎäî Íµ¨Î¨∏Ïù¥ ÎÇ¥Î∂ÄÏ†ÅÏúºÎ°ú Ï°¥Ïû¨ÌïòÎäîÎìØ)
		SQL> !ls /oracle12/app/oracle/oradata/db1/redo01.log
		/oracle12/app/oracle/oradata/db1/redo01.log
```

![image-20230721140557900](./assets/image-20230721140557900.png)

### 5. currentÍ∞Ä ÏïÑÎãå Í∑∏Î£πÏù¥ ÏÇ≠Ï†úÎêú ÌõÑ, Ìï¥Îãπ Í∑∏Î£πÏù¥ archiveÎêòÏßÄ ÏïäÏùÄ ÏÉÅÌÉú

```sql
ÏÇ¨Ï†Ñ Ï§ÄÎπÑ
3Î≤à Í∑∏Î£π current, ÎÇòÎ®∏ÏßÄ inactive, arc YES ÏÉÅÌÉúÎ°ú
alter system switch logfile;
alter system checkpoint;
 
 |GROUP#|MEMBER                                       |MB |seq#|STATUS  |ARC|
|------|---------------------------------------------|---|----|--------|---|
|1     |/oracle12/app/oracle/oradata/db1/redo01.log  |200|45  |INACTIVE|YES|
|1     |/oracle12/app/oracle/oradata/db1/redo01_2.log|200|45  |INACTIVE|YES|
|2     |/oracle12/app/oracle/oradata/db1/redo02.log  |200|44  |INACTIVE|YES|
|2     |/oracle12/app/oracle/oradata/db1/redo02_2.log|200|44  |INACTIVE|YES|
|3     |/oracle12/app/oracle/oradata/db1/redo03.log  |200|46  |CURRENT |NO |
|3     |/oracle12/app/oracle/oradata/db1/redo03_2.log|200|46  |CURRENT |NO |
```



```sql
1. ÌòÑÌô© Ï°∞Ìöå
select a.group#
     , a.member
     , b.bytes/1024/1024 mb
     , b.sequence# "seq#"
     , b.status
     , b.archived arc
  from v$logfile a
     , v$log b
 where a.group# = b.group#
 order by 1, 2;
 
2. archiveÍ∞Ä ÏôÑÎ£åÎêú inactive Í∑∏Î£π ÏÇ≠Ï†ú
rm /oracle12/app/oracle/oradata/db1/redo01*

3. logswitch
alter system switch logfile;
=> hang Î∞úÏÉù(ÏÉàÎ°úÏö¥ ÏùºÎ∞ò ÏÑ∏ÏÖò Ï†ëÏÜç Î∂àÍ∞ÄÌï† Ïàò ÏûàÏùå.  sys Í≥ÑÏ†ïÎßå Ï†ëÏÜç Í∞ÄÎä•)

4. shutdown abort


---
Î≥µÍµ¨

1. startup mount

SQL> @log_check.sql

  G MEMBER                                                MB seq# STATUS   ARC
--- -------------------------------------------------- ----- ---- -------- ---
  1 /oracle12/app/oracle/oradata/db1/redo01.log          200   54 INACTIVE NO
  1 /oracle12/app/oracle/oradata/db1/redo01_2.log        200   54 INACTIVE NO
  2 /oracle12/app/oracle/oradata/db1/redo02.log          200   56 CURRENT  NO
  2 /oracle12/app/oracle/oradata/db1/redo02_2.log        200   56 CURRENT  NO
  3 /oracle12/app/oracle/oradata/db1/redo03.log          200   55 INACTIVE NO
  3 /oracle12/app/oracle/oradata/db1/redo03_2.log        200   55 INACTIVE NO

2. startup mount

3. drop ÏãúÎèÑ
alter database drop logfile group 1
ORA-00350: log 1 of instance db1 (thread 1) needs to be archived

4. clear ÏãúÎèÑ
SQL> alter database clear unarchived logfile group 1;

SQL> !ls /oracle12/app/oracle/oradata/db1/redo01*

5. open
```

### 6. currentÏù∏ Í∑∏Î£πÏù¥ ÏÇ≠Ï†úÎêú ÌõÑ, Î≥µÍµ¨

```sql
ÏÇ¨Ï†Ñ Ï§ÄÎπÑ
1. 1Î≤à Í∑∏Î£π current, ÎÇòÎ®∏ÏßÄ inactive, arc YES ÏÉÅÌÉúÎ°ú
alter system switch logfile;
alter system checkpoint;
 
|GROUP#|MEMBER                                       |MB |seq#|STATUS  |ARC|
|------|---------------------------------------------|---|----|--------|---|
|1     |/oracle12/app/oracle/oradata/db1/redo01.log  |200|57  |CURRENT |NO |
|1     |/oracle12/app/oracle/oradata/db1/redo01_2.log|200|57  |CURRENT |NO |
|2     |/oracle12/app/oracle/oradata/db1/redo02.log  |200|56  |INACTIVE|YES|
|2     |/oracle12/app/oracle/oradata/db1/redo02_2.log|200|56  |INACTIVE|YES|
|3     |/oracle12/app/oracle/oradata/db1/redo03.log  |200|55  |INACTIVE|YES|
|3     |/oracle12/app/oracle/oradata/db1/redo03_2.log|200|55  |INACTIVE|YES|

2. ÌÖåÏä§Ìä∏ ÌÖåÏù¥Î∏î Î∞è Îç∞Ïù¥ÌÑ∞ Ï∂îÍ∞Ä
create table scott.redo_test1(no number) tablespace users;
insert into scott.redo_test1 values(1);
commit;

3. physical current redo group ÏÇ≠Ï†ú 

4. startup
SQL> startup
ORA-00313: open failed for members of log group 1 of thread 1
ORA-00312: online log 1 thread 1: '/oracle12/app/oracle/oradata/db1/redo01_2.log'
ORA-27037: unable to obtain file status

5. Îç∞Ïù¥ÌÑ∞ Ïú†Ïã§ ÌôïÏù∏
select * from scott.redo_test1;
```

> ‚ùì
>
> shutdown immediateÏãú global checkpointÍ∞Ä Ïú†Î∞úÎêú ÏÉÅÌÉú -> Îç∞Ïù¥ÌÑ∞ Ïú†Ïã§ Í±±Ï†ï X
>
> Îã§Îßå, current groupÏù¥ÎØÄÎ°ú Îã®Ïàú dropÏúºÎ°ú current groupÏùÑ ÏÇ≠Ï†úÌï† ÏàòÏóÜÏùå.
>
> -> ‚úÖ archive Îñ®Íµ¨Í≥†ÎÇòÏÑú ÏûÉÏùÑÍ≤å ÏóÜÏúºÎØÄÎ°ú ÎßàÏùåÎÜìÍ≥† clear
>
> ---
>
> ÎßåÏïΩ, shutdown immediateÎ°ú Ï†ïÏÉÅ Ï¢ÖÎ£åÌïòÏßÄ ÏïäÏùÄ ÏÉÅÌÉúÎùºÎ©¥ Îç∞Ïù¥ÌÑ∞ Ïú†Ïã§ Ïö∞Î†§Í∞Ä Ï°¥Ïû¨Ìï®.
> Ï†àÎåÄ clearÌïòÎ©¥ ÏïàÎê† Í≤É Í∞ôÍ≥†(clearÌïòÎäî ÏàúÍ∞Ñ Îç∞Ïù¥ÌÑ∞ Ïú†Ïã§)
>
> Î®ºÏ†Ä Í≥ºÍ±∞Î°ú ÏãúÏ†ê Î≥µÍµ¨ÌõÑÏóê archiveÌååÏùºÏùÑ  Ï∂îÍ∞ÄÌïòÎ©¥ÏÑú Î≥µÍµ¨ÏßÑÌñâ
> Í∑ºÎç∞ Ïó¨Í∏∞ÏÑú Ïú†ÏùºÌïú Îç∞Ïù¥ÌÑ∞Î•º Í∞ÑÏßÅÌïòÍ≥† ÏûàÏùÑ archiveÍ∞Ä ÏóÜÎã§Î©¥ Ïù¥Í±¥ ÎÖ∏ÎãµÏùºÎìØ -> just lost dataüí•