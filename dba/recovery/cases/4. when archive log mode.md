[toc]

# When archive log mode

> archive log mode ì„ í–‰

## Setting

### 1. noarchive log mode to archive log mode

```sql
startup mount;
alter database archivelog;
alter database open;
archive log list
```

### 2. ë¶ˆí•„ìš”í•œ í…Œì´ë¸”ìŠ¤í˜ì´ìŠ¤ ì •ë¦¬ ë° ìƒˆë¡œìš´ í…Œì´ë¸”ìŠ¤í˜ì´ìŠ¤ ìƒì„±

```sql
select * from dba_tablespaces;
select * from dba_data_files;

drop tablespace test1;
drop tablespace test1 including contents;

create tablespace test2
         datafile '/oracle12/app/oracle/oradata/db1/test2_01.dbf' size 10m;
```

### 3. offline full bakcup

### ---

## Cases

|   no | archive log mode | Damage information | available offline | trouble shooting                   | explain                                                      |
| ---: | ---------------- | ------------------ | ----------------- | ---------------------------------- | ------------------------------------------------------------ |
|    1 | Yes              | normal tablespace  | No                | âœ…shutdown<br />âœ…recover tablespace |                                                              |
|    2 | Yes              | normal tablespace  | Yes               | âœ…recover tablespace                |                                                              |
|    3 | Yes              | system tablespace  | Yes               | shutdown<br />recover tablespace   | 1ï¸âƒ£offline<br />2ï¸âƒ£checkpoint<br />3ï¸âƒ£dirty buffer write<br />4ï¸âƒ£datafile check |

### 1. general tablespaceì˜ datafile ì†ìƒ, offline ë¶ˆê°€

```sql
0. ìƒí™© ì œì‘
create table arch_test1(no number) tablespace test2;

insert into arch_test1 values(1);
commit;

alter system switch logfile;		-- 4ë²ˆ

insert into arch_test1 values(2);
commit;

alter system switch logfile;		-- 4ë²ˆ

insert into arch_test1 values(3);
commit;

alter system switch logfile;

ğŸ’¥
!rm '/oracle12/app/oracle/oradata/db1/test2_01.dbf'

âœ… ë³µêµ¬ ìˆ˜í–‰
1. í•´ë‹¹ tablespace offline ì‹œë„
SQL> alter tablespace test2 offline;ğŸ’¥
alter tablespace test2 offline
*
ERROR at line 1:
ORA-01116: error in opening database file 6
ORA-01110: data file 6: '/oracle12/app/oracle/oradata/db1/test2_01.dbf'
ORA-27041: unable to open file
Linux-x86_64 Error: 2: No such file or directory
Additional information: 3

=> dirty bufferì— ëŒ€í•œ checkpointê°€ ë°œìƒí•  ê²½ìš°, offline ë¶ˆê°€í•  ìˆ˜ ìˆìŒ
offlineì´ ì•ˆë˜ëŠ” ê²½ìš°, DBê°€ ë‚´ë ¤ê°„ ìƒíƒœì—ì„œ ë³µêµ¬
(ìš´ì˜ì¤‘ì¼ ê²½ìš°, DBë¥¼ ê·¸ëŒ€ë¡œ ë‘ê³  copyDBë¥¼ í†µí•´ ì§„í–‰í•˜ì§€ë§Œ, ì•„ì§ ê·¸ë ‡ê²Œê¹Œì§€ëŠ” í•˜ì§€ì•Šê¸°ë¡œ!!)

2. shutdown immediate
SQL> shutdown immediateğŸ’¥
ORA-01116: error in opening database file 6
ORA-01110: data file 6: '/oracle12/app/oracle/oradata/db1/test2_01.dbf'
ORA-27041: unable to open file
Linux-x86_64 Error: 2: No such file or directory
Additional information: 3

3. physical restore
cd /oracle12/app/oracle/oradata/db1
cp /opt/backup4oracle12/backup_202307261044/test2_01.dbf ./

4. shutdown abort

5. try startup mount
SQL> startup mount;

5. try complete recovery(only tablespace) âœ…
SQL> @arch_check
SQL> recover tablespace test2;
```

**ë³µêµ¬ì‹œ seqì •ë³´ì™€ scn ì •ë³´ë¥¼ í™•ì¸í•˜ì—¬ suggestion archive fileê³¼ ì‹¤ì œ archive fileì´ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸í•˜ì—¬**
**ì§„í–‰í•˜ë„ë¡í•œë‹¤.**

**ì˜ˆì‹œ ì´ë¯¸ì§€**

<img src="./assets/image-20230726111712139.png" alt="image-20230726111712139" style="zoom: 33%;" />

<img src="./assets/image-20230726111924930.png" alt="image-20230726111924930" style="zoom: 33%;" />

```sql
6. try open
alter database open;
```

### 2. general tablespaceì˜ datafile ì†ìƒ, offline ê°€ëŠ¥

```sql
0. ìƒí™© ì œì‘
create table arch_test2(no number) tablespace test2;

insert into arch_test2 values(1);
commit;

alter system switch logfile;		-- 4ë²ˆ

insert into arch_test2 values(2);
commit;

alter system switch logfile;		-- 4ë²ˆ

insert into arch_test2 values(3);
commit;

alter system checkpoint;

alter system switch logfile;

ğŸ’¥
!rm '/oracle12/app/oracle/oradata/db1/test2_01.dbf'

âœ… ë³µêµ¬ ìˆ˜í–‰
1. í•´ë‹¹ tablespace offline ì‹œë„
SQL> alter tablespace test2 offline;
alter tablespace test2 offline

2. physical restore
cd /oracle12/app/oracle/oradata/db1
cp /opt/backup4oracle12/backup_202307261044/test2_01.dbf ./

3. complete recovery(only tablespace) âœ…
SQL> @arch_check
SQL> recover tablespace test2;
...
Media recovery complete.

4. í•´ë‹¹ tablespace online ì‹œë„
SQL> alter tablespace test2 online;
Tablespace altered.

SQL> select tablespace_name, status from dba_tablespaces;

5. tablespace ìƒíƒœì¡°íšŒ
TABLESPACE_NAME                STATUS
------------------------------ ---------
SYSTEM                         ONLINE
SYSAUX                         ONLINE
UNDOTBS1                       ONLINE
TEMP                           ONLINE
USERS                          ONLINE
TEST2                          ONLINE

```

### 3. system tablespaceì˜ datafile ì†ìƒ

> ğŸ”¥`system|default|undo` tablespaceëŠ” ì–´ë–¤ ê²½ìš°ë”ë¼ë„ offlineì´ ë¶ˆê°€ëŠ¥
>
> 

````sql
alter user scott quota unlimited on system;

create table scott.noarch_recover10(no number) tablespace system;
insert into scott.noarch_recover10 values(1);
insert into scott.noarch_recover10 values(2);
insert into scott.noarch_recover10 values(3);
commit;

alter database switch logfile; -- 4ë²ˆ
alter system checkpoint; 

select * from data_files;
!rm /oracle12/app/oracle/oradata/db1/system01.dbf

-- ë³µêµ¬
0. tablespace offline immediate ì‹œë„(if !system)

1. try shutdown immediate 
SQL> shutdown immediate;ğŸ’¥
ORA-01116: error in opening database file 1
ORA-01110: data file 1: '/oracle12/app/oracle/oradata/db1/system01.dbf'
ORA-27041: unable to open file
Linux-x86_64 Error: 2: No such file or directory
Additional information: 3

2. try shutdown abort
shutdown abort

3. restore physical file
cd /oracle12/app/oracle/oradata/db1
cp /opt/backup4oracle12/backup_202307261224/system01.dbf ./

4. try startup open
SQL> startup open;
ORACLE instance started.

Total System Global Area 1660944384 bytes
Fixed Size                  8621376 bytes
Variable Size            1056965312 bytes
Database Buffers          587202560 bytes
Redo Buffers                8155136 bytes
Database mounted.
ORA-01113: file 1 needs media recovery
ORA-01110: data file 1: '/oracle12/app/oracle/oradata/db1/system01.dbf'

5. shutdown immediate
shutdown immediate;

6. try startup mount;
startup mount

7. try recovery
recover tablespace system;

8. open
alter database open;

9. status
SQL> @status

INSTANCE_NAME    STATUS
---------------- ------------
db1              OPEN

10. data check
SQL> select * from scott.noarch_recover10;

        NO
----------
         1
         2
         3
         
-- ğŸ’Šâœ…BEST ë³µêµ¬ 
> offline immediateì„ í™œìš©í•  ê²½ìš°, onlineì¤‘ì—ì„œ recoverí•˜ê²Œë˜ë©´ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ë‚´ë¦¬ì§€ ì•Šê³ , ì§„í–‰ ê°€ëŠ¥í•˜ì§€ë§Œ
ğŸ‘» ë‹¨, systemì€ ì ˆëŒ€ë¶ˆê°€ëŠ¥, ì™œëƒí•˜ë©´ systemì— data dictionary viewê°€ ì¡´ì¬í•˜ë¯€ë¡œ, ì ˆëŒ€ ì•ˆë¨

## offline immediate ì„ í–‰ì¡°ê±´
1. when archive log mode
2. when open
3. when error tablespace's datafile

```sql
example:
alter tablespace default|undo|users offline immediate;
restore physical file
recover tablespace default|undo|users
alter tablespace default|undo|users open;
```
````



