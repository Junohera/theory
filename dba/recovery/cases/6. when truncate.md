# when truncate

> archive log
>
>  online backup

archive log modeì—ì„œ ë…¼ë¦¬ì  ì¥ì• ë°œìƒì‹œ ë³µêµ¬í•˜ê¸°
(truncate table / drop table purge / dml old image ê°€ì ¸ì˜¬ ìˆ˜ ì—†ì„ ê²½ìš°)

=> ë¶ˆì™„ì „ë³µêµ¬âœ…

## online full backup

```shell
mkdir -p /opt/backup4oracle12/online/backup_202307261857/

alter tablespace SYSTEM begin backup;	
alter tablespace SYSAUX begin backup;	
alter tablespace UNDOTBS1 begin backup;	
alter tablespace USERS begin backup;	
alter tablespace TEST2 begin backup;	
cp /oracle12/app/oracle/oradata/db1/system01.dbf /opt/backup4oracle12/online/backup_202307261857/
cp /oracle12/app/oracle/oradata/db1/sysaux01.dbf /opt/backup4oracle12/online/backup_202307261857/
cp /oracle12/app/oracle/oradata/db1/undotbs01.dbf /opt/backup4oracle12/online/backup_202307261857/
cp /oracle12/app/oracle/oradata/db1/users01.dbf /opt/backup4oracle12/online/backup_202307261857/
cp /oracle12/app/oracle/oradata/db1/users02.dbf /opt/backup4oracle12/online/backup_202307261857/
cp /oracle12/app/oracle/oradata/db1/test2_01.dbf /opt/backup4oracle12/online/backup_202307261857/
alter tablespace SYSTEM end backup;
alter tablespace SYSAUX end backup;
alter tablespace UNDOTBS1 end backup;
alter tablespace USERS end backup;
alter tablespace TEST2 end backup;

alter database backup controlfile to trace as '/opt/backup4oracle12/online/backup_202307261857/control.sql';
chown -R oracle:oinstall /opt/backup4oracle12/online/backup_202307261857/
```

## flow

```sql
SQL> alter system switch logfile;
SQL> truncate table scott.emp;

-- ë³µêµ¬
1. ê³¼ê±° ì´ë¯¸ì§€ì¡°íšŒ(as of timestamp) ì‹œë„
select *
  from scott.emp
    as of timestamp to_timestamp('2023-07-26 18:59:36','YYYY-MM-DD HH24:MI:SS');
ORA-01466: unable to read data - table definition has changed

ğŸ‘» ì¡°íšŒë˜ì§€ ì•ŠìŒ.
=> flashback dataëŠ” DDLì´ì „ ì‹œì  ë°ì´í„° ì¡°íšŒ ë¶ˆê°€(truncate ë˜í•œ DDLì´ë¯€ë¡œ ë¶ˆê°€)

-- real ë³µêµ¬ => imcomplete recovery
1. shutdown
SQL> shutdown immediate
2. restore(hot backup)
!cp /opt/backup4oracle12/online/backup_202307261857/*.dbf /oracle12/app/oracle/oradata/db1/
/* */ */
3. mount / recovery
  ğŸ’Šrecovery database until time
  ğŸ‘»ë§Œì•½ until cancelí•˜ê²Œë  ê²½ìš°, ì™„ì „ ë³µêµ¬ê°€ ë˜ì–´ë²„ë¦´ ìˆ˜ ìˆìŒ

startup mount
recover database until time '2023-07-26 18:59:36';
=> needs more recovery to be consistent ... datafile system01.dbfì¼ ê²½ìš°, 
resetlogsë¥¼ í†µí•´ ë°ì´í„°íŒŒì¼ì˜ ê¸°ì¤€ìœ¼ë¡œë§Œ opení•  ê²ƒ

4. open
alter database open resetlogs;
```

