[toc]

# Trigger

## 1. íŠ¸ë¦¬ê±°ë¡œ ì œì•½

> ì•„ë˜ì™€ ê°™ì´ ì£¼ë¬¸ ì •ë³´ë¥¼ ì €ì¥í•˜ëŠ” í…Œì´ë¸”ì„ ìƒì„±í•œ í›„ ì£¼ë¬¸ ì •ë³´ê°€ ì…ë ¥ë  ë•Œ
> í—ˆê°€ë˜ì§€ ì•Šì€ ì½”ë“œëŠ” ì…ë ¥ë˜ì§€ ì•Šë„ë¡ íŠ¸ë¦¬ê±° ì‘ì„±(ì…ë ¥ ì œí•œ íŠ¸ë¦¬ê±°)
> ì…ë ¥ ì½”ë“œëŠ” C100 ~ C110 ë²”ìœ„ì´ë©° C105ëŠ” ì…ë ¥ ë¶ˆê°€

```sql
drop table o_order;
drop table o_order_log;
create table o_order
(no         number,
 ord_code   varchar2(10),
 ord_date   date,
 reason     varchar2(128));
create table o_order_log
as
select sysdate as processed,
       o.reason,
       o.no,
       o.ord_code,
       o.ord_date
  from o_order o
 where 1=2;
 
create or replace trigger trg_validate_o_order_order_code
before insert on o_order
for each row
declare
  code    o_order.ord_code%type;
  i       number;
begin
  code := :new.ord_code;
  i := cast(substr(code, 2) as number);
  
  if not ((i between 100 and 110) and i not in (105)) then
  	raise_application_error(-20400, 'bad request parameter');  
  end if;
  
  -- ğŸ’¥
  --insert into o_order_log
  --values(sysdate, :new.reason, :new.no, :new.ord_code, :new.ord_date);
  -- ğŸ’Š
  insert into o_order_log(processed, reason, no, ord_code, ord_date)
  values(sysdate, :new.reason, :new.no, :new.ord_code, :new.ord_date);
end;
/

insert into o_order values (1, 'C100', sysdate, 'SUCCESS CASE1');
insert into o_order values (1, 'C110', sysdate, 'SUCCESS CASE2');
insert into o_order values (1, 'C105', sysdate, 'FAILURE CASE1');
/*
TRY INSERT (C099,C105)	-> ON TRIGGER
												-> TRY INSERT TO LOG TABLE(BUFFER CACHE?)
												-> RAISE_APPLICATION_ERROR(WITH EXIT CODE)??
												-> ALL ROLLBACK??
*/
insert into o_order values (1, 'C099', sysdate, 'FAILURE CASE2');

/* Trigger transaction test
ë§Œì•½ ìœ„ íŠ¸ë¦¬ê±°ê°€ ì…ë ¥í•˜ëŠ” ë¡œê·¸í…Œì´ë¸”ì— ì»¬ëŸ¼ì´ ì¶”ê°€ë  ê²½ìš°,
ë¡œê·¸ í…Œì´ë¸” insert ì—ëŸ¬ ë°œìƒ -> ì£¼ë¬¸ í…Œì´ë¸” insert ì—ëŸ¬

ğŸ’¥ ëŒ€ì‘í•˜ëŠ” ì»¬ëŸ¼ëª…ì„ ëª…ì‹œí•˜ì§€ ì•Šì„ ê²½ìš°, ì»¬ëŸ¼ ì¶”ê°€ì‹œ ë¶ˆì¶©ë¶„ ë°œìƒìœ¼ë¡œ ì—ëŸ¬ ë°œìƒ
    insert into o_order_log 
    values(sysdate, :new.reason, :new.no, :new.ord_code, :new.ord_date);
ğŸ’Š ëŒ€ì‘í•˜ëŠ” ì»¬ëŸ¼ëª…ì„ ëª…ì‹œí•  ê²½ìš°, nullable ì»¬ëŸ¼ ì¶”ê°€ì‹œ ì •ìƒ ìˆ˜í–‰
    insert into o_order_log(processed, reason, no, ord_code, ord_date)
    values(sysdate, :new.reason, :new.no, :new.ord_code, :new.ord_date);
*/
alter table o_order_log add imsi number;
insert into o_order values (1, 'C100', sysdate, 'FAILURE CASE3'); -- failure

select *
  from o_order;
select *
  from o_order_log;
rollback;
```

## 2. ì…ë ¥ì‹œê°„ ì œí•œ

> ìœ„ í…Œì´ë¸”ì— ë°ì´í„°ë¥¼ ì…ë ¥ í•  ë•Œ ì…ë ¥ ì‹œê°„ì„ ì œí•œí•˜ê³ ì í•œë‹¤
> ì…ë ¥ ì‹œê°„ì´ 16ì‹œì—ì„œ 18ì‹œ ì‚¬ì´ì¸ ê²½ìš°ëŠ” ì—ëŸ¬ ë°œìƒ, ë‚˜ë¨¸ì§€ ì‹œê°„ì—ëŠ” ì •ìƒ ì…ë ¥
> 16:00:00~17:59:59
>
> (í…ŒìŠ¤íŠ¸ í•  ë•ŒëŠ” ì‹œê°„ì„ ë°”ê¿”ê°€ë©´ì„œ í…ŒìŠ¤íŠ¸ ì§„í–‰..)

```sql
create or replace trigger trg_validate_o_order_time
before insert on o_order
for each row
declare
  hh char(2);
begin
  hh := to_char(:new.ord_date, 'HH24');
  
  if hh in ('16', '17') then
  --  raise_application_error(-20400, 'bad request parameter');
    raise_application_error(-20400, 'input time: '||hh);    
  end if;
end;
/
insert into o_order values (1, 'C100', to_timestamp(to_char(sysdate, 'YYYY-MM-DD')||' '||'15:00:00', 'YYYY-MM-DD HH24:MI:SS'));
insert into o_order values (1, 'C100', to_timestamp(to_char(sysdate, 'YYYY-MM-DD')||' '||'16:00:00', 'YYYY-MM-DD HH24:MI:SS'));
insert into o_order values (1, 'C100', to_timestamp(to_char(sysdate, 'YYYY-MM-DD')||' '||'17:00:00', 'YYYY-MM-DD HH24:MI:SS'));
insert into o_order values (1, 'C100', to_timestamp(to_char(sysdate, 'YYYY-MM-DD')||' '||'18:00:00', 'YYYY-MM-DD HH24:MI:SS'));
rollback;

select *
  from o_order;
```

