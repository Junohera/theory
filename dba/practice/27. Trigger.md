[toc]

# Trigger

## 1. 트리거로 제약

> 아래와 같이 주문 정보를 저장하는 테이블을 생성한 후 주문 정보가 입력될 때
> 허가되지 않은 코드는 입력되지 않도록 트리거 작성(입력 제한 트리거)
> 입력 코드는 C100 ~ C110 범위이며 C105는 입력 불가

```sql
create table o_order
(no number,
 ord_code varchar2(10),
 ord_date date);
```

```sql
create or replace trigger trg_validate_o_order_order_code
before insert on o_order
for each row
declare
  code    o_order.ord_code%type;
  i       number;
begin
  code := :new.ord_code;
  i := cast(substr(code, 2) as number);
  
  if not (i >= 100 and i <= 110 and i not in (105)) then
  --  raise_application_error(-20400, 'bad request parameter');
    raise_application_error(-20400, 'code: '||code||', i: '||i);    
  end if;
end;
/
insert into o_order values (1, 'C100', sysdate);
insert into o_order values (1, 'C110', sysdate);
insert into o_order values (1, 'C105', sysdate);
insert into o_order values (1, 'C099', sysdate);
rollback;
```

## 2. 입력시간 제한

> 위 테이블에 데이터를 입력 할 때 입력 시간을 제한하고자 한다
> 입력 시간이 16시에서 18시 사이인 경우는 에러 발생, 나머지 시간에는 정상 입력
> 16:00:00~17:59:59
>
> (테스트 할 때는 시간을 바꿔가면서 테스트 진행..)

```sql
create or replace trigger trg_validate_o_order_time
before insert on o_order
for each row
declare
  hh char(2);
begin
  hh := to_char(:new.ord_date, 'HH24');
  
  if hh in ('16', '17') then
  --  raise_application_error(-20400, 'bad request parameter');
    raise_application_error(-20400, 'input time: '||hh);    
  end if;
end;
/
insert into o_order values (1, 'C100', to_timestamp(to_char(sysdate, 'YYYY-MM-DD')||' '||'15:00:00', 'YYYY-MM-DD HH24:MI:SS'));
insert into o_order values (1, 'C100', to_timestamp(to_char(sysdate, 'YYYY-MM-DD')||' '||'16:00:00', 'YYYY-MM-DD HH24:MI:SS'));
insert into o_order values (1, 'C100', to_timestamp(to_char(sysdate, 'YYYY-MM-DD')||' '||'17:00:00', 'YYYY-MM-DD HH24:MI:SS'));
insert into o_order values (1, 'C100', to_timestamp(to_char(sysdate, 'YYYY-MM-DD')||' '||'18:00:00', 'YYYY-MM-DD HH24:MI:SS'));
rollback;

select *
  from o_order;
```

