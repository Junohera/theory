# Rename datafile

## rename is 

- Ï£ºÎ°ú ÎîîÏä§ÌÅ¨Ïùò **Î¨ºÎ¶¨Ï†Å Ïù¥ÎèôÏù¥ ÌïÑÏöîÌï† Í≤ΩÏö∞** ÏÇ¨Ïö©
  (ÎîîÏä§ÌÅ¨Í∞Ä Î¨∏Ï†úÍ∞Ä ÏûàÍ±∞ÎÇò Ïö©ÎüâÏù¥ Î∂ÄÏ°±ÌïòÏó¨ Îã§Î•∏ ÎîîÏä§ÌÅ¨Î°ú Ïù¥ÎèôÌï¥ÏïºÌï† Í≤ΩÏö∞)
- datafile **onlineÏ§ë Î¨ºÎ¶¨Ï†Å Î≥µÏÇ¨ ÎòêÎäî Ïù¥Îèô Í∏àÏßÄ**
- tablespaceÎ•º `offline | shutdown` Ìïú ÌõÑ ÏûëÏóÖ ÌïÑÏöî
- offlineÏù¥ Î∂àÍ∞ÄÎä•Ìïú system, undo, temp Îì±ÏùÄ shutdown ÌõÑ Ï≤òÎ¶¨

| datafile Î¨ºÎ¶¨Ï†Å Ïù¥Îèô | online Í∞ÄÎä• Ïó¨Î∂Ä | Ï†àÏ∞®                                                         |
| -------------------- | ---------------- | ------------------------------------------------------------ |
| SYSTEM               | ‚ùå                | shutdown -> physical move -> startup mount -> logical move -> alter database open |
| SYSAUX               | ‚ùå                | shutdown -> physical move -> startup mount -> logical move -> alter database open |
| UNDOTBS1             | ‚ùå                | shutdown -> physical move -> startup mount -> logical move -> alter database open |
| USERS                | ‚úÖ                | tablespace offline -> physical move -> logical move -> tablespace online |
| `user define`        | ‚úÖ                | tablespace offline -> physical move -> logical move -> tablespace online |

## case

1. safety **move physical datafile** in user defined tablespace
2. safety **move physical datafile** in system tablespace
3. unsafety move physical datafile in user defined tablespace üëª

## case 1

> safety move physical datafile in user defined tablespace

class1 tablespaceÏùò Î™®Îì† datafileÏùÑ ÏïÑÎûò ÏúÑÏπòÎ°ú Ïù¥Îèô
(/home/oracle/oradata/db1)

1. tablespace offline

2. physical move 
3. logical move(=controlfile rename)
4. tablespace online

### flow

#### 1. tablespace Ï°∞Ìöå

```sql
select * from dba_tablespaces;
```

#### 2. datafile Ï°∞Ìöå

```sql
select * from dba_data_files;
```

#### 3. tablespace offline

```sql
alter tablespace class1 offline;
```

#### 4. tablespace Ï°∞Ìöå (onlineÏù¥ ÏïÑÎãòÏùÑ ÌôïÏù∏ -> offline)

```sql
select TABLESPACE_NAME, STATUS from dba_tablespaces;
```

#### 5. offlineÏãúÌÇ® tablespaceÏùò Î¨ºÎ¶¨Ï†ÅÏù∏ ÌååÏùºÎ™©Î°ù Ï°∞Ìöå

```sql
select * from dba_data_files where TABLESPACE_NAME = 'CLASS1';

/oracle12/app/oracle/oradata/db1/class1.dbf	5	CLASS1
/oracle12/app/oracle/oradata/db1/class2.dbf	6	CLASS1
/oracle12/app/oracle/oradata/db1/class1_03.dbf	7	CLASS1
/oracle12/app/oracle/oradata/db1/class1_02.dbf	8	CLASS1
/oracle12/app/oracle/oradata/db1/class1_01.dbf	9	CLASS1
```

#### 6. Î¨ºÎ¶¨Ï†Å Ïù¥Îèô(dbfÌååÏùº Ïù¥Îèô)

> Î¨ºÎ¶¨Ï†ÅÏù∏ Î≥ÄÍ≤ΩÏù¥ÎØÄÎ°ú Ïö©ÎüâÏóê Îî∞Îùº ÏãúÍ∞ÑÏù¥ Ï≤úÏ∞®ÎßåÎ≥Ñ

```shell
# mv Î≥¥Îã§ cp ÌõÑ, rmÏù¥ ÏïàÏ†ÑÌïú Ïù¥ÎèôÎ∞©Ïãù

# ASIS to TOBE Î≥µÏÇ¨
cd /oracle12/app/oracle/oradata/db1/
cp class1.dbf class2.dbf class1_01.dbf class1_02.dbf class1_03.dbf /home/oracle/oradata/db1/

# ASIS to TOBE Î≥µÏÇ¨ ÌôïÏù∏
cd /home/oracle/oradata/db1/
ll

# ASIS ÏÇ≠Ï†ú
cd /oracle12/app/oracle/oradata/db1/
rm class1.dbf class2.dbf class1_01.dbf class1_02.dbf class1_03.dbf
```

#### ÎÖºÎ¶¨Ï†Å Ïù¥Îèô(controlfile Ï†ïÎ≥¥ Î≥ÄÍ≤Ω)

> ÎÖºÎ¶¨Ï†ÅÏù∏ Î≥ÄÍ≤ΩÏù¥ÎØÄÎ°ú ÏãúÍ∞ÑÏÜåÏöî ÏóÜÏùå

```shell
class1.dbf class2.dbf class1_01.dbf class1_02.dbf class1_03.dbf: oracle12 -> home
alter database rename file '/oracle12/app/oracle/oradata/db1/class1.dbf'
											to '/home/oracle/oradata/db1/class1.dbf';
alter database rename file '/oracle12/app/oracle/oradata/db1/class2.dbf'
											to '/home/oracle/oradata/db1/class2.dbf';
alter database rename file '/oracle12/app/oracle/oradata/db1/class1_01.dbf'
											to '/home/oracle/oradata/db1/class1_01.dbf';
alter database rename file '/oracle12/app/oracle/oradata/db1/class1_02.dbf'
											to '/home/oracle/oradata/db1/class1_02.dbf';
alter database rename file '/oracle12/app/oracle/oradata/db1/class1_03.dbf'
											to '/home/oracle/oradata/db1/class1_03.dbf';											
```

#### 1. datafile Ï°∞Ìöå

```sql
select * from dba_data_files where tablespace_name = 'CLASS1';
```

#### 2. tablespace Ï°∞Ìöå

```sql
select TABLESPACE_NAME, STATUS from dba_tablespaces where TABLESPACE_NAME = 'CLASS1';
```

#### 3. tablespace online

```sql
alter tablespace class1 online;
```

#### 2. datafile:tablespace ÏãúÏ†êÏ†ïÎ≥¥ Ï°∞Ìöå

```sql
select a.file#, a.name, a.ts#, b.name, a.status, a.checkpoint_change#
  from v$datafile a, v$tablespace b
 where a.ts# = b.ts#;
```

#### 2. Ï≤¥ÌÅ¨Ìè¨Ïù∏Ìä∏ Î∞úÏÉù(`optional`)

> ÌòÑÏóÖÏóêÏÑúÎèÑ ÌïÑÏàòÏÇ¨Ìï≠ÏùÄ ÏïÑÎãò

```sql
alter system checkpoint;
```

## case 2

> safety move physical datafile in system tablespace

system tablespaceÏùò Î™®Îì† datafileÏùÑ ÏïÑÎûò ÏúÑÏπòÎ°ú Ïù¥Îèô
(/home/oracle/oradata/db1)

1. shutdown

2. physical move

3. startup mount

4. logical move(=controlfile rename)

5. open


### flow

#### 1. tablespace Ï°∞Ìöå

```sql
select * from dba_tablespaces where ALLOCATION_TYPE = 'SYSTEM';
```

#### 2. datafile Ï°∞Ìöå

```sql
select * from dba_data_files where TABLESPACE_NAME in (select TABLESPACE_NAME from dba_tablespaces where ALLOCATION_TYPE = 'SYSTEM');

/oracle12/app/oracle/oradata/db1/system01.dbf	1	SYSTEM
/oracle12/app/oracle/oradata/db1/sysaux01.dbf	2	SYSAUX
/oracle12/app/oracle/oradata/db1/undotbs01.dbf	3	UNDOTBS1
/oracle12/app/oracle/oradata/db1/users01.dbf	4	USERS
/oracle12/app/oracle/oradata/db1/undotbs02.dbf	10	UNDOTBS1
```

#### 3. shutdown

```sql
SQL> shutdown immediate;
SQL> select instance_name, status from v$instance;
```

#### 4. physical move

```shell
cd /oracle12/app/oracle/oradata/db1/
ll

cp system01.dbf sysaux01.dbf undotbs01.dbf users01.dbf undotbs02.dbf /home/oracle/oradata/db1

cd /home/oracle/oradata/db1
ll

cd /oracle12/app/oracle/oradata/db1/
rm system01.dbf sysaux01.dbf undotbs01.dbf users01.dbf undotbs02.dbf
ll
```

#### 5. startup mount

```sql
SQL> startup mount;
SQL> select instance_name, status from v$instance;
```

#### 6. logical move(=controlfile rename)

```sql
system01.dbf sysaux01.dbf undotbs01.dbf users01.dbf undotbs02.dbf: oracle12 -> home
alter database rename file '/oracle12/app/oracle/oradata/db1/system01.dbf'
											to '/home/oracle/oradata/db1/system01.dbf';
alter database rename file '/oracle12/app/oracle/oradata/db1/sysaux01.dbf'
											to '/home/oracle/oradata/db1/sysaux01.dbf';
alter database rename file '/oracle12/app/oracle/oradata/db1/undotbs01.dbf'
											to '/home/oracle/oradata/db1/undotbs01.dbf';
alter database rename file '/oracle12/app/oracle/oradata/db1/users01.dbf'
											to '/home/oracle/oradata/db1/users01.dbf';
alter database rename file '/oracle12/app/oracle/oradata/db1/undotbs02.dbf'
											to '/home/oracle/oradata/db1/undotbs02.dbf';
```

#### 7. open

```sql
SQL> alter database open;
```

#### 8. datafile Ï°∞Ìöå

```sql
select * from dba_data_files where TABLESPACE_NAME in (select TABLESPACE_NAME from dba_tablespaces where ALLOCATION_TYPE = 'SYSTEM');

/home/oracle/oradata/db1/system01.dbf	1	SYSTEM
/home/oracle/oradata/db1/sysaux01.dbf	2	SYSAUX
/home/oracle/oradata/db1/undotbs01.dbf	3	UNDOTBS1
/home/oracle/oradata/db1/users01.dbf	4	USERS
/home/oracle/oradata/db1/undotbs02.dbf	10	UNDOTBS1
```

## case 3

> unsafety move physical datafile in user defined tablespace

user defined tablespaceÏùò Î™®Îì† datafileÏùÑ onlineÏ§ëÏóê controlfile ÏàòÏ†ïÌïòÏßÄ ÏïäÍ≥†, physical move
(/oracle12/app/oracle/oradata/db1)

1. tail follow

2. select physical

3. move physical

4. try DML

5. select logfiles status

6. try log switch

7. occur shutdown(**Instance terminated by USER**)

8. startup mount

9. update logical

10. try open
    1. when SUCCESS: maybe auto instance recovery
    2. when FAILURE: need recovery (if archive mode then use mash up archive)


### flow

#### tail follow alert

```shell
tail -f alertdb1.log
```

#### select physical

```sql
select TABLESPACE_NAME, FILE_NAME from dba_data_files where tablespace_name = 'CLASS1';

CLASS1	/home/oracle/oradata/db1/class1.dbf
CLASS1	/home/oracle/oradata/db1/class2.dbf
CLASS1	/home/oracle/oradata/db1/class1_03.dbf
CLASS1	/home/oracle/oradata/db1/class1_02.dbf
CLASS1	/home/oracle/oradata/db1/class1_01.dbf
```

#### physical move in online tablespace

```shell
cd /home/oracle/oradata/db1/
ll

cp class1_01.dbf  class1_02.dbf  class1_03.dbf  class1.dbf  class2.dbf /oracle12/app/oracle/oradata/db1

cd /oracle12/app/oracle/oradata/db1
ll

cd /home/oracle/oradata/db1/
ll

rm class1_01.dbf  class1_02.dbf  class1_03.dbf  class1.dbf  class2.dbf
```

#### try DML

```sql
create table test2(a number) tablespace class1;
ORA-01116: 6 Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ ÌååÏùº Ïó¥Í∏∞Ïóê Ïò§Î•òÏûÖÎãàÎã§

insert into test1 values(1);
```

#### occur ERROR

```shell
2023-07-14T16:31:12.299546+09:00
Errors in file /oracle12/app/oracle/diag/rdbms/db1/db1/trace/db1_m000_604.trc:
ORA-01110: data file 5: '/home/oracle/oradata/db1/class1.dbf'
ORA-01565: error in identifying file '/home/oracle/oradata/db1/class1.dbf'
ORA-27037: unable to obtain file status
Linux-x86_64 Error: 2: No such file or directory
Additional information: 7
2023-07-14T16:31:12.370797+09:00
Errors in file /oracle12/app/oracle/diag/rdbms/db1/db1/trace/db1_m000_604.trc:
ORA-01110: data file 6: '/home/oracle/oradata/db1/class2.dbf'
ORA-01565: error in identifying file '/home/oracle/oradata/db1/class2.dbf'
ORA-27037: unable to obtain file status
Linux-x86_64 Error: 2: No such file or directory
Additional information: 7
2023-07-14T16:31:12.436980+09:00
Errors in file /oracle12/app/oracle/diag/rdbms/db1/db1/trace/db1_m000_604.trc:
ORA-01110: data file 7: '/home/oracle/oradata/db1/class1_03.dbf'
ORA-01565: error in identifying file '/home/oracle/oradata/db1/class1_03.dbf'
ORA-27037: unable to obtain file status
Linux-x86_64 Error: 2: No such file or directory
Additional information: 7
2023-07-14T16:31:12.502580+09:00
Errors in file /oracle12/app/oracle/diag/rdbms/db1/db1/trace/db1_m000_604.trc:
ORA-01110: data file 8: '/home/oracle/oradata/db1/class1_02.dbf'
ORA-01565: error in identifying file '/home/oracle/oradata/db1/class1_02.dbf'
ORA-27037: unable to obtain file status
Linux-x86_64 Error: 2: No such file or directory
Additional information: 7
2023-07-14T16:31:12.567447+09:00
Errors in file /oracle12/app/oracle/diag/rdbms/db1/db1/trace/db1_m000_604.trc:
ORA-01110: data file 9: '/home/oracle/oradata/db1/class1_01.dbf'
ORA-01565: error in identifying file '/home/oracle/oradata/db1/class1_01.dbf'
ORA-27037: unable to obtain file status
Linux-x86_64 Error: 2: No such file or directory
Additional information: 7
```

#### select logfiles status

```shell
select a.group#,
       a.member,
       b.bytes/1024/1024 MB,
       b.archived,
       b.status
from   v$logfile a,
       v$log b
where  a.group# = b.group#
order by 1, 2;
```

#### occur log switch for shutdown

> occur checkpoint not complete -> instance termination

```sql
alter system switch logfile; 

2023-07-14T16:32:09.267028+09:00
Thread 1 advanced to log sequence 48 (LGWR switch)
  Current log# 3 seq# 48 mem# 0: /oracle12/app/oracle/oradata/db1/redo03.log
  Current log# 3 seq# 48 mem# 1: /home/oracle/oradata/db1/redo03.log
Thread 1 cannot allocate new log, sequence 49
Checkpoint not complete
  Current log# 3 seq# 48 mem# 0: /oracle12/app/oracle/oradata/db1/redo03.log
  Current log# 3 seq# 48 mem# 1: /home/oracle/oradata/db1/redo03.log
2023-07-14T16:32:10.057984+09:00
Errors in file /oracle12/app/oracle/diag/rdbms/db1/db1/trace/db1_ckpt_32062.trc:
ORA-01242: data file suffered media failure: database in NOARCHIVELOG mode
ORA-01116: error in opening database file 5
ORA-01110: data file 5: '/home/oracle/oradata/db1/class1.dbf'
ORA-27041: unable to open file
Linux-x86_64 Error: 2: No such file or directory
Additional information: 3
2023-07-14T16:32:10.072329+09:00
Errors in file /oracle12/app/oracle/diag/rdbms/db1/db1/trace/db1_ckpt_32062.trc:
ORA-01242: data file suffered media failure: database in NOARCHIVELOG mode
ORA-01116: error in opening database file 5
ORA-01110: data file 5: '/home/oracle/oradata/db1/class1.dbf'
ORA-27041: unable to open file
Linux-x86_64 Error: 2: No such file or directory
Additional information: 3
Errors in file /oracle12/app/oracle/diag/rdbms/db1/db1/trace/db1_ckpt_32062.trc  (incident=124961):
ORA-1242 [] [] [] [] [] [] [] [] [] [] [] []
Incident details in: /oracle12/app/oracle/diag/rdbms/db1/db1/incident/incdir_124961/db1_ckpt_32062_i124961.trc
2023-07-14T16:32:10.736165+09:00
USER (ospid: 32062): terminating the instance due to error 1242
2023-07-14T16:32:10.820331+09:00
System state dump requested by (instance=1, osid=32062 (CKPT)), summary=[abnormal instance termination].
System State dumped to trace file /oracle12/app/oracle/diag/rdbms/db1/db1/trace/db1_diag_32041_20230714163210.trc
2023-07-14T16:32:11.373525+09:00
Dumping diagnostic data in directory=[cdmp_20230714163210], requested by (instance=1, osid=32062 (CKPT)), summary=[abnormal instance termination].
2023-07-14T16:32:12.487951+09:00
Instance terminated by USER, pid = 32062
```

#### startup mount

```sql
SQL> startup mount;
```

#### update logical(=controlfile rename)

```sql
SQL> alter database rename file '/home/oracle/oradata/db1/class1.dbf' to '/oracle12/app/oracle/oradata/db1/class1.dbf';
SQL> alter database rename file '/home/oracle/oradata/db1/class2.dbf' to '/oracle12/app/oracle/oradata/db1/class2.dbf';
SQL> alter database rename file '/home/oracle/oradata/db1/class1_01.dbf' to '/oracle12/app/oracle/oradata/db1/class1_01.dbf';
SQL> alter database rename file '/home/oracle/oradata/db1/class1_02.dbf' to '/oracle12/app/oracle/oradata/db1/class1_02.dbf';
SQL> alter database rename file '/home/oracle/oradata/db1/class1_03.dbf' to '/oracle12/app/oracle/oradata/db1/class1_03.dbf';
```

#### try open

```sql
SQL> alter database open;
```

#### after try open 

- [x] **result 1: open(success's reason is maybe auto instance recovery)**
  ÎßåÏïΩ ÎåÄÎüâÏùò dmlÏù¥ Î∞úÏÉùÌñàÎã§Î©¥ instance recoveryÍ∞Ä ÏßÑÌñâÎêòÎ©¥ÏÑú ÏãúÏ†êÏùÑ ÎßûÏ∂îÎäî ÏûëÏóÖÏù¥ ÏßÑÌñâÎêòÍ≥†, Ïù¥ Í≥ºÏ†ïÏù¥ Ïò§Îûò Í±∏Î¶¥ Ïàò ÏûàÏùå.

  ```sql
  SQL> select instance_name, status from v$instance;
  
  OPEN
  ```

- [ ] **result 2: need recovery (if archive mode then use mash up archive)**
  redologÎ•º Í∞ÄÏ†∏Ïò¨ Ïàò ÏóÜÎäî ÏÉÅÌô©Ïùº Í≤ΩÏö∞ Î≥µÍµ¨ Î∂àÍ∞Ä, ÎÇòÎ®∏ÏßÄ tablespaceÎùºÎèÑ ÏÇ¥Î¶¨Î†§Î©¥ Î¨∏Ï†úÍ∞Ä ÏûàÎäî tablespace|datafileÏùÑ offlineÏãúÌÇ§Í≥† open

 

