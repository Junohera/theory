# Rename datafile

## rename is 

- 주로 디스크의 **물리적 이동이 필요할 경우** 사용
  (디스크가 문제가 있거나 용량이 부족하여 다른 디스크로 이동해야할 경우)
- datafile **online중 물리적 복사 또는 이동 금지**
- tablespace를 `offline | shutdown` 한 후 작업 필요
- offline이 불가능한 system, undo, temp 등은 shutdown 후 처리

| datafile 물리적 이동 | online 가능 여부 | 절차                                                         |
| -------------------- | ---------------- | ------------------------------------------------------------ |
| SYSTEM               | ❌                | shutdown -> physical move -> startup mount -> logical move -> alter database open |
| SYSAUX               | ❌                | shutdown -> physical move -> startup mount -> logical move -> alter database open |
| UNDOTBS1             | ❌                | shutdown -> physical move -> startup mount -> logical move -> alter database open |
| USERS                | ✅                | tablespace offline -> physical move -> logical move -> tablespace online |
| `user define`        | ✅                | tablespace offline -> physical move -> logical move -> tablespace online |

## case

1. safety **move physical datafile** in user defined tablespace
2. safety **move physical datafile** in system tablespace
3. unsafety move physical datafile in user defined tablespace

## case 1

> safety move physical datafile in user defined tablespace

class1 tablespace의 모든 datafile을 아래 위치로 이동
(/home/oracle/oradata/db1)

1. tablespace offline

2. physical move 
3. logical move(=controlfile rename)
4. tablespace online

### flow

#### 1. datafile 조회

```sql
select * from dba_data_files;
```

#### 2. tablespace 조회

```sql
select * from dba_tablespaces;
```

#### 3. tablespace offline

```sql
alter tablespace class1 offline;
```

#### 4. tablespace 조회 (online이 아님을 확인 -> offline)

```sql
select * from dba_tablespaces;
```

#### 물리적 이동(dbf파일 이동)

> 물리적인 변경이므로 용량에 따라 시간이 천차만별

```shell
# mv 보다 cp 후, rm이 안전한 이동방식
cp /oracle12/app
rm
```

#### 논리적 이동(controlfile 정보 변경)

> 논리적인 변경이므로 시간소요 없음

```shell
class1_01.dbf: oracle12 -> home
class1_02.dbf: oracle12 -> home
alter database rename file ''
											to '';
```

#### 1. datafile 조회

```sql
select * from dba_data_files;
```

#### 2. tablespace 조회

```sql
select * from dba_tablespaces;
```

#### 3. tablespace online

```sql
alter tablespace class1 online;
```

#### 2. datafile:tablespace 시점정보 조회

```sql
select a.file#, a.name, a.ts#, b.name, a.status, a.checkpoint_change#
  from v$datafile a, v$tablespace b
 where a.ts# = b.ts#
   and b.name = 'CLASS1';
```

#### 2. 체크포인트 발생(`optional`)

> 현업에서도 필수사항은 아님

```sql
alter system checkpoint;
```

## case 2 TODO

> safety move physical datafile in system tablespace

system tablespace의 모든 datafile을 아래 위치로 이동
(/home/oracle/oradata/db1)

1. shutdown

2. physical move

3. startup mount

4. logical move(=controlfile rename)

5. open


### flow

#### 1. datafile 조회

```sql
select * from dba_data_files;
```

#### 2. tablespace 조회

```sql
select * from dba_tablespaces;
```

## case 3 TODO

> unsafety move physical datafile in user defined tablespace

### flow

#### tail follow alert

```shell
tail -f alertdb1.log
```

#### select physical

```sql
select * from dba_data_files;
```

#### physical move in online tablespace

```shell
mv /home/oracle/oradata/db1/class1_01.dbf /oracle12/app/oracle/oradata/db1
mv /home/oracle/oradata/db1/class1_02.dbf /oracle12/app/oracle/oradata/db1
```

#### try DML

```sql
create table test2(a number) tablespace class1;
insert into test1 values(1);
```

#### occur ERROR

```shell
```

#### select logfiles status

```shell
select a.group#,
       a.member,
       b.bytes/1024/1024 MB,
       b.archived,
       b.status
from   v$logfile a,
       v$log b
where  a.group# = b.group#
order by 1, 2;
```

#### occur log switch for shutdown

> occur checkpoint not complete -> instance termination

```sql
alter system switch logfile; 
```

#### startup mount

```sql
SQL> startup mount;
```

#### update logical(=controlfile rename)

```sql
SQL> alter database rename file '/home/oracle/oradata/db1/class1_01.dbf' to '/oracle12/app/oracle/oradata/db1/class1_01.dbf';
SQL> alter database rename file '/home/oracle/oradata/db1/class1_02.dbf' to '/oracle12/app/oracle/oradata/db1/class1_02.dbf';
```

#### try open

```sql
SQL> alter database open;
```

#### after try open 

- [x] **result 1: open(success's reason is maybe auto instance recovery)**
  만약 대량의 dml이 발생했다면 instance recovery가 진행되면서 시점을 맞추는 작업이 진행되고, 이 과정이 오래 걸릴 수 있음.

  ```sql
  SQL> select instance_name, status from v$instance;
  
  OPEN
  ```

- [ ] **result 2: need recovery (if archive mode then use mash up archive)**
  redolog를 가져올 수 없는 상황일 경우 복구 불가, 나머지 tablespace라도 살리려면 문제가 있는 tablespace|datafile을 offline시키고 open

 

