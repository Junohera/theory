# Remove Redo log File

## 시나리오

> 4번 그룹 제거

- [ ] tail follow alert log 
- [ ] pfile 백업
- [ ] spfile 기반 pfile 생성
- [ ] log file 확인
- [ ] 삭제 대상 그룹을 CURRENT 상태로 변경하기 위해 강제 로그 스위칭
- [ ] member 삭제 시도(4번 그룹의 두번째 멤버)
- [ ] 삭제 대상 그룹을 ACTIVE 상태로 변경하기 위해 강제 로그 스위칭
- [ ] member 삭제 재시도(4번 그룹의 두번째 멤버)
- [ ] group 삭제 시도(4번 그룹)
- [ ] 삭제 대상 그룹을 INACTIVE 상태로 변경하기 위해 체크포인트
- [ ] group 삭제 시도(4번 그룹)
- [ ] log file 확인
- [ ] 물리적인 삭제 확인

## 구현

- [ ] tail follow alert log

```shell
tail -f /oracle12/app/oracle/diag/rdbms/db1/db1/trace/alert_db1.log
```

- [ ] pfile 백업

```shell
cd ${ORACLE_HOME}/dbs
cp initdb1.ora initdb1.ora.back_$(date +"%Y-%m-%d_%H:%M:%S")
cp spfiledb1.ora spfiledb1.ora.back_$(date +"%Y-%m-%d_%H:%M:%S")
```

- [ ] spfile 기반 pfile 생성

```sql
create pfile from spfile;
```

- [ ] log file 확인

```sql
select a.group#,
       a.member,
       b.bytes/1024/1024 MB,
       b.archived,
       b.status
from   v$logfile a,
       v$log b
where  a.group# = b.group#
order by 1, 2;
```

- [ ] 삭제 대상 그룹을 CURRENT 상태로 변경하기 위해 강제 로그 스위칭

```sql
alter system switch logfile;
select a.group#,
       a.member,
       b.bytes/1024/1024 MB,
       b.archived,
       b.status
from   v$logfile a,
       v$log b
where  a.group# = b.group#
order by 1, 2;
... 반복
```

- [ ] member 삭제 시도(4번 그룹의 두번째 멤버)

> - current에서 삭제 시도: redo log 삭제 불가
>
> - active에서 삭제 시도:  redo log 삭제가 불가능하지만, 동기화가 모두 완료되는 경우 inactive 전환이 동시에 되면서 삭제 가능

```sql
alter database drop logfile member 
'/oracle12/app/oracle/oradata/db1/redo04_2.log';
```

> current상태일 때 drop 시도시 alert 내용
>
> TODO:

- [ ] 삭제 대상 그룹을 ACTIVE 상태로 변경하기 위해 강제 로그 스위칭

```sql
alter system switch logfile;
select a.group#,
       a.member,
       b.bytes/1024/1024 MB,
       b.archived,
       b.status
from   v$logfile a,
       v$log b
where  a.group# = b.group#
order by 1, 2;
... 반복
```

- [ ] member 삭제 재시도(4번 그룹의 두번째 멤버)

```sql
alter database drop logfile member 
'/oracle12/app/oracle/oradata/db1/redo04_2.log';
-- inactive 상태일 경우, redo log 삭제 가능
```

- [ ] group 삭제 시도(4번 그룹)

> ❌실패: active인 그룹 삭제 불가

```sql
alter database drop logfile group 4;
```

- [ ] 삭제 대상 그룹을 INACTIVE 상태로 변경하기 위해 체크포인트

```sql
alter system checkpoint;
select a.group#,
       a.member,
       b.bytes/1024/1024 MB,
       b.archived,
       b.status
from   v$logfile a,
       v$log b
where  a.group# = b.group#
order by 1, 2;
```

- [ ] group 삭제 시도(4번 그룹)

> ✅성공: INACTIVE 상태이므로

```sql
alter database drop logfile group 4;
```

- [ ] log file 확인

```sql
select a.group#,
       a.member,
       b.bytes/1024/1024 MB,
       b.archived,
       b.status
from   v$logfile a,
       v$log b
where  a.group# = b.group#
order by 1, 2;
```

- [ ] 물리적인 삭제 확인

> 물리적으로는 삭제되지 않음. 잔재만 남아있음

```shell
cd /oracle12/app/oracle/oradata/db1
ll
```









