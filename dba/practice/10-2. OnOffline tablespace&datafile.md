# Online Offline Test (tablespace, datafile)

## **ì‹¤ìŠµ**

### A. tablespace ë‹¨ìœ„

#### **1. tablespace offline ì‹œë„**

```sql
alter tablespace class1 offline;    -- ê°€ëŠ¥
alter tablespace users offline;     -- ê°€ëŠ¥
select * from scott.emp;            -- users tablespaceë‚´ì— ëª¨ë“  tableì— ëŒ€í•´ ì¡°íšŒ ë¶ˆê°€
```

#### **2. default tablespace offline ì‹œë„**

```sql
alter tablespace system offline;    -- ë¶ˆê°€ëŠ¥
alter tablespace sysaux offline;    -- ë¶ˆê°€ëŠ¥
alter tablespace temp offline;      -- ë¶ˆê°€ëŠ¥
alter tablespace undotbs1 offline;  -- ë¶ˆê°€ëŠ¥
```

#### **3. online ì‹œë„**

```sql
alter tablespace class1 online;     -- ê°€ëŠ¥
alter tablespace users online;      -- ê°€ëŠ¥
select * from scott.emp; -- ì¡°íšŒê°€ëŠ¥
```

#### **4. ì‹œì  ì •ë³´ í™•ì¸**

```sql
select a.file#, a.name, a.ts#, b.name, a.status, a.checkpoint_change# from v$datafile a, v$tablespace b where a.ts# = b.ts#;
```

> => íŠ¹ì • tablespaceë¥¼ offlineí–ˆë‹¤ê°€ onlineì‹œ ë‹¤ë¥¸ tablespace(datafile)ì™€ ì‹œì ì •ë³´ ë¶ˆì¼ì¹˜ ë°œìƒ

#### **5. checkpoint ê°•ì œ ë°œìƒ**

```sql
alter system checkpoint;
```

#### **6. ì‹œì  ì •ë³´ í™•ì¸**

```sql
select a.file#, a.name, a.ts#, b.name, a.status, a.checkpoint_change# from v$datafile a, v$tablespace b where a.ts# = b.ts#;
```

#### 7. ê²°ê³¼

> 1. tablespace offline
> 2. tablespace online
> 3. need recover
> 4. media recover
> 5. datafile online
> 6. global checkpoint
> 7. done. âœ¨

### B. datafile ë‹¨ìœ„

#### **1. class tablespaceì˜ class1_02.dbf offline ì‹œë„**

- [ ] when archive log mode

```sql
alter database datafile '/oracle12/app/oracle/oradata/db1/class1_02.dbf' offline;
```

- [x] when noarchive log mode

```sql
alter database datafile '/oracle12/app/oracle/oradata/db1/class1_02.dbf' offline drop;
```

#### **2. ì‹œì  ì •ë³´ í™•ì¸**

```sql
select a.file#, a.name, a.ts#, b.name, a.status, a.checkpoint_change# from v$datafile a, v$tablespace b where a.ts# = b.ts#;
```

#### **3. tail alert**

```shell
tail -f /oracle12/app/oracle/diag/rdbms/db1/db1/trace/alert_db1.log
```

#### **4. online ì‹œë„**

```sql
alter database datafile '/oracle12/app/oracle/oradata/db1/class1_02.dbf' online;
 
2023-07-13T16:14:18.000040+09:00
alter database datafile '/oracle12/app/oracle/oradata/db1/class1_02.dbf' online
ORA-1113 signalled during: alter database datafile '/oracle12/app/oracle/oradata/db1/class1_02.dbf' online...
2023-07-13T16:14:18.037746+09:00
Errors in file /oracle12/app/oracle/diag/rdbms/db1/db1/trace/db1_m000_32740.trc:
ORA-01110: data file 8: '/oracle12/app/oracle/oradata/db1/class1_02.dbf'

--ORA-01110: data file 6: '/oracle12/app/oracle/oradata/db1/class1_02.dbf'
--Checker run found 1 new persistent data failures
--=> recovery í•„ìš”
```

#### 5. ì‹œì  ì •ë³´ í™•ì¸

```sql
select a.file#, a.name, a.ts#, b.name, a.status, a.checkpoint_change# from v$datafile a, v$tablespace b where a.ts# = b.ts#;
 
      FILE# NAME                                                 TS# NAME       STATUS    CHECKPOINT_CHANGE#
---------- ---------------------------------------------------- --- ---------- --------- ------------------
         1 /oracle12/app/oracle/oradata/db1/system01.dbf          0 SYSTEM     SYSTEM                848135
         2 /oracle12/app/oracle/oradata/db1/sysaux01.dbf          1 SYSAUX     ONLINE                848135
         3 /oracle12/app/oracle/oradata/db1/undotbs01.dbf         2 UNDOTBS1   ONLINE                848135
         4 /oracle12/app/oracle/oradata/db1/users01.dbf           4 USERS      ONLINE                848135
         5 /oracle12/app/oracle/oradata/db1/class1.dbf            5 CLASS1     ONLINE                848135
         6 /oracle12/app/oracle/oradata/db1/class2.dbf            5 CLASS1     ONLINE                848135
         7 /oracle12/app/oracle/oradata/db1/class1_03.dbf         5 CLASS1     ONLINE                848135
         8 /oracle12/app/oracle/oradata/db1/class1_02.dbf         5 CLASS1     RECOVER               848135		-- recover ë°œìƒ ğŸ”¥
         9 /oracle12/app/oracle/oradata/db1/class1_01.dbf         5 CLASS1     ONLINE                848135
```

> status ì¤‘ `RECOVER`ì— ëŒ€í•´ MEDIA RECOVERY ìˆ˜í–‰ í•„ìš”

#### 6. recover 

```sql
SQL> recover datafile '/oracle12/app/oracle/oradata/db1/class1_02.dbf';
Media recovery complete.
```

#### **7. online ì‹œë„**

```sql
alter database datafile '/oracle12/app/oracle/oradata/db1/class1_02.dbf' online;
```

#### 8. ì‹œì  ì •ë³´ í™•ì¸

```sql
SQL> select a.file#, a.name, a.ts#, b.name, a.status, a.checkpoint_change# from v$datafile a, v$tablespace b where a.ts# = b.ts#;

     FILE# NAME                                           TS# NAME      STATUS CHECKPOINT_CHANGE#
---------- ---------------------------------------------- --- --------- ------ ------------------
         1 /oracle12/app/oracle/oradata/db1/system01.dbf    0 SYSTEM    SYSTEM             848135
         2 /oracle12/app/oracle/oradata/db1/sysaux01.dbf    1 SYSAUX    ONLINE             848135
         3 /oracle12/app/oracle/oradata/db1/undotbs01.dbf   2 UNDOTBS1  ONLINE             848135
         4 /oracle12/app/oracle/oradata/db1/users01.dbf     4 USERS     ONLINE             848135
         5 /oracle12/app/oracle/oradata/db1/class1.dbf      5 CLASS1    ONLINE             848135
         6 /oracle12/app/oracle/oradata/db1/class2.dbf      5 CLASS1    ONLINE             848135
         7 /oracle12/app/oracle/oradata/db1/class1_03.dbf   5 CLASS1    ONLINE             848135
         8 /oracle12/app/oracle/oradata/db1/class1_02.dbf   5 CLASS1    ONLINE             848562		-- recover í•´ê²°ë˜ì–´ onlineìœ¼ë¡œ ìƒíƒœë³€ê²½âœ…, ë‹¨ ë²„ì „ ìƒì´
         9 /oracle12/app/oracle/oradata/db1/class1_01.dbf   5 CLASS1    ONLINE             848135
```

#### **9. checkpoint ê°•ì œ ë°œìƒ**

```sql
alter system checkpoint;
```

#### **6. ì‹œì  ì •ë³´ í™•ì¸**

```sql
SQL> select a.file#, a.name, a.ts#, b.name, a.status, a.checkpoint_change# from v$datafile a, v$tablespace b where a.ts# = b.ts#;

     FILE# NAME                                            TS# NAME      STATUS  CHECKPOINT_CHANGE#
---------- ----------------------------------------------- --- --------- ------- ------------------
         1 /oracle12/app/oracle/oradata/db1/system01.dbf     0 SYSTEM    SYSTEM              848788
         2 /oracle12/app/oracle/oradata/db1/sysaux01.dbf     1 SYSAUX    ONLINE              848788
         3 /oracle12/app/oracle/oradata/db1/undotbs01.dbf    2 UNDOTBS1  ONLINE              848788
         4 /oracle12/app/oracle/oradata/db1/users01.dbf      4 USERS     ONLINE              848788
         5 /oracle12/app/oracle/oradata/db1/class1.dbf       5 CLASS1    ONLINE              848788
         6 /oracle12/app/oracle/oradata/db1/class2.dbf       5 CLASS1    ONLINE              848788
         7 /oracle12/app/oracle/oradata/db1/class1_03.dbf    5 CLASS1    ONLINE              848788
         8 /oracle12/app/oracle/oradata/db1/class1_02.dbf    5 CLASS1    ONLINE              848788
         9 /oracle12/app/oracle/oradata/db1/class1_01.dbf    5 CLASS1    ONLINE              848788
```

#### 7. ê²°ê³¼

> 1. datafile offline
> 2. datafile online
> 3. need recover
> 4. media recover
> 5. datafile online
> 6. global checkpoint
> 7. done. âœ¨

**ğŸ˜±offlineì€ tablespace ë‹¨ìœ„ë¡œ í•˜ì**