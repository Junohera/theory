# Recovery Test 1

```shell
. ~/.bash_profile

echo "ë³µêµ¬ ì‘ì—…ì„ ìœ„í•œ ì „ì²´ ë°±ì—… ìˆ˜í–‰ì¤‘..."
find /oracle12/backup -name "control*.ctl" -type f  -exec rm -f {} \; 2>/dev/null
find /oracle12/backup -name "*.dbf" -type f  -exec rm -f {} \; 2>/dev/null
find /oracle12/backup -name "redo*" -type f  -exec rm -f {} \; 2>/dev/null
find /oracle12/backup -name "con*sql" -type f  -exec rm -f {} \; 2>/dev/null
find /home -name "control*.ctl" -type f  -exec rm -f {} \; 2>/dev/null
find /home -name "*.dbf" -type f  -exec rm -f {} \; 2>/dev/null
find /home -name "redo*" -type f  -exec rm -f {} \; 2>/dev/null
find /home -name "con*sql" -type f  -exec rm -f {} \; 2>/dev/null

sqlplus -s /nolog << _EOF_ > /dev/null
conn / as sysdba
set head off
set lines 10000
set pages 10000
set feedback off
set echo off
set term off

spool /oracle12/abc.sh

select 'mkdir -p /oracle12/backup/'||to_char(sysdate,'yyyymmdd') from dual
union all
select 'cp '||name||' /oracle12/backup/'||to_char(sysdate,'yyyymmdd')||'/'||substr(name,instr(name,'/',-1,1)+1) as "copy ddl"
  from v\$datafile
 union all
select 'cp '||name||' /oracle12/backup/'||to_char(sysdate,'yyyymmdd')||'/'||substr(name,instr(name,'/',-1,1)+1) as "copy ddl"
  from v\$controlfile
 union all  
select 'cp '||member||' /oracle12/backup/'||to_char(sysdate,'yyyymmdd')||'/'||substr(member,instr(member,'/',-1,1)+1) as "copy ddl"
  from v\$logfile
/

spool off

spool /oracle12/abcc.sh

!mkdir -p /oracle12/datapump

select 'tar -cvf /oracle12/datapump/backup_hong.tar '||substr(file_name,1,instr(file_name,'/',-1,1)-1)||'/*'
 from dba_data_files
where tablespace_name ='SYSTEM'
/

spool off

shutdown immediate
_EOF_

sh -x /oracle12/abc.sh
sh -x /oracle12/abcc.sh

echo "í…ŒìŠ¤íŠ¸ í™˜ê²½ êµ¬ì„± ì¤‘..."

sqlplus -s /nolog << _EOF_ > /dev/null
conn / as sysdba
set head off
set lines 10000
set pages 10000
set feedback off
set echo off
set term off

startup

alter system switch logfile
/
alter system switch logfile
/
alter system switch logfile
/
alter system switch logfile
/
alter system switch logfile
/
alter system switch logfile
/

# itwill_ts í…Œì´ë¸” ìŠ¤í˜ì´ìŠ¤ ìƒì„± ì „ ë°ì´í„° íŒŒì¼ ì‚­ì œ
spool /oracle12/datafile_rm.sql

select '!rm ' || file_name
 from dba_data_files
where tablespace_name ='ITWILL_TS'
/

spool off

@/oracle12/datafile_rm.sql

# test tablespace ìƒì„±
select 'create tablespace itwill_ts datafile '''||substr(file_name,1,instr(file_name,'/',-1,1)-1)||'/itwill.dbf'''|| ' size 50m;'
 from dba_data_files
where tablespace_name ='SYSTEM'
/

spool off



spool /oracle12/abcd.sql

select 'create tablespace itwill_ts datafile '''||substr(file_name,1,instr(file_name,'/',-1,1)-1)||'/itwill.dbf'''|| ' size 50m;'
 from dba_data_files
where tablespace_name ='SYSTEM'
/

spool off

@/oracle12/abcd.sql

alter user scott quota unlimited on itwill_ts
/

create table scott.itwill_test1(a varchar2(20)) tablespace itwill_ts
/

insert into scott.itwill_test1 values('a')
/
commit
/

alter system switch logfile
/
alter system switch logfile
/
alter system switch logfile
/
alter system switch logfile
/

insert into scott.itwill_test1 values('b')
/
commit
/

alter system switch logfile
/
alter system switch logfile
/
alter system switch logfile
/
alter system switch logfile
/

spool /oracle12/abcde.sql

select '! rm -f ' ||file_name
  from dba_data_files
 where tablespace_name like 'itwill%'
union all
select '! rm -f ' ||name
  from v\$controlfile
/

spool off

@/oracle12/abcde.sql

insert into scott.itwill_test1 values('recover success')
/
commit
/

shutdown abort

_EOF_

rm -f /oracle12/abc*

echo "ì¥ì•  ìƒí™© ë°œìƒ : DB shutdown ìƒí™©!!"
echo 'ë³µêµ¬ ì™„ë£Œ í›„ scott.itwill_test1 í…Œì´ë¸”ì„ ì¡°íšŒí•˜ì—¬ë¼(ì´3ê±´)'
```



### í•´ë‹¹ ì¼€ì´ìŠ¤ íŒë‹¨ ì ˆì°¨

> ìƒí™©ì— ë”°ë¼ ì‹œë„ë¥¼ ë¨¼ì €í•´ì•¼í•  ìˆ˜ë„ ìˆì§€ë§Œ, ìš°ì„  íŒë‹¨

1. db shutdownì´ë¯€ë¡œ ì¥ì• ê°ì§€
2. tail -f alert
3. startup open ì‹œë„

ğŸ’¥controlfile not found

4. controlfile ë¬¸ì œ ê°ì§€

```shell
pfileíŒŒì¼ì„ í†µí•´ controlfile ìœ„ì¹˜ í™•ì¸
ë‹¨, show parameter pfileì„ í†µí•´ pfileí™˜ê²½ì¸ì§€ spfileí™˜ê²½ì¸ì§€ ì²´í¬

parameteríŒŒì¼ ì‹œê°„ì°¨ì´ í™•ì¸
pfile vs spfile ì‹œê°„ì°¨ì´ í™•ì¸í•˜ì—¬ ì˜¤ë˜ë˜ì—ˆë‹¤ë©´ ë¯¿ì§€ë§ê³  ë§Œë“¤ì
create pfile from spfile;ì„ í†µí•´ pfileë¡œ ìƒì„±

init${ORACLE_SID}.oraë¥¼ vië¥¼ í†µí•´ ì—´ì–´ë³¸ í›„ controlfile ìœ„ì¹˜ í™•ì¸
vi ${ORACLE_HOME}/dbs/initdb1.ora

controlfile ì¡´ì¬ í™•ì¸
```

5. controlfile ë¬¸ì œì— ë”°ë¥¸ íŒë‹¨âœ…

   > backup controlfile ìŠ¤í¬ë¦½íŠ¸ì™€ controlfile ì¤‘, ìµœì‹ ì„ ì„ íƒí•˜ëŠ”ê²ƒë„ ë°©ë²•

   a. backup controlfileì´ ìµœì‹ ì¼ ê²½ìš°, ì¬ìƒì„±
   b. backup controlfileì´ ì˜¤ë˜ë˜ì—ˆê±°ë‚˜ ì—†ì„ ê²½ìš° old controlfileì„ ë¦¬ì»¤ë²„ë¦¬

6. controlfile ì„ ë³µêµ¬í•˜ì—¬ ì˜¤í”ˆ ì‹œë„

```shell
cp controlfile.ctl ${pfileì—ì„œ ë°”ë¼ë³´ëŠ” ìœ„ì¹˜}

startup mount
alter database open;
ì‹œì  ë¶ˆì¼ì¹˜ë¡œ ì—ëŸ¬ ë°œìƒğŸ’¥
```

7. ë³µêµ¬ë°©ì‹ íŒë‹¨âœ…
   `complete recovery`: archiveëª¨ë“œì´ë©´ì„œ redoì™€ archive log fileì´ ì •ìƒìœ¼ë¡œ íŒë‹¨ëœë‹¤ë©´ ìš°ì„  **ì™„ì „ë³µêµ¬**ë¥¼ ì§„í–‰í•´ë³¸ë‹¤.
   `incomplete recovery`: archiveëª¨ë“œê°€ ì•„ë‹ˆê±°ë‚˜ redo ë˜ëŠ” archive log fileì´ ë¹„ì •ìƒìœ¼ë¡œ íŒë‹¨ëœë‹¤ë©´ ì–´ì©” ìˆ˜ ì—†ì´ **ë¶ˆì™„ì „ë³µêµ¬**ë¥¼ ì§„í–‰í•´ì•¼í•œë‹¤.

```shell
í˜„ì¬ ìƒí™©ì—ì„œëŠ” redoê°€ ì•ˆì „í•œ ìƒíƒœì´ë¯€ë¡œ, instance recoveryë¥¼ í†µí•´ ë°ì´í„° ìœ ì‹¤ì„ ìµœì†Œí™”í•´ì•¼í•˜ë¯€ë¡œ
ë¨¼ì € ì™„ì „ë³µêµ¬ ì‹œë„

main session)
recover database using backup controlfile;

another session)
cd ${ARCHIVE_LOG_FILE_DESTINATION}
ls -rtl

âœ¨recoverì‹œ íŠ¹ì • ì‹œí€€ìŠ¤ì— ëŒ€ì‘í•˜ëŠ” archive log fileì´ ì—†ì„ ê²½ìš°,
ì •í™©ìƒ archiveì— ë–¨ì–´ì§€ì§€ ëª»í•˜ê³ , currentìƒíƒœì˜ redo logì— ë‚¨ì•„ìˆì„ ìˆ˜ë„ ìˆìœ¼ë‹ˆ
ë¡œê·¸íŒŒì¼ì„ ë‹¤ìŒê³¼ ê°™ì´ ì¡°íšŒí•´ë³¸ë‹¤.

@log_checkì‹œë„
  G MEMBER                                                MB seq# STATUS   ARC
--- -------------------------------------------------- ----- ---- -------- ---
  1 /oracle12/app/oracle/oradata/db1/redo01.log          200   46 INACTIVE YES
  1 /oracle12/app/oracle/oradata/db1/redo01_2.log        200   46 INACTIVE YES
  2 /oracle12/app/oracle/oradata/db1/redo02.log          200   47 CURRENT  NO
  2 /oracle12/app/oracle/oradata/db1/redo02_2.log        200   47 CURRENT  NO
  3 /oracle12/app/oracle/oradata/db1/redo03.log          200   45 INACTIVE YES
  3 /oracle12/app/oracle/oradata/db1/redo03_2.log        200   45 INACTIVE YES

ì™„ì „ë³µêµ¬ ì¬ì‹œë„
recover database using backup controlfile;
archive log fileì„ suggestioní•˜ì§€ë§Œ ìœ„ì—ì„œ ì¡°íšŒí•œ âœ¨currentì¸ redofileì„ ëŒ€ì‹  ì…ë ¥âœ¨
/oracle12/app/oracle/oradata/db1/redo02.logâœ…


open ì‹œë„
alter database open

unnamedë°œìƒì‹œğŸ’¥
recoverë¥¼ í•˜ë©´ì„œ archivelogfile ë˜ëŠ” logfileì„ datafileì— ì ìš©í•  ë•Œ
ë¬¼ë¦¬ì ìœ¼ë¡œ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” datafileì¼ ê²½ìš°,
ğŸ’Š(logical) controlfileì´ ì„ì‹œ ë°ì´í„°íŒŒì¼ì„ ë§Œë“¤ì–´ì¤Œ.(ê·¼ë° ë¬¼ë¦¬ì ìœ¼ë¡œëŠ” ë§Œë“¤ì–´ì£¼ì§€ ì•Šê³ , ë…¼ë¦¬ì ìœ¼ë¡œë§Œ ì¡´ì¬í•¨)ğŸ‘»
=> select name from v$datafile where name like '%UNNAMED%';

ğŸ’Š(physical by logical) ë¹ˆíŒŒì¼ì„ ë¬¼ë¦¬ì ìœ¼ë¡œ ë§Œë“¤ì–´ì£¼ì!!
+ AëŠ” ë°˜ë“œì‹œ CONTROLFILEì´ ì•Œê³ ìˆëŠ” ì´ë¦„ì´ì–´ì•¼í•˜ì§€ë§Œ, BëŠ” ë¬¼ë¦¬ì ìœ¼ë¡œ ë³€ê²½í•  ê²½ë¡œì´ë©´ë¨.
=> alter database create datafile '${A}' as '${B}';
=> alter database create datafile '${GENERATED_UNNAED_NAME}' as '${LOST_PATH}';

ì™„ì „ë³µêµ¬ ì¬ì‹œë„
archive log fileë“¤ê³¼ redo log fileë“¤ì„ ì „ë¶€ ì¡°íšŒí•˜ì—¬ seqì™€ changeê°’ì— ëŒ€ì‘í•˜ëŠ” íŒŒì¼ì„ í•˜ë‚˜ì”© ì ìš©
=> @arch_check, @log_check

ìœ„ì—ì„œì˜ ì™„ì „ë³µêµ¬ ì‹œë„í•˜ë˜ ë•Œì™€ ë‹¬ë¦¬
ë¬¼ë¦¬ì ì¸ íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•Šì•„ archivelogfile ë˜ëŠ” redologfileì„ ì ìš©í•˜ë˜ ë„ì¤‘ì— ë°œìƒí–ˆë˜ ì—ëŸ¬ê°€ ë°œìƒí•˜ì§€ ì•ŠìŒ.

Media recovery complete.âœ¨

open ì‹œë„
alter database open resetlogs;

=> ë°±ì—…ë³¸ì´ ì—†ë”ë¼ë„, ë¹ˆë°ì´í„°íŒŒì¼ì„ ìƒì„±í•´ì„œ archive||redoë„ ì ìš©í•˜ë©´ì„œ ë³µêµ¬í•  ìˆ˜ ìˆë‹¤.
```

